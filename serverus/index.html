<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Clientes | PSC Cargas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="config.js"></script>
  <style>
    body { background: #f7f8fa; }
    .card { border-radius: 14px; }
    .btn-primary { background:#0d6efd; }
    .table thead th { white-space: nowrap; }
    .modal-content { border-radius: 14px; }
    table thead th:last-child,
    table tbody td:last-child { white-space: nowrap; width: 1%; }
    table tbody td:last-child .btn { white-space: nowrap; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h3 m-0">Clientes</h1>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCliente" id="btnNuevo">Crear cliente</button>
    </div>

    <!-- Filtros -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Desde</label>
          <input id="fltDesde" type="date" class="form-control" />
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Hasta</label>
          <input id="fltHasta" type="date" class="form-control" />
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Sucursal</label>
          <select id="fltSucursal" class="form-select">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="col-sm-6 col-md-2">
          <label class="form-label">Source</label>
          <select id="fltSource" class="form-select">
            <option value="">Todos</option>
            <option value="staff">staff</option>
            <option value="web">web</option>
            <option value="app">app</option>
          </select>
        </div>
        <div class="col-sm-6 col-md-1">
          <label class="form-label">Box</label>
          <input id="fltBox" type="number" min="1" class="form-control" />
        </div>
      </div>

      <div class="row g-2 align-items-end mt-1">
        <div class="col-sm-6 col-md-4">
          <label class="form-label">Buscar</label>
          <input id="q" type="search" class="form-control" placeholder="Nombre, email, teléfono o dirección..." />
        </div>
        <div class="col-auto">
          <button id="btnBuscar" type="button" class="btn btn-outline-primary">Buscar</button>
          <button id="btnLimpiar" type="button" class="btn btn-outline-secondary">Limpiar</button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card p-0">
      <div class="table-responsive">
        <table class="table table-hover m-0">
          <thead class="table-light">
            <tr>
              <th>Fecha</th>
              <th>Nombre</th>
              <th>Box</th>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Sucursal</th>
              <th>Source</th>
              <th>Dirección</th>
              <th>Tarifa 1</th>
              <th>Tarifa 2</th>
              <th>Tarifa 3</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Crear/Editar Cliente -->
  <div class="modal fade" id="modalCliente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <form id="formCliente">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Crear cliente</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="nombre" class="form-label">Nombre</label>
                <input id="nombre" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input id="email" type="email" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="telefono" class="form-label">Teléfono</label>
                <input id="telefono" class="form-control" />
              </div>
              <div class="col-md-6">
                <label for="fecha_nac" class="form-label">Fecha de nacimiento</label>
                <input id="fecha_nac" type="date" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="tarifa1" class="form-label">Tarifa 1</label>
                <input id="tarifa1" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="tarifa2" class="form-label">Tarifa 2</label>
                <input id="tarifa2" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="tarifa3" class="form-label">Tarifa 3</label>
                <input id="tarifa3" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-12">
                <label for="direccion" class="form-label">Dirección</label>
                <textarea id="direccion" class="form-control" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label for="sucursal" class="form-label">Sucursal</label>
                <select id="sucursal" class="form-select" required>
                  <option value="">Cargando...</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="btnGuardar" type="submit" class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Supabase + lógica -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const sb = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

    const $  = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => [...p.querySelectorAll(s)];
    const norm      = s => (s||"").trim();
    const normEmail = s => (s||"").trim().toLowerCase();
    const toNum = (s) => {
      const n = Number(String(s||"").replace(",", "."));
      return Number.isFinite(n) ? n : null;
    };
    const escapeHtml = (s) =>
      String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    function fmtNum(n){ if(n==null) return ""; try {return Number(n).toFixed(2);} catch { return String(n);} }
    function fmtDate(iso){
      if(!iso) return "";
      try {
        const d = new Date(iso);
        return d.toLocaleDateString("es-ES", { day:"2-digit", month:"2-digit", year:"2-digit" });
      } catch { return iso; }
    }

    const tableBody   = document.querySelector("table tbody");
    const inputQ      = $('#q');
    const btnBuscar   = $('#btnBuscar');
    const btnLimpiar  = $('#btnLimpiar');
    const fltDesde    = $('#fltDesde');
    const fltHasta    = $('#fltHasta');
    const fltSucursal = $('#fltSucursal');
    const fltSource   = $('#fltSource');
    const fltBox      = $('#fltBox');
    const fldSucursal = $('#sucursal');
    const form        = $('#formCliente');
    const modalTitle  = $('#modalTitle');
    const modal       = new bootstrap.Modal($('#modalCliente'));

    // Sucursales
    async function cargarSucursales() {
      fldSucursal.innerHTML = "<option value=''>Cargando...</option>";
      fltSucursal.innerHTML = "<option value=''>Todas</option>";
      const { data, error } = await sb.from("sucursales").select("id,sucursal").order("sucursal");
      if (error) return;
      fldSucursal.innerHTML = "<option value=''>Seleccione sucursal</option>";
      for (const row of (data||[])) {
        const opt1 = document.createElement("option");
        opt1.value = row.sucursal; // nombre en vez de id
        opt1.textContent = row.sucursal;
        fldSucursal.appendChild(opt1);
        const opt2 = document.createElement("option");
        opt2.value = row.sucursal;
        opt2.textContent = row.sucursal;
        fltSucursal.appendChild(opt2);
      }
    }

    function renderEmpty(msg="No hay clientes.") {
      tableBody.innerHTML = `<tr><td colspan="12" class="text-center p-4 text-muted">${msg}</td></tr>`;
    }

    function renderRows(rows){
      if (!rows.length) return renderEmpty();
      tableBody.innerHTML = rows.map(r => `
        <tr>
          <td>${fmtDate(r.created_at)}</td>
          <td>${escapeHtml(r.nombre || "")}</td>
          <td>${r.box ?? ""}</td>
          <td>${escapeHtml(r.email || "")}</td>
          <td>${escapeHtml(r.telefono || "")}</td>
          <td>${escapeHtml(r.sucursal || "")}</td>
          <td>${escapeHtml(r.source || "")}</td>
          <td>${escapeHtml(r.direccion || "")}</td>
          <td>${fmtNum(r.tarifa_1)}</td>
          <td>${fmtNum(r.tarifa_2)}</td>
          <td>${fmtNum(r.tarifa_3)}</td>
          <td>...</td>
        </tr>
      `).join("");
    }

    async function cargarClientes(q="") {
      let query = sb.from("clientes")
        .select("id,created_at,box,nombre,email,telefono,sucursal,source,direccion,tarifa_1,tarifa_2,tarifa_3")
        .order("created_at",{ascending:false})
        .limit(200);

      if (fltDesde.value) query = query.gte("created_at", `${fltDesde.value}T00:00:00Z`);
      if (fltHasta.value) query = query.lte("created_at", `${fltHasta.value}T23:59:59Z`);
      if (fltSucursal.value) query = query.eq("sucursal", fltSucursal.value);
      if (fltSource.value) query = query.eq("source", fltSource.value);
      if (fltBox.value) query = query.eq("box", Number(fltBox.value));

      q = q.trim();
      if (q) {
        const like = `%${q}%`;
        query = query.or([
          `nombre.ilike.${like}`,
          `email.ilike.${like}`,
          `telefono.ilike.${like}`,
          `direccion.ilike.${like}`
        ].join(','));
      }

      const { data, error } = await query;
      if (error) { console.error(error); return renderEmpty("Error cargando."); }
      renderRows(data||[]);
    }

    document.addEventListener("DOMContentLoaded", async ()=>{
      btnBuscar.addEventListener("click", ()=>cargarClientes(inputQ.value));
      btnLimpiar.addEventListener("click", ()=>{
        fltDesde.value="";fltHasta.value="";fltSucursal.value="";fltSource.value="";fltBox.value="";inputQ.value="";
        cargarClientes();
      });
      [fltDesde,fltHasta,fltSucursal,fltSource,fltBox].forEach(el=>{
        el.addEventListener("change",()=>cargarClientes(inputQ.value));
      });
      await cargarSucursales();
      await cargarClientes();
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>


