<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Clientes | PSC Cargas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="config.js"></script>
  <style>
    body { background: #f7f8fa; }
    .card { border-radius: 14px; }
    .btn-primary { background:#0d6efd; }
    .table thead th { white-space: nowrap; }
    .modal-content { border-radius: 14px; }
    table thead th:last-child,
    table tbody td:last-child { white-space: nowrap; width: 1%; }
    table tbody td:last-child .btn { white-space: nowrap; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h3 m-0">Clientes</h1>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCliente" id="btnNuevo">Crear cliente</button>
    </div>

    <!-- Filtros -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Desde</label>
          <input id="fltDesde" type="date" class="form-control" />
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Hasta</label>
          <input id="fltHasta" type="date" class="form-control" />
        </div>
        <div class="col-sm-6 col-md-3">
          <label class="form-label">Sucursal</label>
          <select id="fltSucursal" class="form-select">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="col-sm-6 col-md-2">
          <label class="form-label">Source</label>
          <select id="fltSource" class="form-select">
            <option value="">Todos</option>
            <option value="staff">staff</option>
            <option value="web">web</option>
            <option value="app">app</option>
          </select>
        </div>
        <div class="col-sm-6 col-md-1">
          <label class="form-label">Box</label>
          <input id="fltBox" type="number" min="1" class="form-control" />
        </div>
      </div>

      <div class="row g-2 align-items-end mt-1">
        <div class="col-sm-6 col-md-4">
          <label class="form-label">Buscar</label>
          <input id="q" type="search" class="form-control" placeholder="Nombre, email, teléfono o dirección..." />
        </div>
        <div class="col-auto">
          <button id="btnBuscar" type="button" class="btn btn-outline-primary">Buscar</button>
          <button id="btnLimpiar" type="button" class="btn btn-outline-secondary">Limpiar</button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card p-0">
      <div class="table-responsive">
        <table class="table table-hover m-0">
          <thead class="table-light">
            <tr>
              <th>Fecha</th>
              <th>Nombre</th>
              <th>Box</th>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Sucursal</th>
              <th>Source</th>
              <th>Dirección</th>
              <th>Tarifa 1</th>
              <th>Tarifa 2</th>
              <th>Tarifa 3</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Crear/Editar Cliente -->
  <div class="modal fade" id="modalCliente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <form id="formCliente">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Crear cliente</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="nombre" class="form-label">Nombre</label>
                <input id="nombre" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input id="email" type="email" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="telefono" class="form-label">Teléfono</label>
                <input id="telefono" class="form-control" />
              </div>
              <div class="col-md-6">
                <label for="fecha_nac" class="form-label">Fecha de nacimiento</label>
                <input id="fecha_nac" type="date" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="tarifa1" class="form-label">Tarifa 1</label>
                <input id="tarifa1" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="tarifa2" class="form-label">Tarifa 2</label>
                <input id="tarifa2" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="tarifa3" class="form-label">Tarifa 3</label>
                <input id="tarifa3" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-12">
                <label for="direccion" class="form-label">Dirección</label>
                <textarea id="direccion" class="form-control" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label for="sucursal" class="form-label">Sucursal</label>
                <select id="sucursal" class="form-select" required>
                  <option value="">Cargando...</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="btnGuardar" type="submit" class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Supabase + lógica -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ===== Config =====
    const sb = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

    // ===== Utils =====
    const $  = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => [...p.querySelectorAll(s)];
    const norm      = s => (s||"").trim();
    const normEmail = s => (s||"").trim().toLowerCase();
    const toNum = (s) => {
      const n = Number(String(s||"").replace(",", "."));
      return Number.isFinite(n) ? n : null;
    };
    const escapeHtml = (s) =>
      String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    const fmtNum = (n) => (n==null ? "" : (Number(n).toFixed(2)));
    function fmtDate(iso){
      if(!iso) return "";
      try {
        const d = new Date(iso);
        // DD/MM/YY
        return d.toLocaleDateString("es-PA", { day:"2-digit", month:"2-digit", year:"2-digit" });
      } catch { return iso; }
    }

    // ===== Refs DOM =====
    const tableBody   = document.querySelector("table tbody");
    const inputQ      = $('#q');
    const btnBuscar   = $('#btnBuscar');
    const btnLimpiar  = $('#btnLimpiar');
    const fltDesde    = $('#fltDesde');
    const fltHasta    = $('#fltHasta');
    const fltSucursal = $('#fltSucursal');
    const fltSource   = $('#fltSource');
    const fltBox      = $('#fltBox');

    const modalEl     = document.getElementById('modalCliente');
    const modal       = new bootstrap.Modal(modalEl);
    const form        = document.getElementById('formCliente');
    const modalTitle  = document.getElementById('modalTitle');
    const fldNombre   = document.getElementById('nombre');
    const fldEmail    = document.getElementById('email');
    const fldTel      = document.getElementById('telefono');
    const fldFecha    = document.getElementById('fecha_nac');
    const fldTar1     = document.getElementById('tarifa1');
    const fldTar2     = document.getElementById('tarifa2');
    const fldTar3     = document.getElementById('tarifa3');
    const fldDir      = document.getElementById('direccion');
    const fldSucursal = document.getElementById('sucursal');

    let editingId = null;

    // ===== Sucursales (nombre) =====
    async function cargarSucursales() {
      fldSucursal.innerHTML = "<option value=''>Cargando...</option>";
      fltSucursal.innerHTML = "<option value=''>Todas</option>";
      const { data, error } = await sb.from("sucursales").select("sucursal").order("sucursal");
      if (error) {
        console.error(error);
        fldSucursal.innerHTML = "<option value=''>Error</option>";
        return;
      }
      fldSucursal.innerHTML = "<option value=''>Seleccione sucursal</option>";
      for (const row of (data || [])) {
        const name = row.sucursal;
        const opt1 = document.createElement("option");
        opt1.value = name;
        opt1.textContent = name;
        fldSucursal.appendChild(opt1);

        const opt2 = document.createElement("option");
        opt2.value = name;
        opt2.textContent = name;
        fltSucursal.appendChild(opt2);
      }
    }

    // ===== Render =====
    function renderEmpty(msg="No hay clientes.") {
      tableBody.innerHTML = `<tr><td colspan="12" class="text-center p-4 text-muted">${msg}</td></tr>`;
    }

    function renderRows(rows){
      if (!rows.length) return renderEmpty();
      tableBody.innerHTML = rows.map(r => `
        <tr>
          <td>${fmtDate(r.created_at)}</td>
          <td>${escapeHtml(r.nombre || "")}</td>
          <td>${r.box ?? ""}</td>
          <td>${escapeHtml(r.email || "")}</td>
          <td>${escapeHtml(r.telefono || "")}</td>
          <td>${escapeHtml(r.sucursal || "")}</td>
          <td>${escapeHtml(r.source || "")}</td>
          <td>${escapeHtml(r.direccion || "")}</td>
          <td>${fmtNum(r.tarifa_1)}</td>
          <td>${fmtNum(r.tarifa_2)}</td>
          <td>${fmtNum(r.tarifa_3)}</td>
          <td>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-primary" data-edit="${r.id}">Editar</button>
              <button class="btn btn-sm btn-danger"  data-del="${r.id}">Eliminar</button>
            </div>
          </td>
        </tr>
      `).join("");

      $$("button[data-edit]").forEach(b => b.addEventListener("click", () => abrirEditar(b.dataset.edit)));
      $$("button[data-del]").forEach(b => b.addEventListener("click", () => eliminar(b.dataset.del)));
    }

    // ===== Listar/Buscar con filtros =====
    async function cargarClientes(q = "") {
      const cols = "id,created_at,box,nombre,email,telefono,sucursal,source,direccion,tarifa_1,tarifa_2,tarifa_3";
      let query = sb.from("clientes").select(cols, { count: "exact" }).order("created_at",{ascending:false}).limit(200);

      // filtros
      const d = fltDesde.value ? `${fltDesde.value}T00:00:00Z` : null;
      const h = fltHasta.value ? `${fltHasta.value}T23:59:59Z` : null;
      if (d) query = query.gte("created_at", d);
      if (h) query = query.lte("created_at", h);
      if (fltSucursal.value) query = query.eq("sucursal", fltSucursal.value);
      if (fltSource.value)   query = query.eq("source", fltSource.value);
      if (fltBox.value)      query = query.eq("box", Number(fltBox.value));

      // búsqueda específica
      q = (q || "").trim();
      if (q) {
        const like = `%${q}%`;
        query = query.or([
          `nombre.ilike.${like}`,
          `email.ilike.${like}`,
          `telefono.ilike.${like}`,
          `direccion.ilike.${like}`
        ].join(','));
      }

      const { data, error } = await query;
      if (error) { console.error(error); return renderEmpty("Error cargando."); }
      if ((!data || data.length === 0) && !q) return renderEmpty("No hay clientes con esos filtros.");
      renderRows(data || []);
    }

    // ===== Crear / Editar / Eliminar =====
    function resetModal(){
      editingId = null;
      modalTitle.textContent = "Crear cliente";
      form.reset();
      fldSucursal.value = "";
    }

    async function abrirEditar(id){
      const { data, error } = await sb.from("clientes")
        .select("id,created_at,box,nombre,email,telefono,fecha_nac,direccion,sucursal,source,tarifa_1,tarifa_2,tarifa_3")
        .eq("id", id).single();

      if (error) { console.error(error); return alert("No se pudo cargar el cliente."); }

      editingId = id;
      modalTitle.textContent = `Editar cliente (Box ${data.box ?? "-"})`;
      fldNombre.value = data.nombre || "";
      fldEmail.value  = data.email || "";
      fldTel.value    = data.telefono || "";
      fldFecha.value  = data.fecha_nac || "";
      fldTar1.value   = data.tarifa_1 ?? "";
      fldTar2.value   = data.tarifa_2 ?? "";
      fldTar3.value   = data.tarifa_3 ?? "";
      fldDir.value    = data.direccion || "";
      fldSucursal.value = data.sucursal || "";
      modal.show();
    }

    async function correoExiste(email, excluirId=null){
      // email normalizado en minúscula
      const em = (email||"").toLowerCase().trim();
      if (!em) return false;
      let q = sb.from("clientes").select("id").eq("email", em).limit(1);
      if (excluirId) q = q.neq("id", excluirId);
      const { data, error } = await q.maybeSingle();
      if (error && error.code !== "PGRST116") { console.error(error); }
      return !!(data && data.id);
    }

    form?.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const payload = {
        nombre:    norm(fldNombre.value),
        email:     normEmail(fldEmail.value),
        telefono:  norm(fldTel.value) || null,
        fecha_nac: fldFecha.value || null,
        tarifa_1:  toNum(fldTar1.value),
        tarifa_2:  toNum(fldTar2.value),
        tarifa_3:  toNum(fldTar3.value),
        direccion: norm(fldDir.value) || null,
        // sucursal por nombre
        sucursal:  fldSucursal.value || null,
        source:    "staff"
      };

      if (!payload.nombre || !payload.email || !payload.sucursal) {
        return alert("Nombre, Email y Sucursal son obligatorios.");
      }

      // 🔒 Bloqueo de duplicado en front
      const dup = await correoExiste(payload.email, editingId);
      if (dup) {
        return alert("Este email ya está registrado. No se puede duplicar.");
      }

      let err;
      if (editingId) {
        const { error } = await sb.from("clientes").update(payload, { returning: "minimal" }).eq("id", editingId);
        err = error;
      } else {
        const { error } = await sb.from("clientes").insert(payload, { returning: "minimal" });
        err = error;
      }

      if (err) {
        console.error(err);
        if (err.code === "23505") alert("Este email ya está registrado (único).");
        else alert(err.message || "Error al guardar");
        return;
      }

      modal.hide();
      await cargarClientes(document.getElementById('q').value);
      alert("Guardado ✅");
    });

    async function eliminar(id){
      if (!confirm("¿Eliminar este cliente? Esta acción no se puede deshacer.")) return;
      const { error } = await sb.from("clientes").delete().eq("id", id);
      if (error) { console.error(error); return alert(error.message || "No se pudo eliminar"); }
      await cargarClientes(document.getElementById('q').value);
      alert("Eliminado 🗑️");
    }

    // ===== Eventos =====
    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById('btnNuevo')?.addEventListener('click', resetModal);

      btnBuscar.addEventListener("click", ()=>cargarClientes(inputQ.value));
      btnLimpiar.addEventListener("click", ()=>{
        fltDesde.value="";fltHasta.value="";fltSucursal.value="";fltSource.value="";fltBox.value="";inputQ.value="";
        cargarClientes();
      });
      [fltDesde,fltHasta,fltSucursal,fltSource,fltBox].forEach(el=>{
        el.addEventListener("change",()=>cargarClientes(inputQ.value));
      });

      await cargarSucursales();
      await cargarClientes(); // lista todo al cargar
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>



