<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Clientes | PSC Cargas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Config con URL y ANON KEY -->
  <script src="config.js"></script>
  <style>
    body { background: #f7f8fa; }
    .card { border-radius: 14px; }
    .btn-primary { background:#0d6efd; }
    .table thead th { white-space: nowrap; }
    .modal-content { border-radius: 14px; }
    .hidden { display:none !important; }
    /* Evita que "Acciones" se corte */
    table thead th:last-child,
    table tbody td:last-child { white-space: nowrap; width: 1%; }
    table tbody td:last-child .btn { white-space: nowrap; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h1 class="h3 m-0">Clientes</h1>
      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalCliente" id="btnNuevo">Crear cliente</button>
    </div>

    <!-- Buscador -->
    <div class="card p-3 mb-3">
      <div class="row g-2 align-items-end">
        <div class="col-sm-6 col-md-4">
          <label class="form-label">Buscar</label>
          <input id="q" type="search" class="form-control" placeholder="Nombre, email o sucursal..." />
        </div>
        <div class="col-auto">
          <button id="btnBuscar" class="btn btn-outline-primary">Buscar</button>
        </div>
      </div>
    </div>

    <!-- Tabla -->
    <div class="card p-0">
      <div class="table-responsive">
        <table class="table table-hover m-0">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>Box</th>
              <th>Email</th>
              <th>Teléfono</th>
              <th>Sucursal</th>
              <th>Dirección</th>
              <th>Tarifa 1</th>
              <th>Tarifa 2</th>
              <th>Tarifa 3</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <!-- Vacío al cargar: se llena al presionar Buscar -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal Crear/Editar Cliente -->
  <div class="modal fade" id="modalCliente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <form id="formCliente">
          <div class="modal-header">
            <h5 class="modal-title" id="modalTitle">Crear cliente</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="nombre" class="form-label">Nombre</label>
                <input id="nombre" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="email" class="form-label">Email</label>
                <input id="email" type="email" class="form-control" required />
              </div>
              <div class="col-md-6">
                <label for="telefono" class="form-label">Teléfono</label>
                <input id="telefono" class="form-control" />
              </div>
              <div class="col-md-6">
                <label for="fecha_nac" class="form-label">Fecha de nacimiento</label>
                <input id="fecha_nac" type="date" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="tarifa1" class="form-label">Tarifa 1</label>
                <input id="tarifa1" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="tarifa2" class="form-label">Tarifa 2</label>
                <input id="tarifa2" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-md-4">
                <label for="tarifa3" class="form-label">Tarifa 3</label>
                <input id="tarifa3" type="number" step="0.01" class="form-control" />
              </div>
              <div class="col-12">
                <label for="direccion" class="form-label">Dirección</label>
                <textarea id="direccion" class="form-control" rows="2"></textarea>
              </div>
              <div class="col-md-6">
                <label for="sucursal" class="form-label">Sucursal</label>
                <select id="sucursal" class="form-select" required>
                  <option value="">Cargando...</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button id="btnGuardar" type="submit" class="btn btn-primary">Guardar</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Supabase + lógica -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ===== Config =====
    const sb = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);
    window.sb = sb; 

    // ===== Utils =====
    const $  = (s, p=document) => p.querySelector(s);
    const $$ = (s, p=document) => [...p.querySelectorAll(s)];
    const norm      = s => (s||"").trim();
    const normEmail = s => (s||"").trim().toLowerCase();
    const toNum = (s) => {
      const n = Number(String(s||"").replace(",", "."));
      return Number.isFinite(n) ? n : null;
    };
    const escapeHtml = (s) =>
      String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));

    // ===== Refs DOM =====
    const tableBody   = document.querySelector("table tbody");
    const inputQ      = $('#q');
    const btnBuscar   = $('#btnBuscar');
    const btnNuevo    = $('#btnNuevo');

    // Modal + campos
    const modalEl     = $('#modalCliente');
    const modal       = new bootstrap.Modal(modalEl);
    const form        = $('#formCliente');
    const modalTitle  = $('#modalTitle');
    const fldNombre   = $('#nombre');
    const fldEmail    = $('#email');
    const fldTel      = $('#telefono');
    const fldFecha    = $('#fecha_nac');
    const fldTar1     = $('#tarifa1');
    const fldTar2     = $('#tarifa2');
    const fldTar3     = $('#tarifa3');
    const fldDir      = $('#direccion');
    const fldSucursal = $('#sucursal');

    let editingId = null; // null => crear; uuid => editar

    // ===== Sucursales =====
    async function cargarSucursales() {
      fldSucursal.innerHTML = "<option value=''>Cargando...</option>";
      const { data, error } = await sb
        .from("sucursales")
        .select("id,sucursal")
        .order("sucursal", { ascending: true });

      if (error) {
        console.error(error);
        fldSucursal.innerHTML = "<option value=''>Error al cargar</option>";
        alert("No se pudieron cargar las sucursales.");
        return;
      }
      fldSucursal.innerHTML = "<option value=''>Seleccione sucursal</option>";
      for (const row of (data || [])) {
        const opt = document.createElement("option");
        opt.value = row.id;             // UUID
        opt.textContent = row.sucursal; // texto
        fldSucursal.appendChild(opt);
      }
    }

    // ===== Listado / Búsqueda (vacío hasta buscar) =====
    function fmtNum(n){ if(n==null) return ""; try {return Number(n).toFixed(2);} catch { return String(n);} }

    function renderEmpty(msg="Use el buscador para listar clientes.") {
      tableBody.innerHTML = `<tr><td colspan="10" class="text-center p-4 text-muted">${msg}</td></tr>`;
    }
    renderEmpty(); // vacío al cargar

    function renderRows(rows){
      if (!rows.length) return renderEmpty("No hay resultados para la búsqueda.");
      tableBody.innerHTML = rows.map(r => `
        <tr>
          <td>${escapeHtml(r.nombre || "")}</td>
          <td>${r.box ?? ""}</td>
          <td>${escapeHtml(r.email || "")}</td>
          <td>${escapeHtml(r.telefono || "")}</td>
          <td>${escapeHtml(r.sucursal || "")}</td>
          <td>${escapeHtml(r.direccion || "")}</td>
          <td>${fmtNum(r.tarifa_1)}</td>
          <td>${fmtNum(r.tarifa_2)}</td>
          <td>${fmtNum(r.tarifa_3)}</td>
          <td>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-primary" data-edit="${r.id}">Editar</button>
              <button class="btn btn-sm btn-danger"  data-del="${r.id}">Eliminar</button>
            </div>
          </td>
        </tr>
      `).join("");

      $$("button[data-edit]").forEach(b => b.addEventListener("click", () => abrirEditar(b.dataset.edit)));
      $$("button[data-del]").forEach(b => b.addEventListener("click", () => eliminar(b.dataset.del)));
    }

    async function cargarClientes(q=""){
  q = (q || "").trim();
  if (!q) return renderEmpty(); // vacío hasta buscar

  const like = `%${q}%`;
  const num  = Number(q);
  const isInt = Number.isInteger(num);

  // columnas que pintamos siempre
  const cols = "id, box, nombre, email, telefono, sucursal, direccion, tarifa_1, tarifa_2, tarifa_3";

  // 5 búsquedas en paralelo (nombre, email, tel, sucursal, dirección)
  const queries = [
    sb.from("clientes").select(cols).ilike("nombre", like).limit(100),
    sb.from("clientes").select(cols).ilike("email", like).limit(100),
    sb.from("clientes").select(cols).ilike("telefono", like).limit(100),
    sb.from("clientes").select(cols).ilike("sucursal", like).limit(100),
    sb.from("clientes").select(cols).ilike("direccion", like).limit(100),
  ];

  // si es entero, también buscamos por box exacto
  if (isInt) {
    queries.push(sb.from("clientes").select(cols).eq("box", num).limit(100));
  }

  // Ejecuta en paralelo
  const results = await Promise.all(queries.map(p => p));

  // Si alguna trae error “duro”, muestra el primero
  const hardErr = results.find(r => r.error);
  if (hardErr?.error) {
    console.error(hardErr.error);
    return renderEmpty("Error al cargar clientes.");
  }

  // Une y deduplica por id
  const map = new Map();
  for (const r of results) {
    for (const row of (r.data || [])) {
      map.set(row.id, row);
    }
  }

  const rows = Array.from(map.values())
    // orden aproximado por created_at no disponible aquí; si lo necesitas, añade created_at a 'cols'
    .slice(0, 100);

  if (!rows.length) return renderEmpty("No hay resultados para la búsqueda.");
  renderRows(rows);
}

window.cargarClientes = cargarClientes;

    // ===== Crear / Editar =====
    function resetModal(){
      editingId = null;
      modalTitle.textContent = "Crear cliente";
      form.reset();
      fldSucursal.value = "";
    }
    btnNuevo?.addEventListener("click", resetModal);

    async function abrirEditar(id){
      const { data, error } = await sb
        .from("clientes")
        .select("id, box, nombre, email, telefono, fecha_nac, direccion, sucursal, sucursal_id, tarifa_1, tarifa_2, tarifa_3")
        .eq("id", id)
        .single();

      if (error) {
        console.error(error);
        return alert("No se pudo cargar el cliente.");
      }

      editingId = id;
      modalTitle.textContent = `Editar cliente (Box ${data.box ?? "-"})`;
      fldNombre.value = data.nombre || "";
      fldEmail.value  = data.email || "";
      fldTel.value    = data.telefono || "";
      fldFecha.value  = data.fecha_nac || "";
      fldTar1.value   = data.tarifa_1 ?? "";
      fldTar2.value   = data.tarifa_2 ?? "";
      fldTar3.value   = data.tarifa_3 ?? "";
      fldDir.value    = data.direccion || "";

      // Selección de sucursal
      if (data.sucursal_id) {
        fldSucursal.value = data.sucursal_id;
      } else {
        const opt = [...fldSucursal.options].find(o => o.textContent === data.sucursal);
        if (opt) fldSucursal.value = opt.value;
      }

      modal.show();
    }

    form?.addEventListener("submit", async (ev) => {
      ev.preventDefault();
      const payload = {
        nombre:    norm(fldNombre.value),
        email:     normEmail(fldEmail.value),
        telefono:  norm(fldTel.value) || null,
        fecha_nac: fldFecha.value || null,
        tarifa_1:  toNum(fldTar1.value),
        tarifa_2:  toNum(fldTar2.value),
        tarifa_3:  toNum(fldTar3.value),
        direccion: norm(fldDir.value) || null,
        sucursal_id: fldSucursal.value || null,
        sucursal: fldSucursal.selectedOptions[0]?.textContent || null,
        source: "staff"
      };

      if (!payload.nombre || !payload.email || !payload.sucursal_id) {
        return alert("Nombre, Email y Sucursal son obligatorios.");
      }

      let err;
      if (editingId) {
        const { error } = await sb.from("clientes")
          .update(payload, { returning: "minimal" })
          .eq("id", editingId);
        err = error;
      } else {
        const { error } = await sb.from("clientes")
          .insert(payload, { returning: "minimal" });
        err = error;
      }

      if (err) {
        console.error(err);
        if (err.code === "23505") alert("Este email ya está registrado.");
        else alert(err.message || "Error al guardar");
        return;
      }

      modal.hide();
      // Si hay un término de búsqueda activo, refresca la lista; si no, deja vacío.
      const q = inputQ.value || "";
      if (q.trim()) await cargarClientes(q);
      else renderEmpty();
      alert("Guardado ✅");
    });

    // ===== Eliminar =====
    async function eliminar(id){
      if (!confirm("¿Eliminar este cliente? Esta acción no se puede deshacer.")) return;
      const { error } = await sb.from("clientes").delete().eq("id", id);
      if (error) {
        console.error(error);
        return alert(error.message || "No se pudo eliminar");
      }
      const q = inputQ.value || "";
      if (q.trim()) await cargarClientes(q);
      else renderEmpty();
      alert("Eliminado 🗑️");
    }

    // ===== Eventos de búsqueda =====
    btnBuscar?.addEventListener("click", () => cargarClientes(inputQ.value));
    inputQ?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        cargarClientes(inputQ.value);
      }
    });

    // ===== Init: solo carga sucursales; clientes queda vacío hasta buscar =====
    document.addEventListener("DOMContentLoaded", async () => {
      await cargarSucursales();
      renderEmpty();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

