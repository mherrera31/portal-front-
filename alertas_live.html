<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Alertas Live ‚Äî PSC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üö®</text></svg>" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
      :root {
        --bg: #111827; --fg: #f3f4f6; --card: #1f2937; --border: #374151;
        --red-bg: #450a0a; --red-border: #7f1d1d; --red-text: #fecaca;
        --yellow-bg: #422006; --yellow-border: #713f12; --yellow-text: #fde68a;
        --blue-btn: #2563eb; --blue-hover: #1d4ed8;
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; }
      
      .container { max-width: 1200px; margin: 0 auto; }
      
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
      .title { font-size: 24px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px; }
      .live-indicator { font-size: 12px; background: #059669; color: white; padding: 2px 8px; border-radius: 12px; animation: pulse 2s infinite; }
      
      @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

      .controls { display: flex; gap: 15px; align-items: center; }
      select { background: var(--card); color: white; border: 1px solid var(--border); padding: 10px; border-radius: 8px; outline: none; min-width: 200px; }
      .btn-refresh { background: #2563eb; border: none; color: white; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
      .btn-refresh:hover { background: #1d4ed8; }

      .alerts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
      @media (max-width: 800px) { .alerts-grid { grid-template-columns: 1fr; } }

      .alert-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 100%; min-height: 400px; }
      .card-header { padding: 15px; font-weight: 700; font-size: 18px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.2); }
      
      .type-danger .card-header { background: var(--red-bg); color: var(--red-text); border-bottom-color: var(--red-border); }
      .type-warning .card-header { background: var(--yellow-bg); color: var(--yellow-text); border-bottom-color: var(--yellow-border); }

      .card-body { padding: 0; flex: 1; overflow-y: auto; max-height: 600px; }
      
      table { width: 100%; border-collapse: collapse; }
      th { text-align: left; padding: 10px 15px; font-size: 12px; color: #9ca3af; background: rgba(0,0,0,0.2); position: sticky; top: 0; z-index: 10; }
      td { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; }
      tr:last-child td { border-bottom: none; }
      
      /* Badges y Botones */
      .days-badge { font-weight: bold; padding: 3px 8px; border-radius: 4px; font-size: 11px; display: inline-block; }
      .bg-red { background: rgba(220, 38, 38, 0.2); color: #fca5a5; }
      .bg-yellow { background: rgba(202, 138, 4, 0.2); color: #fde047; }
      .bg-green { background: rgba(5, 150, 105, 0.2); color: #6ee7b7; } 

      .btn-action { 
          background: var(--blue-btn); color: white; border: none; 
          padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; 
          cursor: pointer; display: flex; align-items: center; gap: 5px; 
          transition: background 0.2s;
      }
      .btn-action:hover { background: var(--blue-hover); }

      .empty-state { padding: 40px; text-align: center; color: #6b7280; font-style: italic; }
      .loading { padding: 20px; text-align: center; color: #9ca3af; }
      .small-text { font-size: 11px; color: #6b7280; display: block; margin-top: 2px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 class="title">
            <span>üö® Monitor de Riesgos</span>
            <span class="live-indicator">‚óè LIVE</span>
        </h1>
        
        <div class="controls">
            <select id="filterSucursal" onchange="loadAlerts()">
                <option value="Todas">Cargando sucursales...</option>
            </select>
            <button class="btn-refresh" onclick="loadAlerts()">
                <i data-lucide="refresh-cw" style="width: 16px;"></i> Actualizar
            </button>
        </div>
    </div>

    <div class="alerts-grid">
        
        <div class="alert-card type-danger">
            <div class="card-header">
                <span>üõë Sin Info (>5 d√≠as)</span>
                <span id="count-danger" style="font-size: 14px; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px;">0</span>
            </div>
            <div class="card-body" id="body-danger">
                <div class="loading">Cargando...</div>
            </div>
        </div>

        <div class="alert-card type-warning">
            <div class="card-header">
                <span>‚ö†Ô∏è Gesti√≥n de ML (Activos)</span>
                <span id="count-warning" style="font-size: 14px; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px;">0</span>
            </div>
            <div class="card-body" id="body-warning">
                <div class="loading">Cargando...</div>
            </div>
        </div>

    </div>
</div>

<script>
    if (typeof window.PSC_CONFIG === 'undefined') alert("Error: Falta config.js");
    const supabase = window.supabase.createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);
    lucide.createIcons();

    async function init() {
        await loadBranches();
        loadAlerts();
        setInterval(loadAlerts, 60000); // Auto-refresh 1 min
    }
    init();

    async function loadBranches() {
        const { data } = await supabase.from('sucursales').select('sucursal').order('sucursal', { ascending: true });
        const select = document.getElementById('filterSucursal');
        if (data) {
            select.innerHTML = '<option value="Todas">Todas las Sucursales</option>';
            data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.sucursal; opt.textContent = s.sucursal;
                select.appendChild(opt);
            });
        }
    }

    async function loadAlerts() {
        const sucursal = document.getElementById('filterSucursal').value;
        const bodyDanger = document.getElementById('body-danger');
        const bodyWarning = document.getElementById('body-warning');
        
        bodyDanger.innerHTML = '<div class="loading">Buscando...</div>';
        bodyWarning.innerHTML = '<div class="loading">Analizando...</div>';

        const today = new Date();
        const limit5Days = new Date(); 
        limit5Days.setDate(today.getDate() - 5); // --- CAMBIO: 5 D√çAS ---

        // --- 1. ZOMBIES (Sin Info > 5 D√≠as CREACI√ìN) ---
        let qDanger = supabase
            .from('seguimiento_interno')
            .select('*')
            .lt('created_at', limit5Days.toISOString())
            .in('estado_alerta', ['Pendiente', 'No Info']); 

        if (sucursal !== 'Todas') qDanger = qDanger.eq('sucursal', sucursal);
        
        const { data: dataDanger } = await qDanger;
        renderDangerTable(bodyDanger, dataDanger || []);
        document.getElementById('count-danger').textContent = dataDanger?.length || 0;

        // --- 2. GESTI√ìN ML (TODOS) ---
        let qWarning = supabase
            .from('seguimiento_interno')
            .select('*')
            .eq('estado_alerta', 'ML');

        if (sucursal !== 'Todas') qWarning = qWarning.eq('sucursal', sucursal);

        const { data: dataWarning } = await qWarning;
        
        if (dataWarning) {
            dataWarning.sort((a, b) => {
                const getScore = (item) => {
                    if (!item.fecha_solicitud) return 2; 
                    const dias = (new Date() - new Date(item.fecha_solicitud)) / 864e5;
                    if (dias >= 3) return 1; 
                    return 3; 
                };
                return getScore(a) - getScore(b);
            });
        }

        renderMLTable(bodyWarning, dataWarning || []);
        
        const actionCount = (dataWarning || []).filter(p => {
            if (!p.fecha_solicitud) return true; 
            const dias = (new Date() - new Date(p.fecha_solicitud)) / 864e5;
            return dias >= 3; 
        }).length;
        document.getElementById('count-warning').textContent = actionCount;
        
        lucide.createIcons();
    }

    // --- RENDER ZOMBIES (Rojos) ---
    function renderDangerTable(container, data) {
        if (data.length === 0) {
            container.innerHTML = `<div class="empty-state">Todo limpio.</div>`;
            return;
        }
        const rows = data.map(p => {
            const fecha = new Date(p.created_at);
            const dias = Math.floor((new Date() - fecha) / (1000 * 60 * 60 * 24));
            
            // Calculamos el retraso restando los 5 d√≠as de gracia
            const retraso = dias - 5;
            const textoRetraso = retraso > 0 ? `(+${retraso}d retraso)` : '';

            return `
                <tr>
                    <td>
                        <div style="font-weight:bold; color: white;">${p.tracking}</div>
                        <div style="font-size:12px; color:#9ca3af;">${p.cliente_nombre}</div>
                    </td>
                    <td style="text-align:right;">
                        <span class="days-badge bg-red">${dias} d√≠as total</span>
                        <div class="small-text" style="color:#fca5a5; font-weight:bold;">${textoRetraso}</div>
                        <div class="small-text">Registrado: ${fecha.toLocaleDateString()}</div>
                    </td>
                </tr>`;
        }).join('');
        container.innerHTML = `<table><thead><tr><th>Tracking</th><th style="text-align:right;">Antig√ºedad</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    // --- RENDER ML (Gesti√≥n Completa) ---
    function renderMLTable(container, data) {
        if (data.length === 0) {
            container.innerHTML = `<div class="empty-state">Sin paquetes en ML.</div>`;
            return;
        }

        const rows = data.map(p => {
            let accionHTML = '';
            
            if (!p.fecha_solicitud) {
                accionHTML = `
                    <button class="btn-action" onclick="marcarSolicitado('${p.id}')">
                        <i data-lucide="mail" width="14"></i> Solicitar
                    </button>`;
            } else {
                const fechaSol = new Date(p.fecha_solicitud);
                const diasPasados = Math.floor((new Date() - fechaSol) / (1000 * 60 * 60 * 24));
                
                if (diasPasados >= 3) {
                    accionHTML = `
                        <span class="days-badge bg-red">‚ö†Ô∏è Vencido (${diasPasados}d)</span>
                        <div class="small-text">Solicitado: ${fechaSol.toLocaleDateString()}</div>
                    `;
                } else {
                    accionHTML = `
                        <span class="days-badge bg-green">‚è≥ Esperando (${diasPasados}d)</span>
                        <div class="small-text">Solicitado: ${fechaSol.toLocaleDateString()}</div>
                    `;
                }
            }

            return `
                <tr>
                    <td>
                        <div style="font-weight:bold; color: white;">${p.tracking}</div>
                        <div style="font-size:12px; color:#9ca3af;">${p.cliente_nombre} (${p.cliente_box})</div>
                    </td>
                    <td style="text-align:right;">
                        <div style="display:flex; justify-content:flex-end;">${accionHTML}</div>
                    </td>
                </tr>`;
        }).join('');

        container.innerHTML = `<table><thead><tr><th>Tracking / Cliente</th><th style="text-align:right;">Gesti√≥n</th></tr></thead><tbody>${rows}</tbody></table>`;
        lucide.createIcons();
    }

    // --- FUNCI√ìN MARCAR SOLICITADO ---
    window.marcarSolicitado = async (id) => {
        if (!confirm("¬øConfirmas que has solicitado la informaci√≥n al cliente?")) return;

        const { error } = await supabase
            .from('seguimiento_interno')
            .update({ fecha_solicitud: new Date().toISOString() })
            .eq('id', id);

        if (error) {
            alert("Error al actualizar: " + error.message);
        } else {
            loadAlerts();
        }
    };

</script>

</body>
</html>
