<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Monitor Live 3 Niveles</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üö®</text></svg>" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
      :root {
        --bg: #111827; --fg: #f3f4f6; --card: #1f2937; --border: #374151;
        --red-bg: #450a0a; --red-border: #7f1d1d; --red-text: #fecaca;
        --yellow-bg: #422006; --yellow-border: #713f12; --yellow-text: #fde68a;
        --green-bg: #14532d; --green-border: #166534; --green-text: #bbf7d0;
        --blue-btn: #2563eb; --blue-hover: #1d4ed8;
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; }
      
      .container { max-width: 1400px; margin: 0 auto; }
      
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
      .title { font-size: 24px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px; }
      .live-indicator { font-size: 12px; background: #059669; color: white; padding: 2px 8px; border-radius: 12px; animation: pulse 2s infinite; }
      
      @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

      .controls { display: flex; gap: 15px; align-items: center; }
      select { background: var(--card); color: white; border: 1px solid var(--border); padding: 10px; border-radius: 8px; outline: none; min-width: 200px; }
      .btn-refresh { background: #2563eb; border: none; color: white; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
      .btn-refresh:hover { background: #1d4ed8; }

      /* GRID DE 3 COLUMNAS */
      .alerts-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; height: calc(100vh - 120px); }
      @media (max-width: 1000px) { .alerts-grid { grid-template-columns: 1fr; height: auto; } }

      .alert-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 100%; min-height: 400px; }
      .card-header { padding: 15px; font-weight: 700; font-size: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: 0.5px; }
      
      /* COLORES DE COLUMNAS */
      .type-danger .card-header { background: var(--red-bg); color: var(--red-text); border-bottom-color: var(--red-border); }
      .type-warning .card-header { background: var(--yellow-bg); color: var(--yellow-text); border-bottom-color: var(--yellow-border); }
      .type-ml .card-header { background: var(--green-bg); color: var(--green-text); border-bottom-color: var(--green-border); }

      .card-body { padding: 10px; flex: 1; overflow-y: auto; }
      
      /* ITEMS DE LISTA */
      .item { 
          background: rgba(255,255,255,0.03); 
          border: 1px solid rgba(255,255,255,0.05);
          margin-bottom: 10px; padding: 12px; border-radius: 8px; 
          border-left: 4px solid transparent; 
      }
      .type-danger .item { border-left-color: #ef4444; }
      .type-warning .item { border-left-color: #f59e0b; }
      .type-ml .item { border-left-color: #22c55e; }

      .item-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
      .trk { font-weight: bold; font-family: monospace; font-size: 15px; color: white; }
      .days-badge { font-size: 11px; font-weight: bold; padding: 2px 6px; border-radius: 4px; color: #111827; }
      
      .client-info { font-size: 13px; color: #9ca3af; margin-bottom: 6px; }
      .meta-info { font-size: 11px; color: #6b7280; display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 6px; margin-top: 6px; align-items: center; }

      .btn-action { 
          background: var(--blue-btn); color: white; border: none; 
          padding: 6px 12px; border-radius: 4px; font-size: 11px; font-weight: 600; 
          cursor: pointer; display: flex; align-items: center; gap: 4px; margin-left: auto;
      }
      .btn-action:hover { background: var(--blue-hover); }

      .empty-state { padding: 40px; text-align: center; color: #6b7280; font-style: italic; }
      .loading { padding: 20px; text-align: center; color: #9ca3af; }
      
      /* ML STATES */
      .ml-urgent { color: #f87171; font-weight: bold; }
      .ml-waiting { color: #4ade80; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 class="title">
            <span>üö® Monitor de Riesgos</span>
            <span class="live-indicator">‚óè LIVE</span>
        </h1>
        
        <div class="controls">
            <select id="filterSucursal" onchange="loadAlerts()">
                <option value="Todas">Cargando sucursales...</option>
            </select>
            <button class="btn-refresh" onclick="loadAlerts()">
                <i data-lucide="refresh-cw" style="width: 16px;"></i> Actualizar
            </button>
        </div>
    </div>

    <div class="alerts-grid">
        
        <div class="alert-card type-danger">
            <div class="card-header">
                <span>üì¶ Bodega (>5 d√≠as)</span>
                <span id="count-danger" style="font-size: 14px; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px;">0</span>
            </div>
            <div class="card-body" id="body-danger">
                <div class="loading">Cargando...</div>
            </div>
        </div>

        <div class="alert-card type-warning">
            <div class="card-header">
                <span>üöö Tr√°nsito (>10 d√≠as)</span>
                <span id="count-warning" style="font-size: 14px; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px;">0</span>
            </div>
            <div class="card-body" id="body-warning">
                <div class="loading">Cargando...</div>
            </div>
        </div>

        <div class="alert-card type-ml">
            <div class="card-header">
                <span>‚ö†Ô∏è Gesti√≥n ML (>3 d√≠as)</span>
                <span id="count-ml" style="font-size: 14px; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px;">0</span>
            </div>
            <div class="card-body" id="body-ml">
                <div class="loading">Cargando...</div>
            </div>
        </div>

    </div>
</div>

<script>
    if (typeof window.PSC_CONFIG === 'undefined') alert("Error: Falta config.js");
    const supabase = window.supabase.createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);
    lucide.createIcons();

    async function init() {
        await loadBranches();
        loadAlerts();
        setInterval(loadAlerts, 60000); // Auto-refresh 1 min
    }
    init();

    async function loadBranches() {
        const { data } = await supabase.from('sucursales').select('sucursal').order('sucursal', { ascending: true });
        const select = document.getElementById('filterSucursal');
        if (data) {
            select.innerHTML = '<option value="Todas">Todas las Sucursales</option>';
            data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.sucursal; opt.textContent = s.sucursal;
                select.appendChild(opt);
            });
        }
    }

    async function loadAlerts() {
        const sucursal = document.getElementById('filterSucursal').value;
        const bodyDanger = document.getElementById('body-danger');
        const bodyWarning = document.getElementById('body-warning');
        const bodyMl = document.getElementById('body-ml');
        
        bodyDanger.innerHTML = '<div class="loading">...</div>';
        bodyWarning.innerHTML = '<div class="loading">...</div>';
        bodyMl.innerHTML = '<div class="loading">...</div>';

        // TRAER TODO LO ACTIVO (No Recibido)
        let query = supabase
            .from('seguimiento_interno')
            .select('*')
            .neq('estado_alerta', 'Recibido'); 

        if (sucursal !== 'Todas') query = query.eq('sucursal', sucursal);
        
        const { data, error } = await query;
        if(error || !data) return;

        const now = new Date();
        const arrBodega = [];   
        const arrTransito = []; 
        const arrMl = [];       

        data.forEach(p => {
            // 1. CLASIFICACI√ìN ML (TU LOGICA CRITICA)
            if (p.estado_alerta === 'ML') {
                if (p.fecha_solicitud) {
                    // Ya se solicit√≥: Contamos desde la solicitud
                    p.diasCalc = Math.floor((now - new Date(p.fecha_solicitud)) / 864e5);
                    p.needsAction = false;
                } else {
                    // No se ha solicitado: Urgente acci√≥n
                    p.diasCalc = 0;
                    p.needsAction = true;
                }
                arrMl.push(p);
                return;
            }

            // 2. CLASIFICACI√ìN BODEGA (Tiene fecha entrega)
            if (p.fecha_entrega_miami) {
                const dias = Math.floor((now - new Date(p.fecha_entrega_miami)) / 864e5);
                if (dias > 5) {
                    p.diasCalc = dias;
                    arrBodega.push(p);
                }
                return;
            }

            // 3. CLASIFICACI√ìN TR√ÅNSITO (No tiene fecha entrega)
            if (!p.fecha_entrega_miami) {
                const dias = Math.floor((now - new Date(p.created_at)) / 864e5);
                if (dias > 10) {
                    p.diasCalc = dias;
                    arrTransito.push(p);
                }
            }
        });

        renderList(bodyDanger, arrBodega, 'danger');
        renderList(bodyWarning, arrTransito, 'warning');
        renderList(bodyMl, arrMl, 'ml');

        document.getElementById('count-danger').textContent = arrBodega.length;
        document.getElementById('count-warning').textContent = arrTransito.length;
        document.getElementById('count-ml').textContent = arrMl.length;
        
        lucide.createIcons();
    }

    function renderList(container, items, type) {
        if (items.length === 0) {
            container.innerHTML = `<div class="empty-state">‚úÖ Todo limpio</div>`;
            return;
        }

        // Ordenar: Los m√°s antiguos primero
        items.sort((a, b) => b.diasCalc - a.diasCalc);

        const html = items.map(p => {
            let badgeColor = '#e5e7eb';
            let labelTiempo = '';
            let extraAction = '';

            // LOGICA VISUAL PARA ML
            if (type === 'ml') {
                badgeColor = '#bbf7d0';
                
                if (p.needsAction) {
                    // CASO: FALTA SOLICITAR (BOTON AZUL)
                    labelTiempo = 'Sin gestionar';
                    extraAction = `<button class="btn-action" onclick="marcarSolicitado('${p.id}')"><i data-lucide="send" width="12"></i> Solicitar Info</button>`;
                } else {
                    // CASO: YA SOLICITADO (CUENTA REGRESIVA 3 DIAS)
                    if (p.diasCalc > 3) {
                        labelTiempo = `VENCIDO (${p.diasCalc}d)`;
                        extraAction = `<span class="ml-urgent">‚ö†Ô∏è Urgente</span>`;
                        badgeColor = '#fca5a5'; // Rojo claro
                    } else {
                        labelTiempo = `Esperando: ${p.diasCalc}d`;
                        extraAction = `<span class="ml-waiting">‚è≥ En espera</span>`;
                    }
                }
            } 
            // OTRAS COLUMNAS
            else if (type === 'danger') {
                badgeColor = '#fecaca'; 
                labelTiempo = `Retraso: ${p.diasCalc}d`;
            } else if (type === 'warning') {
                badgeColor = '#fde68a';
                labelTiempo = `Transito: ${p.diasCalc}d`;
            }

            return `
            <div class="item">
                <div class="item-top">
                    <span class="trk">${p.tracking}</span>
                    <span class="days-badge" style="background:${badgeColor}">${labelTiempo}</span>
                </div>
                <div class="client-info">${p.cliente_nombre} (${p.cliente_box})</div>
                <div class="meta-info">
                    <span>${p.sucursal || 'Centro'}</span>
                    ${extraAction}
                </div>
            </div>`;
        }).join('');

        container.innerHTML = html;
    }

    // --- ACCI√ìN PARA ML (ACTIVA EL CONTADOR DE 3 D√çAS) ---
    window.marcarSolicitado = async (id) => {
        if (!confirm("¬øConfirmas que ya escribiste al cliente? \nEsto iniciar√° la cuenta de 3 d√≠as.")) return;
        
        const { error } = await supabase
            .from('seguimiento_interno')
            .update({ fecha_solicitud: new Date().toISOString() })
            .eq('id', id);

        if (error) alert("Error: " + error.message);
        else loadAlerts(); // Recarga inmediata
    };

</script>

</body>
</html>
