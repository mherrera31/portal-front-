<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Monitor Live 4 Niveles - PSC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üö®</text></svg>" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
      :root {
        --bg: #111827; --fg: #f3f4f6; --card: #1f2937; --border: #374151;
        
        /* 1. ROJO: Sin Recibir (>10 dias) */
        --red-bg: #450a0a; --red-border: #7f1d1d; --red-text: #fecaca;
        
        /* 2. NARANJA: Entregado Carrier (>5 dias) */
        --orange-bg: #431407; --orange-border: #7c2d12; --orange-text: #fdba74;
        
        /* 3. AMARILLO: Carga Peligrosa (Info) */
        --yellow-bg: #422006; --yellow-border: #713f12; --yellow-text: #fde68a;
        
        /* 4. VERDE: Mal Identificado (Gesti√≥n) */
        --green-bg: #14532d; --green-border: #166534; --green-text: #bbf7d0;

        --blue-btn: #2563eb; --blue-hover: #1d4ed8;
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; }
      
      .container { max-width: 1600px; margin: 0 auto; }
      
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
      .title { font-size: 24px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px; }
      .live-indicator { font-size: 12px; background: #059669; color: white; padding: 2px 8px; border-radius: 12px; animation: pulse 2s infinite; }
      @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

      .controls { display: flex; gap: 15px; align-items: center; }
      select { background: var(--card); color: white; border: 1px solid var(--border); padding: 10px; border-radius: 8px; outline: none; min-width: 200px; }
      .btn-refresh { background: #2563eb; border: none; color: white; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
      .btn-refresh:hover { background: #1d4ed8; }

      /* GRID DE 4 COLUMNAS */
      .alerts-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; height: calc(100vh - 120px); }
      @media (max-width: 1200px) { .alerts-grid { grid-template-columns: 1fr 1fr; height: auto; } }
      @media (max-width: 600px) { .alerts-grid { grid-template-columns: 1fr; height: auto; } }

      .alert-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 100%; min-height: 400px; }
      .card-header { padding: 12px; font-weight: 700; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: 0.5px; }
      
      /* ASIGNACION DE COLORES */
      .type-sinrecibir .card-header { background: var(--red-bg); color: var(--red-text); border-bottom-color: var(--red-border); }
      .type-entregado .card-header { background: var(--orange-bg); color: var(--orange-text); border-bottom-color: var(--orange-border); }
      .type-dg .card-header { background: var(--yellow-bg); color: var(--yellow-text); border-bottom-color: var(--yellow-border); }
      .type-ml .card-header { background: var(--green-bg); color: var(--green-text); border-bottom-color: var(--green-border); }

      .card-body { padding: 10px; flex: 1; overflow-y: auto; }
      
      /* ITEMS */
      .item { 
          background: rgba(255,255,255,0.03); 
          border: 1px solid rgba(255,255,255,0.05);
          margin-bottom: 10px; padding: 10px; border-radius: 8px; 
          border-left: 4px solid transparent; 
      }
      .type-sinrecibir .item { border-left-color: #ef4444; }
      .type-entregado .item { border-left-color: #f97316; }
      .type-dg .item { border-left-color: #eab308; }
      .type-ml .item { border-left-color: #22c55e; }

      .item-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
      .trk { font-weight: bold; font-family: monospace; font-size: 14px; color: white; word-break: break-all; }
      .days-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; color: #111827; white-space: nowrap; }
      
      .client-info { font-size: 12px; color: #9ca3af; margin-bottom: 6px; }
      .meta-info { font-size: 11px; color: #6b7280; display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 6px; margin-top: 6px; align-items: center; }

      .btn-action { 
          background: var(--blue-btn); color: white; border: none; 
          padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 600; 
          cursor: pointer; display: flex; align-items: center; gap: 4px; margin-left: auto;
      }
      .btn-action:hover { background: var(--blue-hover); }

      .empty-state { padding: 40px; text-align: center; color: #6b7280; font-style: italic; font-size: 13px; }
      .loading { padding: 20px; text-align: center; color: #9ca3af; }
      
      /* ML STATES */
      .ml-urgent { color: #f87171; font-weight: bold; }
      .ml-waiting { color: #4ade80; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 class="title">
            <span>üö® Monitor de Riesgos</span>
            <span class="live-indicator">‚óè LIVE</span>
        </h1>
        
        <div class="controls">
            <select id="filterSucursal" onchange="loadAlerts()">
                <option value="Todas">Cargando sucursales...</option>
            </select>
            <button class="btn-refresh" onclick="loadAlerts()">
                <i data-lucide="refresh-cw" style="width: 16px;"></i> Actualizar
            </button>
        </div>
    </div>

    <div class="alerts-grid">
        
        <div class="alert-card type-sinrecibir">
            <div class="card-header">
                <span>üî¥ Sin Recibir (>10d)</span>
                <span id="count-sinrecibir" style="background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:10px;">0</span>
            </div>
            <div class="card-body" id="list-sinrecibir"><div class="loading">...</div></div>
        </div>

        <div class="alert-card type-entregado">
            <div class="card-header">
                <span>üü† Entregado Carrier (>5d)</span>
                <span id="count-entregado" style="background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:10px;">0</span>
            </div>
            <div class="card-body" id="list-entregado"><div class="loading">...</div></div>
        </div>

        <div class="alert-card type-dg">
            <div class="card-header">
                <span>üü° Carga Peligrosa</span>
                <span id="count-dg" style="background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:10px;">0</span>
            </div>
            <div class="card-body" id="list-dg"><div class="loading">...</div></div>
        </div>

        <div class="alert-card type-ml">
            <div class="card-header">
                <span>üü¢ Mal Identificado</span>
                <span id="count-ml" style="background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:10px;">0</span>
            </div>
            <div class="card-body" id="list-ml"><div class="loading">...</div></div>
        </div>

    </div>
</div>

<script>
    if (typeof window.PSC_CONFIG === 'undefined') alert("Error: Falta config.js");
    const supabase = window.supabase.createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);
    lucide.createIcons();

    async function init() {
        await loadBranches();
        loadAlerts();
        setInterval(loadAlerts, 60000); // Auto-refresh 1 min
    }
    init();

    async function loadBranches() {
        const { data } = await supabase.from('sucursales').select('sucursal').order('sucursal', { ascending: true });
        const select = document.getElementById('filterSucursal');
        if (data) {
            select.innerHTML = '<option value="Todas">Todas las Sucursales</option>';
            data.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.sucursal; opt.textContent = s.sucursal;
                select.appendChild(opt);
            });
        }
    }

    async function loadAlerts() {
        const sucursal = document.getElementById('filterSucursal').value;
        const listSinRecibir = document.getElementById('list-sinrecibir');
        const listEntregado = document.getElementById('list-entregado');
        const listDg = document.getElementById('list-dg');
        const listMl = document.getElementById('list-ml');
        
        // Indicador de carga
        listSinRecibir.innerHTML = '<div class="loading">...</div>';
        listEntregado.innerHTML = '<div class="loading">...</div>';
        listDg.innerHTML = '<div class="loading">...</div>';
        listMl.innerHTML = '<div class="loading">...</div>';

        // CONSULTA PRINCIPAL: Todo lo activo EXCEPTO 'Recibido' Y EXCEPTO 'Carta'
        let query = supabase
            .from('seguimiento_interno')
            .select('*')
            .neq('estado_alerta', 'Recibido')
            .neq('estado_alerta', 'Carta'); 

        if (sucursal !== 'Todas') query = query.eq('sucursal', sucursal);
        
        const { data, error } = await query;
        if(error || !data) return;

        const now = new Date();
        const arrSinRecibir = [];
        const arrEntregado = [];
        const arrDg = [];
        const arrMl = [];

        // CLASIFICACION INTELIGENTE
        data.forEach(p => {
            const status = p.estado_alerta || 'Pendiente';
            
            // --- 1. MAL IDENTIFICADO (VERDE) ---
            if (status === 'ML') {
                if (p.fecha_solicitud) {
                    // Ya se solicit√≥ info, contar d√≠as desde solicitud
                    p.diasCalc = Math.floor((now - new Date(p.fecha_solicitud)) / 864e5);
                    p.needsAction = false;
                } else {
                    // No se ha solicitado, urgente
                    p.diasCalc = 0;
                    p.needsAction = true;
                }
                arrMl.push(p);
                return; // Clasificado, pasamos al siguiente
            }

            // --- 2. CARGA PELIGROSA (AMARILLO - Informativo) ---
            if (status === 'Carga Peligrosa' || status === 'DG') {
                p.diasCalc = Math.floor((now - new Date(p.created_at)) / 864e5);
                arrDg.push(p);
                return; // Clasificado
            }

            // --- 3. ENTREGADO SEG√öN CARRIER (NARANJA - >5 D√≠as) ---
            // Solo si TIENE fecha_entrega_miami (Puesto manual)
            if (p.fecha_entrega_miami) {
                const dias = Math.floor((now - new Date(p.fecha_entrega_miami)) / 864e5);
                if (dias > 5) {
                    p.diasCalc = dias;
                    arrEntregado.push(p);
                }
                return; // Clasificado
            }

            // --- 4. SIN RECIBIR (ROJO - >10 D√≠as) ---
            // Solo entra si:
            // a) NO tiene fecha entrega manual
            // b) NO es un status de √©xito/proceso (Miami, Aduanas)
            // c) Tiene > 10 d√≠as de creado
            if (!p.fecha_entrega_miami && status !== 'Miami' && status !== 'Aduanas') {
                const dias = Math.floor((now - new Date(p.created_at)) / 864e5);
                if (dias > 10) {
                    p.diasCalc = dias;
                    arrSinRecibir.push(p);
                }
            }
        });

        // RENDERIZAR LAS LISTAS
        renderList(listSinRecibir, arrSinRecibir, 'sinrecibir');
        renderList(listEntregado, arrEntregado, 'entregado');
        renderList(listDg, arrDg, 'dg');
        renderList(listMl, arrMl, 'ml');

        // ACTUALIZAR CONTADORES
        document.getElementById('count-sinrecibir').textContent = arrSinRecibir.length;
        document.getElementById('count-entregado').textContent = arrEntregado.length;
        document.getElementById('count-dg').textContent = arrDg.length;
        document.getElementById('count-ml').textContent = arrMl.length;
        
        lucide.createIcons();
    }

    function renderList(container, items, type) {
        if (items.length === 0) {
            container.innerHTML = `<div class="empty-state">‚úÖ Todo limpio</div>`;
            return;
        }

        // Ordenar por antig√ºedad (M√°s urgente primero)
        items.sort((a, b) => b.diasCalc - a.diasCalc);

        const html = items.map(p => {
            let badgeColor = '#e5e7eb';
            let labelTiempo = '';
            let extraAction = '';

            if (type === 'ml') {
                badgeColor = '#bbf7d0';
                
                if (p.needsAction) {
                    // BOTON DE SOLICITAR
                    labelTiempo = 'Acci√≥n Requerida';
                    extraAction = `<button class="btn-action" onclick="marcarSolicitado('${p.id}')"><i data-lucide="send" width="12"></i> Solicitar</button>`;
                } else {
                    // CUENTA REGRESIVA
                    if (p.diasCalc > 3) {
                        labelTiempo = `VENCIDO (${p.diasCalc}d)`;
                        extraAction = `<span class="ml-urgent">‚ö†Ô∏è Urgente</span>`;
                        badgeColor = '#fca5a5';
                    } else {
                        labelTiempo = `Esperando: ${p.diasCalc}d`;
                        extraAction = `<span class="ml-waiting">‚è≥ En espera</span>`;
                    }
                }
            } 
            else if (type === 'sinrecibir') { // Rojo
                badgeColor = '#fecaca'; 
                labelTiempo = `Espera: ${p.diasCalc}d`;
            } 
            else if (type === 'entregado') { // Naranja
                badgeColor = '#fdba74';
                labelTiempo = `Entrega: ${p.diasCalc}d`;
            }
            else if (type === 'dg') { // Amarillo
                badgeColor = '#fde68a';
                labelTiempo = `Antig√ºedad: ${p.diasCalc}d`;
            }

            return `
            <div class="item">
                <div class="item-top">
                    <span class="trk">${p.tracking}</span>
                    <span class="days-badge" style="background:${badgeColor}">${labelTiempo}</span>
                </div>
                <div class="client-info">${p.cliente_nombre} (${p.cliente_box})</div>
                <div class="meta-info">
                    <span>${p.sucursal || 'Centro'}</span>
                    ${extraAction}
                </div>
            </div>`;
        }).join('');

        container.innerHTML = html;
    }

    // ACCI√ìN ML
    window.marcarSolicitado = async (id) => {
        if (!confirm("¬øConfirmar solicitud al cliente?")) return;
        const { error } = await supabase.from('seguimiento_interno').update({ fecha_solicitud: new Date().toISOString() }).eq('id', id);
        if (error) alert("Error: " + error.message);
        else loadAlerts();
    };

</script>

</body>
</html>
