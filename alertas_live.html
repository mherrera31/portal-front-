<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Monitor Live 4 Niveles - PSC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üö®</text></svg>" />
    
    <style>
      :root {
        --bg: #111827; --fg: #f3f4f6; --card: #1f2937; --border: #374151;
        --red-bg: #450a0a; --red-border: #7f1d1d; --red-text: #fecaca;
        --orange-bg: #431407; --orange-border: #7c2d12; --orange-text: #fdba74;
        --yellow-bg: #422006; --yellow-border: #713f12; --yellow-text: #fde68a;
        --green-bg: #14532d; --green-border: #166534; --green-text: #bbf7d0;
        --blue-btn: #2563eb; --blue-hover: #1d4ed8;
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, sans-serif; padding: 20px; }
      
      .container { max-width: 1600px; margin: 0 auto; }
      
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
      .title { font-size: 24px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 10px; }
      .live-indicator { font-size: 12px; background: #059669; color: white; padding: 2px 8px; border-radius: 12px; animation: pulse 2s infinite; }
      @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

      .controls { display: flex; gap: 15px; align-items: center; }
      select { background: var(--card); color: white; border: 1px solid var(--border); padding: 10px; border-radius: 8px; outline: none; min-width: 200px; }
      .btn-refresh { background: #2563eb; border: none; color: white; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600; }
      .btn-refresh:hover { background: #1d4ed8; }

      .alerts-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; height: calc(100vh - 120px); }
      @media (max-width: 1200px) { .alerts-grid { grid-template-columns: 1fr 1fr; height: auto; } }
      @media (max-width: 600px) { .alerts-grid { grid-template-columns: 1fr; height: auto; } }

      .alert-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; height: 100%; min-height: 400px; }
      .card-header { padding: 12px; font-weight: 700; font-size: 13px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: 0.5px; }
      
      .type-sinrecibir .card-header { background: var(--red-bg); color: var(--red-text); border-bottom-color: var(--red-border); }
      .type-entregado .card-header { background: var(--orange-bg); color: var(--orange-text); border-bottom-color: var(--orange-border); }
      .type-dg .card-header { background: var(--yellow-bg); color: var(--yellow-text); border-bottom-color: var(--yellow-border); }
      .type-ml .card-header { background: var(--green-bg); color: var(--green-text); border-bottom-color: var(--green-border); }

      .card-body { padding: 10px; flex: 1; overflow-y: auto; }
      
      .item { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px; padding: 10px; border-radius: 8px; border-left: 4px solid transparent; }
      .type-sinrecibir .item { border-left-color: #ef4444; }
      .type-entregado .item { border-left-color: #f97316; }
      .type-dg .item { border-left-color: #eab308; }
      .type-ml .item { border-left-color: #22c55e; }

      .item-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
      .trk { font-weight: bold; font-family: monospace; font-size: 14px; color: white; word-break: break-all; }
      .days-badge { font-size: 10px; font-weight: bold; padding: 2px 6px; border-radius: 4px; color: #111827; white-space: nowrap; }
      .client-info { font-size: 12px; color: #9ca3af; margin-bottom: 6px; }
      .meta-info { font-size: 11px; color: #6b7280; display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 6px; margin-top: 6px; align-items: center; }

      .btn-action { background: var(--blue-btn); color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 10px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 4px; margin-left: auto; }
      .btn-action:hover { background: var(--blue-hover); }

      .empty-state { padding: 40px; text-align: center; color: #6b7280; font-style: italic; font-size: 13px; }
      .loading { padding: 20px; text-align: center; color: #9ca3af; }
      .ml-urgent { color: #f87171; font-weight: bold; }
      .ml-waiting { color: #4ade80; }
    </style>
    
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 class="title">
            <span>üö® Monitor de Riesgos</span>
            <span class="live-indicator">‚óè LIVE</span>
        </h1>
        
        <div class="controls">
            <select id="filterSucursal"><option value="Todas">Cargando...</option></select>
            <button id="btnRefresh" class="btn-refresh">
                <i data-lucide="refresh-cw" width="16"></i> Actualizar
            </button>
        </div>
    </div>

    <div class="alerts-grid">
        
        <div class="alert-card type-sinrecibir">
            <div class="card-header">
                <span>üî¥ Sin Recibir (>10d)</span>
                <span id="count-sinrecibir" style="background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:10px;">0</span>
            </div>
            <div class="card-body" id="list-sinrecibir"><div class="loading">...</div></div>
        </div>

        <div class="alert-card type-entregado">
            <div class="card-header">
                <span>üü† Entregado Carrier (>5d)</span>
                <span id="count-entregado" style="background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:10px;">0</span>
            </div>
            <div class="card-body" id="list-entregado"><div class="loading">...</div></div>
        </div>

        <div class="alert-card type-dg">
            <div class="card-header">
                <span>üü° Carga Peligrosa</span>
                <span id="count-dg" style="background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:10px;">0</span>
            </div>
            <div class="card-body" id="list-dg"><div class="loading">...</div></div>
        </div>

        <div class="alert-card type-ml">
            <div class="card-header">
                <span>üü¢ Mal Identificado</span>
                <span id="count-ml" style="background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:10px;">0</span>
            </div>
            <div class="card-body" id="list-ml"><div class="loading">...</div></div>
        </div>

    </div>
</div>

<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    if (typeof window.PSC_CONFIG === 'undefined') {
        alert("Error cr√≠tico: config.js no se carg√≥ correctamente.");
        throw new Error("Falta config.js");
    }

    const supabase = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);
    lucide.createIcons();

    // Referencias DOM
    const dom = {
        filterSucursal: document.getElementById('filterSucursal'),
        btnRefresh: document.getElementById('btnRefresh'),
        listSinRecibir: document.getElementById('list-sinrecibir'),
        listEntregado: document.getElementById('list-entregado'),
        listDg: document.getElementById('list-dg'),
        listMl: document.getElementById('list-ml'),
        countSinRecibir: document.getElementById('count-sinrecibir'),
        countEntregado: document.getElementById('count-entregado'),
        countDg: document.getElementById('count-dg'),
        countMl: document.getElementById('count-ml')
    };

    // Inicializar
    async function init() {
        await loadBranches();
        await loadAlerts();
        
        // Listeners
        dom.filterSucursal.addEventListener('change', loadAlerts);
        dom.btnRefresh.addEventListener('click', loadAlerts);
        
        // Auto-refresh cada 60s
        setInterval(loadAlerts, 60000);
    }
    
    // Ejecutar inicio
    init();

    async function loadBranches() {
        try {
            const { data } = await supabase.from('sucursales').select('sucursal').order('sucursal', { ascending: true });
            if (data) {
                dom.filterSucursal.innerHTML = '<option value="Todas">Todas las Sucursales</option>';
                data.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.sucursal;
                    opt.textContent = s.sucursal;
                    dom.filterSucursal.appendChild(opt);
                });
            }
        } catch (e) { console.error("Error sucursales", e); }
    }

    async function loadAlerts() {
        const sucursal = dom.filterSucursal.value;
        
        // Set Loading
        [dom.listSinRecibir, dom.listEntregado, dom.listDg, dom.listMl].forEach(el => el.innerHTML = '<div class="loading">Cargando...</div>');

        // CONSULTA BASE
        let query = supabase
            .from('seguimiento_interno')
            .select('*')
            .neq('estado_alerta', 'Recibido')
            .neq('estado_alerta', 'Carta');

        if (sucursal !== 'Todas') query = query.eq('sucursal', sucursal);
        
        const { data, error } = await query;
        
        if (error) {
            console.error(error);
            dom.listSinRecibir.innerHTML = `<div class="empty-state text-red-500">Error: ${error.message}</div>`;
            return;
        }

        const now = new Date();
        const arrSinRecibir = [];
        const arrEntregado = [];
        const arrDg = [];
        const arrMl = [];

        // --- CLASIFICACI√ìN ---
        data.forEach(p => {
            const status = p.estado_alerta || 'Pendiente';
            
            // 1. MAL IDENTIFICADO (Verde)
            if (status === 'ML') {
                p.diasCalc = p.fecha_solicitud ? Math.floor((now - new Date(p.fecha_solicitud)) / 864e5) : 0;
                p.needsAction = !p.fecha_solicitud;
                arrMl.push(p);
                return;
            }

            // 2. CARGA PELIGROSA (Amarillo)
            if (status === 'Carga Peligrosa' || status === 'DG') {
                p.diasCalc = Math.floor((now - new Date(p.created_at)) / 864e5);
                arrDg.push(p);
                return;
            }

            // 3. ENTREGADO CARRIER (Naranja - >5 d√≠as)
            // L√≥gica: Tiene fecha entrega carrier PERO no ha sido procesado internamente
            // Excluimos: En Proceso, Alerta, Miami, Aduanas, Transito, Recibido
            const isSafeStatus = ['En Proceso de Aduana', 'Alerta', 'Miami', 'Aduanas', 'Tr√°nsito', 'Recibido', 'Carta'].includes(status);
            
            if (p.fecha_entrega_miami && !isSafeStatus) {
                const dias = Math.floor((now - new Date(p.fecha_entrega_miami)) / 864e5);
                if (dias > 5) {
                    p.diasCalc = dias;
                    arrEntregado.push(p);
                }
                return;
            }

            // 4. SIN RECIBIR (Rojo - >10 d√≠as)
            // L√≥gica: No hay fecha entrega carrier, y sigue en estados iniciales
            if (!p.fecha_entrega_miami && !isSafeStatus) {
                const dias = Math.floor((now - new Date(p.created_at)) / 864e5);
                if (dias > 10) {
                    p.diasCalc = dias;
                    arrSinRecibir.push(p);
                }
            }
        });

        // RENDER
        renderList(dom.listSinRecibir, arrSinRecibir, 'sinrecibir');
        renderList(dom.listEntregado, arrEntregado, 'entregado');
        renderList(dom.listDg, arrDg, 'dg');
        renderList(dom.listMl, arrMl, 'ml');

        // CONTADORES
        dom.countSinRecibir.textContent = arrSinRecibir.length;
        dom.countEntregado.textContent = arrEntregado.length;
        dom.countDg.textContent = arrDg.length;
        dom.countMl.textContent = arrMl.length;
        
        lucide.createIcons();
    }

    function renderList(container, items, type) {
        if (!items.length) {
            container.innerHTML = `<div class="empty-state">‚úÖ Todo limpio</div>`;
            return;
        }

        items.sort((a, b) => b.diasCalc - a.diasCalc);

        container.innerHTML = items.map(p => {
            let badgeColor = '#e5e7eb';
            let labelTiempo = '';
            let extraAction = '';

            if (type === 'ml') {
                badgeColor = '#bbf7d0';
                if (p.needsAction) {
                    labelTiempo = 'Acci√≥n Requerida';
                    // Usamos window.marcarSolicitado que definiremos globalmente
                    extraAction = `<button class="btn-action" onclick="window.marcarSolicitado('${p.id}')"><i data-lucide="send" width="12"></i> Solicitar</button>`;
                } else {
                    if (p.diasCalc > 3) {
                        labelTiempo = `VENCIDO (${p.diasCalc}d)`;
                        extraAction = `<span class="ml-urgent">‚ö†Ô∏è Urgente</span>`;
                        badgeColor = '#fca5a5';
                    } else {
                        labelTiempo = `Esperando: ${p.diasCalc}d`;
                        extraAction = `<span class="ml-waiting">‚è≥ En espera</span>`;
                    }
                }
            } 
            else if (type === 'sinrecibir') { badgeColor = '#fecaca'; labelTiempo = `Espera: ${p.diasCalc}d`; } 
            else if (type === 'entregado') { badgeColor = '#fdba74'; labelTiempo = `Entrega: ${p.diasCalc}d`; }
            else if (type === 'dg') { badgeColor = '#fde68a'; labelTiempo = `Antig√ºedad: ${p.diasCalc}d`; }

            // Escapar comillas para JS
            const safeTracking = (p.tracking || '').replace(/'/g, "\\'");
            
            return `
            <div class="item">
                <div class="item-top">
                    <span class="trk">${safeTracking}</span>
                    <span class="days-badge" style="background:${badgeColor}">${labelTiempo}</span>
                </div>
                <div class="client-info">${p.cliente_nombre || 'Sin Nombre'} (${p.cliente_box || 'N/A'})</div>
                <div class="meta-info">
                    <span>${p.sucursal || 'Centro'}</span>
                    ${extraAction}
                </div>
            </div>`;
        }).join('');
    }

    // EXPORTAR FUNCIONES AL WINDOW (Para que funcionen los onclick)
    window.marcarSolicitado = async (id) => {
        if (!confirm("¬øConfirmar solicitud al cliente?")) return;
        const { error } = await supabase.from('seguimiento_interno').update({ fecha_solicitud: new Date().toISOString() }).eq('id', id);
        if (error) alert("Error: " + error.message);
        else loadAlerts();
    };

</script>
</body>
</html>
