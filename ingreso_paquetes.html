<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Control Paquetes ‚Äî PSC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üì¶</text></svg>" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
      :root {
        --bg: #f3f4f6; --fg: #1f2937; --muted: #6b7280; --border: #e5e7eb;
        --card: #ffffff; --primary: #2563eb; --primary-hover: #1d4ed8;
        --radius: 12px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 20px; }
      
      .container { max-width: 500px; margin: 0 auto; transition: max-width 0.3s; position: relative; z-index: 1; }
      .container.wide { max-width: 1200px; }

      .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 24px; overflow: visible; position: relative; z-index: 2; }
      
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
      .title { font-size: 20px; font-weight: 700; margin: 0; color: #111827; }
      .nav-btn { background: none; border: none; cursor: pointer; color: var(--primary); font-weight: 600; display: flex; align-items: center; gap: 6px; padding: 8px; border-radius: 6px; }
      .nav-btn:hover { background-color: #eff6ff; }

      .field { margin-bottom: 16px; position: relative; z-index: 5; }
      .label { display: block; font-weight: 600; font-size: 13px; margin-bottom: 6px; color: #374151; }
      
      input, select { 
          width: 100%; height: 42px; padding: 0 12px; border: 1px solid var(--border); 
          border-radius: 8px; font-size: 15px; outline: none; 
          background-color: #ffffff !important; 
          color: #111827 !important;
          position: relative; z-index: 10; 
      }
      input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
      
      .btn { width: 100%; height: 44px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 8px; position: relative; z-index: 10; }
      .btn:hover { background: var(--primary-hover); }
      .btn:disabled { opacity: 0.7; cursor: not-allowed; }
      .btn-success { background: #10b981; } .btn-success:hover { background: #059669; }

      /* FILTROS */
      .filters-grid { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto auto; gap: 10px; margin-bottom: 16px; position: relative; z-index: 20; }
      @media (max-width: 900px) { .filters-grid { grid-template-columns: 1fr 1fr; } }

      .table-container-relative { position: relative; overflow: hidden; border-radius: 8px; border: 1px solid var(--border); }
      
      /* BARRA DE PROGRESO REAL */
      .scan-line {
          position: absolute; top: 0; left: 0; width: 0%; height: 4px;
          background: #10b981; /* Verde solido */
          z-index: 50; display: none;
          transition: width 0.3s ease; /* Animacion suave */
      }

      .table-wrapper { overflow-x: auto; max-height: 70vh; position: relative; z-index: 1; border: none; }
      table { width: 100%; border-collapse: collapse; min-width: 900px; }
      th { background: #f9fafb; text-align: left; padding: 12px; font-size: 12px; color: #6b7280; font-weight: 600; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 10; }
      td { padding: 12px; border-bottom: 1px solid #f3f4f6; font-size: 14px; color: #374151; vertical-align: middle; }
      tr:last-child td { border-bottom: none; }
      
      .pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 10px; border-top: 1px solid var(--border); }
      .page-info { font-size: 13px; color: #6b7280; }
      .page-controls { display: flex; gap: 10px; }
      .btn-page { padding: 6px 12px; border: 1px solid var(--border); background: white; border-radius: 6px; cursor: pointer; font-size: 13px; z-index: 10; position:relative; color: #000; }
      .btn-page:hover:not(:disabled) { background: #f3f4f6; }
      .btn-page:disabled { opacity: 0.5; cursor: default; }

      /* ESTADOS */
      .status-badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-block; white-space: nowrap; border: 1px solid transparent; transition: all 0.3s; }
      .st-pendiente, .st-no-info { background: #f3f4f6; color: #4b5563; border-color: #e5e7eb; }
      .st-miami { background: #eff6ff; color: #1d4ed8; border-color: #bfdbfe; }
      .st-transito { background: #fff7ed; color: #c2410c; border-color: #fed7aa; }
      .st-dg { background: #fefce8; color: #854d0e; border-color: #fef08a; } 
      .st-aduanas { background: #dcfce7; color: #15803d; border-color: #bbf7d0; } 
      .st-recibido { background: #166534; color: #ffffff; border-color: #14532d; } 
      .st-ml { background: #fef2f2; color: #b91c1c; border-color: #fecaca; }
      .st-carta { background: #374151; color: #f3f4f6; border-color: #1f2937; } 
      .st-proceso { background: #e0e7ff; color: #4338ca; border-color: #c7d2fe; }

      .hidden { display: none !important; visibility: hidden !important; pointer-events: none !important; }
      .status-msg { margin-top: 10px; text-align: center; font-size: 14px; font-weight: 600; color: #059669; height: 20px; }
      
      .action-row { display: flex; gap: 5px; }
      .action-btn { padding: 6px; border-radius: 6px; border: 1px solid var(--border); background: white; cursor: pointer; color: var(--fg); display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; transition: all 0.2s; }
      .action-btn:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
      
      .btn-blue { color: var(--primary); border-color: #bfdbfe; background: #eff6ff; }
      .btn-orange { color: #c2410c; border-color: #fed7aa; background: #fff7ed; }
      .btn-red { color: #b91c1c; border-color: #fecaca; background: #fef2f2; }
      .btn-disabled { opacity: 0.5; cursor: default; background: #f3f4f6; border-color: #e5e7eb; color: #9ca3af; transform: none !important; }

      .btn-req { 
          background: #2563eb; color: white; border: none; border-radius: 4px; 
          padding: 3px 8px; font-size: 10px; font-weight: bold; cursor: pointer; 
          margin-left: 5px; vertical-align: middle; display: inline-flex; align-items: center; gap: 3px;
      }
      .btn-req:hover { background: #1d4ed8; }
      .ml-status-text { font-size: 10px; display: block; margin-top: 4px; font-weight: 700; }
      .ml-vencido { color: #dc2626; }
      .ml-espera { color: #059669; }

      .btn-auto-off { background-color: #64748b !important; color: white; }
      .btn-auto-on { background-color: #10b981 !important; color: white; border: 1px solid #059669; }

      .autocomplete-suggestions {
        position: absolute; top: 100%; left: 0; right: 0;
        border: 1px solid var(--border); background-color: white;
        max-height: 200px; overflow-y: auto; z-index: 100;
        border-radius: 0 0 8px 8px; box-shadow: var(--shadow); display: none;
      }
      .suggestion-item { padding: 10px 14px; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
      .suggestion-item:hover { background-color: #eff6ff; }

      .client-info-card { background-color: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px; padding: 12px; margin-bottom: 20px; display: none; }
      .client-info-card.active { display: block; }
      .client-info-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
      .client-info-val { font-weight: 700; color: #1e40af; }

      /* Modales */
      .modal-overlay { 
          position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
          background: rgba(0,0,0,0.5); display: flex; align-items: center; 
          justify-content: center; z-index: 9999 !important; 
      }
      .modal-content { background: white; padding: 24px; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); max-height: 80vh; overflow-y: auto; }
      .modal-title { font-size: 18px; font-weight: 700; margin-bottom: 16px; }
      .modal-actions { display: flex; gap: 10px; margin-top: 20px; }
      
      .match-item { border: 1px solid #e5e7eb; padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; background: #f9fafb; transition: all 0.2s; }
      .match-item:hover { background: #eff6ff; border-color: #bfdbfe; transform: translateX(2px); }
      .match-title { font-weight: 700; font-size: 14px; color: #1f2937; margin-bottom: 4px; }
      .match-sub { font-size: 12px; color: #6b7280; display: block; }
      .match-highlight { color: #2563eb; font-weight: 600; }

      .col-seguimiento { font-size: 11px; color: #4b5563; line-height: 1.3; max-width: 200px; }
      .col-nota { font-size: 11px; color: #c2410c; font-style: italic; max-width: 150px; overflow: hidden; text-overflow: ellipsis; }
      .col-match { font-size: 10px; color: #059669; font-family: monospace; background: #ecfdf5; padding: 2px 4px; border-radius: 4px; display: inline-block; margin-top: 2px; }
      
      .check-row {
          display: flex; align-items: center; gap: 10px;
          margin-bottom: 16px; padding: 10px;
          background: #eff6ff; border: 1px solid #bfdbfe;
          border-radius: 8px; cursor: pointer;
      }
      .check-row input { width: 20px; height: 20px; margin: 0; cursor: pointer; }
      .check-text { font-size: 14px; font-weight: 600; color: #1e40af; }
    </style>
</head>
<body>

<div id="mainContainer" class="container">
    <div class="card">
        
        <div class="header">
            <h1 class="title" id="pageTitle">Registro Interno</h1>
            <button id="btnGoToList" class="nav-btn"><i data-lucide="list"></i> Ver Lista</button>
            <button id="btnGoToForm" class="nav-btn hidden"><i data-lucide="arrow-left"></i> Volver</button>
        </div>

        <div id="viewForm">
            <form id="formIngreso">
                <div class="field"><label class="label">Tracking Number</label><input type="text" id="tracking" placeholder="Escanea o escribe..." autocomplete="off"></div>
                <div class="field">
                    <label class="label">Buscar Cliente</label>
                    <input type="text" id="clienteSearch" placeholder="Nombre o Casillero..." autocomplete="off">
                    <div id="suggestions" class="autocomplete-suggestions" style="display:none;"></div>
                </div>

                <div class="check-row" onclick="toggleCheck()">
                    <input type="checkbox" id="chkEntregado" onclick="event.stopPropagation()">
                    <span class="check-text">¬øYa figura "Entregado" por el Carrier?</span>
                </div>

                <div id="clientInfo" class="client-info-card" style="display:none;">
                    <div class="client-info-row"><span>Nombre:</span><span class="client-info-val" id="dispNombre">-</span></div>
                    <div class="client-info-row"><span>Casillero:</span><span class="client-info-val" id="dispBox">-</span></div>
                    <div class="client-info-row"><span>Sucursal:</span><span class="client-info-val" id="dispSucursal">-</span></div>
                </div>
                <input type="hidden" id="h_nombre"><input type="hidden" id="h_box"><input type="hidden" id="h_sucursal">
                <button type="submit" class="btn" id="btnGuardar"><i data-lucide="save"></i> Guardar Paquete</button>
                <div id="status" class="status-msg"></div>
            </form>
        </div>

        <div id="viewList" class="hidden">
            <div class="filters-grid">
                <input type="text" id="filterTracking" placeholder="üîç Buscar Tracking...">
                <input type="text" id="filterClient" placeholder="üë§ Buscar Cliente/Box...">
                <select id="filterSucursal"><option value="Todas">Cargando...</option></select>
                <select id="filterStatus">
                    <option value="Activos">Activos (Ocultar Recibidos/Carta)</option>
                    <option value="Todos">Ver Todo</option>
                    <option value="En Proceso de Aduana">En Proceso (Bodega)</option>
                    <option value="Recibido">Solo Recibidos</option>
                    <option value="Carta">Carta (No Entregados)</option>
                    <option value="Aduanas">Solo Aduanas</option>
                    <option value="ML">Solo ML</option>
                </select>
                
                <button id="btnToggleAuto" class="btn btn-auto-off" onclick="toggleAutoUpdate()">‚è∏Ô∏è Auto: OFF</button>
                <button id="btnUpdateMassive" class="btn btn-success" onclick="runManualScan()" title="Actualizar Manualmente"><i data-lucide="zap"></i></button>
            </div>

            <div class="table-container-relative">
                <div id="scanLine" class="scan-line"></div>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Acci√≥n</th>
                                <th>Tracking</th>
                                <th>Cliente / Box</th>
                                <th>Info Seguimiento</th>
                                <th>Nota</th>
                                <th>Sucursal</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="pagination">
                <div class="page-info" id="pageInfo">Cargando...</div>
                <div class="page-controls">
                    <button class="btn-page" id="btnPrev">Anterior</button>
                    <button class="btn-page" id="btnNext">Siguiente</button>
                </div>
            </div>

            <p id="tableMsg" class="status-msg"></p>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 class="modal-title">Correcci√≥n Manual</h2>
        <input type="hidden" id="editId">
        <div class="field"><label class="label">Correcci√≥n de Tracking</label><input type="text" id="editTracking"></div>
        <div class="field">
            <label class="label">Tracking Match (Enlace Manual)</label>
            <input type="text" id="editMatch" placeholder="Tracking exacto para enlazar...">
            <small style="color:#6b7280; font-size:11px;">Usar si el tracking f√≠sico difiere del sistema.</small>
        </div>
        <div class="field">
            <label class="label">Forzar Estado</label>
            <select id="editEstado">
                <option value="Pendiente">Pendiente</option>
                <option value="En Proceso de Aduana">En Proceso de Aduana</option>
                <option value="Recibido">Recibido (Finalizar)</option>
                <option value="Carta">Carta (No Entregado)</option>
                <option value="ML">Mal Identificado</option>
                <option value="Aduanas">Aduanas</option>
            </select>
        </div>
        <div class="field"><label class="label">Nota Personal</label><input type="text" id="editNota" placeholder="Ej: Vinculado manual..."></div>
        <div class="modal-actions">
            <button class="btn" style="background:#6b7280;" onclick="closeEditModal()">Cancelar</button>
            <button class="btn" onclick="saveManualEdit()">Guardar</button>
        </div>
    </div>
</div>

<div id="matchModal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2 class="modal-title">üîó Seleccionar Coincidencia</h2>
        <p class="text-sm text-slate-500 mb-2">Buscando para: <b id="dispMatchTracking">...</b></p>
        <input type="hidden" id="matchTargetId">
        <div id="matchList"></div>
        <div class="modal-actions">
            <button class="btn" style="background:#6b7280;" onclick="closeMatchModal()">Cancelar</button>
        </div>
    </div>
</div>

<script>
    if (typeof window.PSC_CONFIG === 'undefined') alert("Error: Falta config.js");
    const supabase = window.supabase.createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);
    lucide.createIcons();

    const dom = {
        container: document.getElementById('mainContainer'),
        title: document.getElementById('pageTitle'),
        btnGoToList: document.getElementById('btnGoToList'),
        btnGoToForm: document.getElementById('btnGoToForm'),
        viewForm: document.getElementById('viewForm'),
        viewList: document.getElementById('viewList'),
        form: document.getElementById('formIngreso'),
        tracking: document.getElementById('tracking'),
        search: document.getElementById('clienteSearch'),
        suggestions: document.getElementById('suggestions'),
        chkEntregado: document.getElementById('chkEntregado'), 
        clientCard: document.getElementById('clientInfo'),
        status: document.getElementById('status'),
        btnGuardar: document.getElementById('btnGuardar'),
        h_nombre: document.getElementById('h_nombre'),
        h_box: document.getElementById('h_box'),
        h_sucursal: document.getElementById('h_sucursal'),
        tableBody: document.getElementById('tableBody'),
        tableMsg: document.getElementById('tableMsg'),
        filterTracking: document.getElementById('filterTracking'),
        filterClient: document.getElementById('filterClient'),
        filterSucursal: document.getElementById('filterSucursal'),
        filterStatus: document.getElementById('filterStatus'),
        btnUpdateMassive: document.getElementById('btnUpdateMassive'),
        btnToggleAuto: document.getElementById('btnToggleAuto'),
        scanLine: document.getElementById('scanLine'),
        editModal: document.getElementById('editModal'),
        editId: document.getElementById('editId'),
        editTracking: document.getElementById('editTracking'),
        editMatch: document.getElementById('editMatch'),
        editEstado: document.getElementById('editEstado'),
        editNota: document.getElementById('editNota'),
        matchModal: document.getElementById('matchModal'),
        matchList: document.getElementById('matchList'),
        matchTargetId: document.getElementById('matchTargetId'),
        dispMatchTracking: document.getElementById('dispMatchTracking'),
        btnPrev: document.getElementById('btnPrev'),
        btnNext: document.getElementById('btnNext'),
        pageInfo: document.getElementById('pageInfo')
    };

    let selectedClient = null;
    let currentData = [];
    let currentPage = 1;
    const pageSize = 50;
    let totalItems = 0;
    let searchDebounce = null;
    
    // AUTO UPDATE VARS
    let autoUpdateInterval = null;
    let isAutoUpdateActive = false;

    function getTimestamp(val) { if (!val) return 0; const dateStr = typeof val === 'object' ? val.date : val; if (!dateStr) return 0; return new Date(dateStr).getTime(); }
    window.toggleCheck = () => { /* dom.chkEntregado.checked = !dom.chkEntregado.checked; */ };

    async function init() {
        await autoCleanOldRecords();
        await loadBranches();
    }
    init();

    // LIMPIEZA 60 DIAS
    async function autoCleanOldRecords() {
        const limitDate = new Date(); limitDate.setDate(limitDate.getDate() - 60); 
        await supabase.from('seguimiento_interno').delete({ count: 'exact' }).lt('created_at', limitDate.toISOString()).eq('estado_alerta', 'Recibido'); 
        await supabase.from('seguimiento_interno').delete({ count: 'exact' }).lt('created_at', limitDate.toISOString()).eq('estado_alerta', 'Carta'); 
    }

    async function loadBranches() {
        const { data } = await supabase.from('sucursales').select('sucursal').order('sucursal', { ascending: true });
        if (data) {
            dom.filterSucursal.innerHTML = '<option value="Todas">Todas las Sucursales</option>';
            data.forEach(s => { const opt = document.createElement('option'); opt.value = s.sucursal; opt.textContent = s.sucursal; dom.filterSucursal.appendChild(opt); });
        }
    }

    // NAVEGACI√ìN
    dom.btnGoToList.addEventListener('click', () => { 
        dom.viewForm.classList.add('hidden'); dom.viewList.classList.remove('hidden'); dom.btnGoToList.classList.add('hidden'); dom.btnGoToForm.classList.remove('hidden');
        dom.title.textContent = "Seguimiento"; dom.container.classList.add('wide'); loadPackages(); 
    });
    dom.btnGoToForm.addEventListener('click', () => { 
        dom.viewList.classList.add('hidden'); dom.viewForm.classList.remove('hidden'); dom.btnGoToForm.classList.add('hidden'); dom.btnGoToList.classList.remove('hidden');
        dom.title.textContent = "Registro Interno"; dom.container.classList.remove('wide');
    });

    // REGISTRO
    dom.search.addEventListener('input', async (e) => {
        const term = e.target.value.trim(); if (term.length < 2) { dom.suggestions.style.display = 'none'; return; }
        const { data } = await supabase.rpc('buscar_clientes_flex', { search_term: term });
        if (!data || data.length === 0) { dom.suggestions.style.display = 'none'; return; }
        dom.suggestions.innerHTML = data.map(c => `<div class="suggestion-item" onclick='selectClient(${JSON.stringify(c)})'><strong>${c.nombre}</strong><span style="color:#6b7280; font-size:12px">Box: ${c.box} | Suc: ${c.sucursal || 'Centro'}</span></div>`).join('');
        dom.suggestions.style.display = 'block';
    });

    window.selectClient = (c) => {
        selectedClient = c; dom.search.value = `${c.nombre}`;
        document.getElementById('dispNombre').textContent = c.nombre; document.getElementById('dispBox').textContent = c.box; document.getElementById('dispSucursal').textContent = c.sucursal || 'Centro';
        dom.h_nombre.value = c.nombre; dom.h_box.value = c.box; dom.h_sucursal.value = c.sucursal || 'Centro';
        document.getElementById('clientInfo').style.display = 'block'; dom.suggestions.style.display = 'none';
    };
    
    document.addEventListener('click', (e) => { if (!dom.search.contains(e.target) && !dom.suggestions.contains(e.target)) dom.suggestions.style.display = 'none'; });

    // GUARDAR + CHECK INMEDIATO
    dom.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const trk = dom.tracking.value.trim();
        if (trk.length < 3 || !selectedClient) { dom.status.textContent = '‚ùå Faltan datos'; dom.status.style.color = 'red'; return; }
        dom.btnGuardar.disabled = true;

        const yaEntregado = dom.chkEntregado.checked;
        const fechaMiami = yaEntregado ? new Date().toISOString() : null;
        const textoSeguimiento = yaEntregado ? 'Esperando ingreso a bodega' : 'Pre-alerta (En tr√°nsito)';

        const { data: existing } = await supabase.from('seguimiento_interno').select('id').eq('tracking', trk).maybeSingle();
        if (existing) { dom.status.textContent = '‚ö†Ô∏è Tracking duplicado'; dom.status.style.color = 'orange'; dom.btnGuardar.disabled = false; return; }
        
        // 1. Insertar
        const { data: newPkg, error } = await supabase.from('seguimiento_interno').insert([{
            tracking: trk, cliente_nombre: dom.h_nombre.value, cliente_box: dom.h_box.value, sucursal: dom.h_sucursal.value, 
            estado_alerta: 'Pendiente', seguimiento: textoSeguimiento, nota: '', fecha_entrega_miami: fechaMiami
        }]).select().single();

        dom.btnGuardar.disabled = false;
        if (error) { 
            dom.status.textContent = 'Error: ' + error.message; dom.status.style.color = 'red'; 
        } else { 
            dom.status.textContent = '‚úÖ Guardado.'; dom.status.className = 'status-msg success'; 
            if (newPkg) await checkStatus(newPkg.id, newPkg.tracking, false);
            dom.tracking.value = ''; dom.chkEntregado.checked = false; dom.tracking.focus(); 
            setTimeout(() => { dom.status.textContent = '‚úÖ Listo'; }, 2000);
        }
    });

    // LISTA PAGINADA
    async function loadPackages(silent = false) {
        if(!silent) {
            dom.tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Cargando p√°gina ' + currentPage + '...</td></tr>';
            dom.tableMsg.textContent = '';
        }

        const from = (currentPage - 1) * pageSize;
        const to = from + pageSize - 1;

        let query = supabase.from('seguimiento_interno').select('*', { count: 'exact' });

        if (dom.filterSucursal.value !== 'Todas') query = query.eq('sucursal', dom.filterSucursal.value);
        if (dom.filterClient.value) query = query.or(`cliente_nombre.ilike.%${dom.filterClient.value}%,cliente_box.ilike.%${dom.filterClient.value}%`);
        if (dom.filterTracking.value) query = query.ilike('tracking', `%${dom.filterTracking.value}%`);

        const st = dom.filterStatus.value;
        if (st === 'Activos') query = query.neq('estado_alerta', 'Recibido').neq('estado_alerta', 'Carta');
        else if (st !== 'Todos') query = query.eq('estado_alerta', st);

        query = query.order('created_at', { ascending: false });
        query = query.range(from, to);

        const { data, count, error } = await query;
        if (error) { console.error(error); dom.tableMsg.textContent = 'Error al cargar.'; return; }

        currentData = data || []; totalItems = count || 0; updatePaginationUI();
        renderTable(currentData);
    }

    function updatePaginationUI() {
        const totalPages = Math.ceil(totalItems / pageSize);
        dom.pageInfo.textContent = `P√°gina ${currentPage} de ${totalPages || 1} (Total: ${totalItems})`;
        dom.btnPrev.disabled = currentPage === 1; dom.btnNext.disabled = currentPage >= totalPages || totalPages === 0;
    }
    dom.btnPrev.onclick = () => { if (currentPage > 1) { currentPage--; loadPackages(); } };
    dom.btnNext.onclick = () => { const total = Math.ceil(totalItems / pageSize); if (currentPage < total) { currentPage++; loadPackages(); } };

    const liveSearch = () => { clearTimeout(searchDebounce); searchDebounce = setTimeout(() => { currentPage = 1; loadPackages(); }, 500); };
    dom.filterTracking.oninput = liveSearch; dom.filterClient.oninput = liveSearch; dom.filterSucursal.onchange = liveSearch; dom.filterStatus.onchange = liveSearch;

    function renderTable(paquetes) {
        if (!paquetes.length) { dom.tableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No se encontraron paquetes.</td></tr>'; return; }

        dom.tableBody.innerHTML = paquetes.map(p => {
            let badgeClass = 'st-pendiente';
            const est = p.estado_alerta || 'Pendiente';
            
            if (est === 'En Proceso de Aduana') badgeClass = 'st-proceso';
            else if (est === 'Recibido') badgeClass = 'st-recibido';
            else if (est === 'Miami') badgeClass = 'st-miami';
            else if (est === 'Tr√°nsito') badgeClass = 'st-transito';
            else if (est === 'Carga Peligrosa' || est === 'DG') badgeClass = 'st-dg';
            else if (est === 'Aduanas') badgeClass = 'st-aduanas';
            else if (est === 'ML') badgeClass = 'st-ml';
            else if (est === 'Carta') badgeClass = 'st-carta';

            const fecha = new Date(p.created_at).toLocaleDateString();
            const notaSafe = (p.nota || '').replace(/'/g, "\\'");
            
            let trackingDisplay = p.tracking;
            if (p.tracking_match && p.tracking_match !== p.tracking) trackingDisplay += `<br><span class="col-match">üîó ${p.tracking_match}</span>`;

            // GESTI√ìN DE ML
            let estadoHtml = `<span class="status-badge ${badgeClass}" id="badge-${p.id}">${est}</span>`;
            
            if (est === 'ML') {
                if (!p.fecha_solicitud) estadoHtml += ` <button class="btn-req" onclick="marcarSolicitado('${p.id}')"><i data-lucide="mail" width="10"></i> Solicitar</button>`;
                else {
                    const dias = Math.floor((new Date() - new Date(p.fecha_solicitud)) / (1000 * 60 * 60 * 24));
                    if (dias >= 3) estadoHtml += ` <span class="ml-status-text ml-vencido">‚ö†Ô∏è Vencido (${dias}d)</span>`;
                    else estadoHtml += ` <span class="ml-status-text ml-espera">‚è≥ Esperando (${dias}d)</span>`;
                }
            } 
            // LOGICA DEL BOTON "LLEGO"
            else {
                const statusConocidos = ['Recibido', 'En Proceso de Aduana', 'Miami', 'DG', 'Carga Peligrosa', 'Aduanas', 'ML', 'Carta'];
                if (!statusConocidos.includes(est)) {
                    if (!p.fecha_entrega_miami) {
                         estadoHtml += ` <button class="btn-req" style="background:#f59e0b" onclick="marcarLlegada('${p.id}')">üì¶ Lleg√≥?</button>`;
                    } else {
                        const dias = Math.floor((new Date() - new Date(p.fecha_entrega_miami)) / (1000 * 60 * 60 * 24));
                        estadoHtml += ` <div class="ml-status-text" style="color:#d97706">Lleg√≥ hace ${dias}d</div>`;
                    }
                }
            }

            const isRecibido = est === 'Recibido' || est === 'Carta';
            const btnClass = isRecibido ? 'btn-disabled' : 'btn-blue';
            const btnAction = isRecibido ? '' : `onclick="checkStatus('${p.id}', '${p.tracking}')"`;

            return `
                <tr id="row-${p.id}">
                    <td>
                        <div class="action-row">
                            <button type="button" class="action-btn ${btnClass}" ${btnAction} title="Verificar Status"><i data-lucide="zap" style="width:14px"></i></button>
                            <button type="button" class="action-btn btn-orange" onclick="openManualEdit('${p.id}', '${p.tracking}', '${est}', '${notaSafe}', '${p.tracking_match||''}')" title="Editar"><i data-lucide="pencil" style="width:14px"></i></button>
                            <button type="button" class="action-btn btn-red" onclick="deletePackage('${p.id}')" title="Eliminar"><i data-lucide="trash-2" style="width:14px"></i></button>
                        </div>
                    </td>
                    <td style="font-family:monospace; font-weight:600">${trackingDisplay}</td>
                    <td><div style="font-weight:600">${p.cliente_nombre}</div><div style="font-size:12px; color:#6b7280">${p.cliente_box}</div></td>
                    <td class="col-seguimiento" id="seg-${p.id}">${p.seguimiento || 'Sin info'}</td>
                    <td class="col-nota">${p.nota || ''}</td>
                    <td>${p.sucursal}</td>
                    <td>${estadoHtml}</td>
                    <td style="font-size:12px">${fecha}</td>
                </tr>
            `;
        }).join('');
        lucide.createIcons();
    }

    // --- FUNCION CLAVE: ACTUALIZACION VISUAL DIRECTA (SIN RECARGAR TABLA) ---
    function updateRowVisuals(id, nuevoEstado, nuevoDetalle) {
        const badge = document.getElementById(`badge-${id}`);
        const segText = document.getElementById(`seg-${id}`);

        if (segText) segText.textContent = nuevoDetalle;
        
        if (badge) {
            badge.textContent = nuevoEstado;
            badge.className = 'status-badge'; // reset
            
            if (nuevoEstado === 'En Proceso de Aduana') badge.classList.add('st-proceso');
            else if (nuevoEstado === 'Recibido') badge.classList.add('st-recibido');
            else if (nuevoEstado === 'Miami') badge.classList.add('st-miami');
            else if (nuevoEstado === 'Tr√°nsito') badge.classList.add('st-transito');
            else if (nuevoEstado === 'DG' || nuevoEstado === 'Carga Peligrosa') badge.classList.add('st-dg');
            else if (nuevoEstado === 'Aduanas') badge.classList.add('st-aduanas');
            else if (nuevoEstado === 'ML') badge.classList.add('st-ml');
            else if (nuevoEstado === 'Carta') badge.classList.add('st-carta');
            else badge.classList.add('st-pendiente');
        }
    }

    // --- ACCIONES ---
    window.marcarLlegada = async (id) => {
        if(!confirm("¬øConfirmar que el Carrier YA entreg√≥ este paquete?")) return;
        await supabase.from('seguimiento_interno').update({ fecha_entrega_miami: new Date().toISOString(), seguimiento: 'Marcado entregado Manualmente' }).eq('id', id);
        loadPackages();
    };

    window.deletePackage = async (id) => {
        if (!confirm("¬øEliminar paquete?")) return;
        const { error } = await supabase.from('seguimiento_interno').delete().eq('id', id);
        if (error) alert("Error: " + error.message); else loadPackages();
    };

    window.marcarSolicitado = async (id) => {
        if(!confirm("¬øConfirmar solicitud?")) return;
        await supabase.from('seguimiento_interno').update({fecha_solicitud: new Date().toISOString()}).eq('id', id);
        loadPackages();
    };

    // --- CHECK STATUS ---
    window.checkStatus = async (id, tracking, fromAuto = false) => {
        const segCell = document.getElementById(`seg-${id}`);
        if(!fromAuto && segCell) segCell.textContent = "‚è≥ Buscando...";

        try {
            const term = tracking.trim();
            const suffix = term.length > 8 ? term.slice(-8) : term;

            // 1. PRIORIDAD: TABLA PAQUETES (YA EN SUCURSAL) -> RECIBIDO
            const { data: sucMatches } = await supabase.from('paquetes').select('*').or(`tracking.ilike.%${suffix},tracking_global.ilike.%${suffix}`).limit(1);
            if (sucMatches && sucMatches.length > 0) {
                await applyMatch(id, sucMatches[0], 'Recibido'); 
                if(fromAuto) updateRowVisuals(id, 'Recibido', `‚úÖ Recibido en Sucursal: ${sucMatches[0].cliente_nombre}`);
                else loadPackages();
                return;
            }

            // 2. PRIORIDAD: TABLA CARGA -> EN PROCESO
            const { data: cargaMatches } = await supabase.from('paquetes_cargados').select('*').ilike('tracking', `%${suffix}`).limit(5);
            if (cargaMatches && cargaMatches.length > 0) {
                if (cargaMatches.length > 1 && !fromAuto) { 
                    openMatchModal(id, cargaMatches, tracking); 
                    if(segCell) segCell.textContent = "‚ö†Ô∏è M√∫ltiples opciones"; 
                    return; 
                }
                await applyMatch(id, cargaMatches[0], 'En Proceso de Aduana');
                if(fromAuto) updateRowVisuals(id, 'En Proceso de Aduana', `‚úàÔ∏è En Proceso Aduana: ${cargaMatches[0].cliente_nombre}`);
                else loadPackages();
                return;
            }

            // 3. PRIORIDAD: FUZION (EXTERNO)
            const { data, error } = await supabase.functions.invoke('trackv3', { body: { tracking: tracking } });
            if (error) throw error;

            let nuevoEstado = "Pendiente";
            let detalle = "Sin movimientos registrados";

            if (!data.history || data.error) {
                nuevoEstado = 'No Info'; detalle = 'Tracking no encontrado a√∫n';
            } else {
                const h = data.history;
                let best = {label:'No Info', ts:0};
                const candidates = [
                    {l:'ML', t:h.mal}, {l:'Aduanas', t:h.panama}, {l:'Tr√°nsito', t:h.transito}, 
                    {l:'Carga Peligrosa', t:h.dg}, {l:'Miami', t:h.miami}
                ];
                candidates.forEach(c => {
                    const time = getTimestamp(c.t);
                    if(time > best.ts) best = {label:c.l, ts:time};
                });
                nuevoEstado = best.label;
                
                if (nuevoEstado === 'ML') detalle = `üî¥ Mal Identificado`;
                else if (nuevoEstado === 'Aduanas') detalle = `üõ¨ En Aduanas`;
                else if (nuevoEstado === 'Tr√°nsito') detalle = `‚úàÔ∏è En Tr√°nsito`;
                else if (nuevoEstado === 'Carga Peligrosa') detalle = `‚ò£Ô∏è Carga Peligrosa`;
                else if (nuevoEstado === 'Miami') detalle = `üì¶ Recibido en Miami`;
            }

            await supabase.from('seguimiento_interno').update({ seguimiento: detalle, estado_alerta: nuevoEstado }).eq('id', id);
            
            if(fromAuto) updateRowVisuals(id, nuevoEstado, detalle);
            else if(document.getElementById(`row-${id}`)) loadPackages(); 

        } catch (err) { console.error(err); if(!fromAuto && segCell) segCell.textContent = "Err"; }
    };

    async function applyMatch(rowId, matchData, estadoDestino) {
        const box = matchData.cliente_box || matchData.box || "";
        const nombre = matchData.cliente_nombre || matchData.cliente || "";
        const fecha = matchData.fecha_bodega || matchData.fecha_sucursal || matchData.created_at || new Date();
        const texto = estadoDestino === 'Recibido' ? `‚úÖ Recibido en Sucursal: ${nombre}` : `‚úàÔ∏è En Proceso Aduana: ${nombre}`;
        await supabase.from('seguimiento_interno').update({ estado_alerta: estadoDestino, seguimiento: texto, cliente_box: box, tracking_match: matchData.tracking }).eq('id', rowId);
    }

    // --- MODALES ---
    window.openManualEdit = (id, tracking, estadoActual, notaActual, matchActual) => {
        dom.editId.value = id; dom.editTracking.value = tracking; dom.editEstado.value = estadoActual; dom.editNota.value = notaActual || ''; dom.editMatch.value = matchActual || ''; 
        dom.editModal.classList.remove('hidden');
    };
    window.closeEditModal = () => { dom.editModal.classList.add('hidden'); };

    window.saveManualEdit = async () => {
        const id = dom.editId.value; const newTrack = dom.editTracking.value.trim(); const newEstado = dom.editEstado.value; 
        const nota = dom.editNota.value.trim(); const match = dom.editMatch.value.trim();
        if(!newTrack) return alert("Tracking obligatorio");
        const { error } = await supabase.from('seguimiento_interno').update({ tracking: newTrack, estado_alerta: newEstado, nota: nota, tracking_match: match }).eq('id', id);
        if(error) alert("Error: " + error.message); else { closeEditModal(); loadPackages(); }
    };

    window.openMatchModal = (id, matches, tracking) => {
        dom.matchTargetId.value = id;
        dom.dispMatchTracking.textContent = tracking; 
        dom.matchList.innerHTML = matches.map((m, idx) => {
            const box = m.cliente_box || m.box || "S/Box"; const nombre = m.cliente_nombre || m.cliente || "Cliente"; const fecha = m.fecha_bodega || m.created_at || new Date();
            return `<div class="match-item" onclick="selectMatch(${idx})"><div class="match-title">${m.tracking}</div><div class="match-sub"><span class="match-highlight">${nombre} (${box})</span></div><div class="match-sub">${new Date(fecha).toLocaleString()}</div></div>`;
        }).join('');
        dom.matchList.dataset.matches = JSON.stringify(matches); dom.matchModal.classList.remove('hidden');
    };
    window.closeMatchModal = () => { dom.matchModal.classList.add('hidden'); };
    window.selectMatch = async (index) => {
        const id = dom.matchTargetId.value; const matches = JSON.parse(dom.matchList.dataset.matches);
        if (matches[index]) { await applyMatch(id, matches[index], 'En Proceso de Aduana'); closeMatchModal(); loadPackages(); }
    };

    // Listeners
    dom.filterTracking.oninput = liveSearch; dom.filterClient.oninput = liveSearch; dom.filterSucursal.onchange = liveSearch; dom.filterStatus.onchange = liveSearch;
    
    // BOTON MANUAL (RAYITO)
    window.runManualScan = async () => {
        if(!confirm("¬øIniciar actualizaci√≥n manual ahora?")) return;
        autoUpdateRoutine(true); // Forzar ejecucion
    };

    // --- NUEVO: AUTO-UPDATE (60s) + BARRA PROGRESO ---
    window.toggleAutoUpdate = () => {
        isAutoUpdateActive = !isAutoUpdateActive;
        const btn = dom.btnToggleAuto;
        if (isAutoUpdateActive) {
            btn.textContent = "‚ö° Auto: ON (60s)";
            btn.classList.remove('btn-auto-off'); btn.classList.add('btn-auto-on');
            autoUpdateRoutine(); 
            autoUpdateInterval = setInterval(autoUpdateRoutine, 60000); 
        } else {
            btn.textContent = "‚è∏Ô∏è Auto: OFF";
            btn.classList.remove('btn-auto-on'); btn.classList.add('btn-auto-off');
            clearInterval(autoUpdateInterval);
            dom.scanLine.style.display = 'none';
            dom.scanLine.style.width = '0%';
            dom.tableMsg.textContent = "";
        }
    };

    async function autoUpdateRoutine(manual = false) {
        const source = manual ? "Manual" : "Auto";
        console.log(`‚ö° ${source}-Scan iniciado...`);
        
        dom.scanLine.style.display = 'block'; 
        dom.scanLine.style.width = '5%'; // Iniciar barra
        dom.tableMsg.textContent = "‚ö° Buscando paquetes...";

        // Traer pendientes (Max 50)
        const { data: pends } = await supabase
            .from('seguimiento_interno')
            .select('*')
            .neq('estado_alerta', 'Recibido')
            .neq('estado_alerta', 'Carta')
            .limit(50);
            
        if(pends && pends.length > 0) {
            const total = pends.length;
            for(let i=0; i < total; i++) {
                const p = pends[i];
                
                // ACTUALIZAR PROGRESO TEXTUAL
                dom.tableMsg.textContent = `‚ö° ${source}: Revisando ${i+1} de ${total} (${p.tracking})...`;
                
                // ACTUALIZAR BARRA
                const pct = Math.round(((i+1)/total)*100);
                dom.scanLine.style.width = `${pct}%`;

                // REVISAR
                await checkStatus(p.id, p.tracking, true);
                await new Promise(r => setTimeout(r, 800)); // Pausa
            }
            
            // Finalizado el lote
            dom.tableMsg.textContent = `‚úÖ ${source}-Scan completado (${total} paquetes).`;
            
            // Si es manual, refrescamos la lista entera al final para asegurar
            if(manual) loadPackages(); 
            
        } else {
            dom.tableMsg.textContent = "‚úÖ No hay paquetes pendientes.";
            dom.scanLine.style.width = '100%';
        }
        
        // Limpiar mensaje despues de 3s
        setTimeout(() => { 
            if(isAutoUpdateActive && !manual) dom.tableMsg.textContent = "üí§ Esperando siguiente ciclo..."; 
            else dom.tableMsg.textContent = "";
            
            dom.scanLine.style.display = 'none';
            dom.scanLine.style.width = '0%';
        }, 3000);
    }

</script>
</body>
</html>
