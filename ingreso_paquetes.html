<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Ingreso Paquetes â€” PSC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>ðŸ“¦</text></svg>" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script src="config.js"></script>

    <style>
      :root {
        --bg: #f9fafb; --fg: #111827; --muted: #6b7280; --border: #e5e7eb;
        --card: #ffffff; --primary: #2563eb; --primary-hover: #1d4ed8;
        --radius: 12px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      }
      * { box-sizing: border-box; }
      body { margin: 0; background: var(--bg); color: var(--fg); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; }
      
      .wrap { width: 100%; max-width: 500px; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 32px 24px; }
      .title { font-size: 24px; font-weight: 700; text-align: center; margin: 0 0 8px 0; color: #111827; }
      .subtitle { color: var(--muted); text-align: center; margin: 0 0 24px 0; font-size: 14px; }
      
      .field { margin-bottom: 20px; position: relative; }
      .label { display: block; font-weight: 600; font-size: 14px; margin-bottom: 6px; color: #374151; }
      
      input[type="text"] {
        width: 100%; height: 48px; padding: 0 16px; border: 1px solid var(--border);
        border-radius: 8px; font-size: 16px; transition: all 0.2s; outline: none;
      }
      input[type="text"]:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
      input[readonly] { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }

      .btn {
        width: 100%; height: 48px; background: var(--primary); color: white;
        border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
        cursor: pointer; transition: background 0.2s;
      }
      .btn:hover { background: var(--primary-hover); }
      .btn:disabled { opacity: 0.7; cursor: wait; }

      /* Estilos del Autocomplete */
      .autocomplete-suggestions {
        position: absolute; top: 100%; left: 0; right: 0;
        border: 1px solid var(--border); background-color: white;
        max-height: 200px; overflow-y: auto; z-index: 50;
        border-radius: 0 0 8px 8px; box-shadow: var(--shadow);
        display: none; /* Oculto por defecto */
      }
      .suggestion-item { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-size: 14px; }
      .suggestion-item:last-child { border-bottom: none; }
      .suggestion-item:hover { background-color: #eff6ff; color: var(--primary); }
      .suggestion-item strong { display: block; color: #111827; }
      .suggestion-item span { color: var(--muted); font-size: 12px; }

      /* Tarjeta de Info Cliente Seleccionado */
      .client-info-card {
        background-color: #eff6ff; border: 1px solid #bfdbfe; border-radius: 8px;
        padding: 12px; margin-bottom: 20px; display: none;
      }
      .client-info-card.active { display: block; }
      .client-info-row { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
      .client-info-label { color: #60a5fa; font-weight: 600; }
      .client-info-val { color: #1e40af; font-weight: 700; }

      .status-msg { text-align: center; margin-top: 16px; font-size: 14px; font-weight: 500; min-height: 20px; }
      .status-msg.success { color: #059669; }
      .status-msg.error { color: #dc2626; }
      .status-msg.normal { color: #2563eb; }
    </style>
</head>
<body>

<div class="wrap">
    <div class="card">
        <h1 class="title">Registro Interno</h1>
        <p class="subtitle">Ingresa tracking y asigna cliente.</p>

        <form id="formIngreso">
            <div class="field">
                <label class="label">Tracking Number</label>
                <input type="text" id="tracking" placeholder="Escanea o escribe..." required autocomplete="off">
            </div>

            <div class="field">
                <label class="label">Buscar Cliente</label>
                <input type="text" id="clienteSearch" placeholder="Nombre o Casillero..." autocomplete="off">
                <div id="suggestions" class="autocomplete-suggestions"></div>
            </div>

            <div id="clientInfo" class="client-info-card">
                <div class="client-info-row">
                    <span class="client-info-label">Nombre:</span>
                    <span class="client-info-val" id="dispNombre">-</span>
                </div>
                <div class="client-info-row">
                    <span class="client-info-label">Casillero:</span>
                    <span class="client-info-val" id="dispBox">-</span>
                </div>
                <div class="client-info-row">
                    <span class="client-info-label">Sucursal:</span>
                    <span class="client-info-val" id="dispSucursal">-</span>
                </div>
            </div>

            <input type="hidden" id="h_nombre">
            <input type="hidden" id="h_box">
            <input type="hidden" id="h_sucursal">

            <button type="submit" class="btn" id="btnGuardar">Guardar Paquete</button>
            <div id="status" class="status-msg"></div>
        </form>
    </div>
</div>

<script>
    // --- 1. CONFIGURACIÃ“N SUPABASE ---
    // Verificamos que config.js cargÃ³ correctamente
    if (typeof window.PSC_CONFIG === 'undefined') {
        alert("Error crÃ­tico: No se encontrÃ³ 'window.PSC_CONFIG'. Verifica que 'config.js' estÃ© en la misma carpeta y cargado correctamente.");
    }

    // Usamos las variables EXACTAS de tu archivo config.js
    const SUPABASE_URL = window.PSC_CONFIG.supabaseUrl;
    const SUPABASE_KEY = window.PSC_CONFIG.supabaseAnonKey;
    
    // Inicializamos el cliente
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- 2. ELEMENTOS DOM ---
    const ui = {
        tracking: document.getElementById('tracking'),
        search: document.getElementById('clienteSearch'),
        suggestions: document.getElementById('suggestions'),
        clientCard: document.getElementById('clientInfo'),
        dispNombre: document.getElementById('dispNombre'),
        dispBox: document.getElementById('dispBox'),
        dispSucursal: document.getElementById('dispSucursal'),
        h_nombre: document.getElementById('h_nombre'),
        h_box: document.getElementById('h_box'),
        h_sucursal: document.getElementById('h_sucursal'),
        form: document.getElementById('formIngreso'),
        status: document.getElementById('status'),
        btn: document.getElementById('btnGuardar')
    };

    let selectedClient = null;

    // --- 3. LÃ“GICA DE BÃšSQUEDA ---
    ui.search.addEventListener('input', async (e) => {
        const term = e.target.value.trim();
        
        if (term.length < 2) {
            ui.suggestions.style.display = 'none';
            return;
        }

        // Usamos la misma funciÃ³n RPC que usa RAYO App
        const { data, error } = await supabase.rpc('buscar_clientes_flex', { search_term: term });

        if (error || !data || data.length === 0) {
            ui.suggestions.style.display = 'none';
            return;
        }

        ui.suggestions.innerHTML = data.map(c => `
            <div class="suggestion-item" onclick='selectClient(${JSON.stringify(c)})'>
                <strong>${c.nombre}</strong>
                <span>Box: ${c.box} | Suc: ${c.sucursal || 'Centro'}</span>
            </div>
        `).join('');
        
        ui.suggestions.style.display = 'block';
    });

    // --- 4. SELECCIONAR CLIENTE ---
    window.selectClient = (cliente) => {
        selectedClient = cliente;
        
        // Llenar visualmente
        ui.search.value = `${cliente.nombre} (${cliente.box})`;
        ui.dispNombre.textContent = cliente.nombre;
        ui.dispBox.textContent = cliente.box;
        ui.dispSucursal.textContent = cliente.sucursal || 'Centro'; 

        // Llenar datos ocultos
        ui.h_nombre.value = cliente.nombre;
        ui.h_box.value = cliente.box;
        ui.h_sucursal.value = cliente.sucursal || 'Centro';

        // Mostrar tarjeta y ocultar lista
        ui.clientCard.classList.add('active');
        ui.suggestions.style.display = 'none';
    };

    // Ocultar sugerencias al hacer click fuera
    document.addEventListener('click', (e) => {
        if (!ui.search.contains(e.target) && !ui.suggestions.contains(e.target)) {
            ui.suggestions.style.display = 'none';
        }
    });

    // --- 5. GUARDAR EN DB (TABLA NUEVA) ---
    ui.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        ui.status.textContent = '';
        ui.status.className = 'status-msg';

        const tracking = ui.tracking.value.trim();
        if (tracking.length < 3) {
            setStatus('El tracking es muy corto.', 'error');
            return;
        }
        if (!selectedClient) {
            setStatus('Debes buscar y seleccionar un cliente.', 'error');
            return;
        }

        ui.btn.disabled = true;
        setStatus('Guardando...', 'normal');

        // Insertamos en la tabla 'seguimiento_interno'
        const { data, error } = await supabase
            .from('seguimiento_interno')
            .insert([
                {
                    tracking: tracking,
                    cliente_nombre: ui.h_nombre.value,
                    cliente_box: ui.h_box.value,
                    sucursal: ui.h_sucursal.value,
                    estado_alerta: 'Pendiente'
                }
            ]);

        ui.btn.disabled = false;

        if (error) {
            console.error("Error Supabase:", error);
            setStatus('Error al guardar: ' + error.message, 'error');
        } else {
            setStatus('Paquete guardado correctamente âœ…', 'success');
            
            // Limpiar solo el tracking para seguir registrando al mismo cliente si se desea
            ui.tracking.value = '';
            ui.tracking.focus();
            
            // Si prefieres que se borre el cliente tambiÃ©n, descomenta la siguiente lÃ­nea:
            // resetClient();
        }
    });

    function setStatus(msg, type) {
        ui.status.textContent = msg;
        ui.status.className = `status-msg ${type}`;
    }

    function resetClient() {
        selectedClient = null;
        ui.search.value = '';
        ui.clientCard.classList.remove('active');
        ui.h_nombre.value = '';
        ui.h_box.value = '';
        ui.h_sucursal.value = '';
    }
</script>

</body>
</html>
