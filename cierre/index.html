<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>PSC Cierre — Config básica</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:#f7f7f8;color:#111}
  .wrap{max-width:1024px;margin:0 auto;padding:20px}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 6px 18px rgba(0,0,0,.05)}
  h1{font-size:22px;margin:0 0 8px}h2{font-size:18px;margin:0 0 8px}.row{display:flex;gap:10px;flex-wrap:wrap}
  input,button,select{font:inherit}input,select{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
  button{padding:10px 14px;border:1px solid #e5e7eb;border-radius:10px;background:#111;color:#fff;cursor:pointer}
  button.ghost{background:#fff;color:#111}
  .list{border-top:1px dashed #e5e7eb;margin-top:8px}
  .item{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #e5e7eb}
  .tag{display:inline-flex;padding:2px 8px;border-radius:999px;border:1px solid #e5e7eb;font-size:12px;background:#fff}
  .hint{font-size:12px;color:#6b7280}.hidden{display:none}
</style>
<script src="https://esm.sh/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <h1>PSC Cierre — Config básica</h1>

  <div class="card">
    <h2>Acceso</h2>
    <div class="row">
      <div style="flex:1 1 280px"><input id="email" type="email" value="test@test.com"></div>
      <div style="flex:1 1 200px"><input id="password" type="password" value="test"></div>
      <div><button id="btnLogin">Entrar</button></div>
      <div><button class="ghost" id="btnLogout">Salir</button></div>
    </div>
    <p class="hint" id="who"></p>
  </div>

  <div id="admin" class="hidden">
    <div class="card">
      <h2>Sucursales</h2>
      <div class="row">
        <div style="flex:1 1 280px"><input id="sucursalNombre" placeholder="Nueva sucursal (ej. Sucursal 1)"></div>
        <div><button id="btnAddSucursal">Añadir</button></div>
      </div>
      <div id="sucursales" class="list"></div>
    </div>

    <div class="card">
      <h2>Sistemas</h2>
      <div class="row">
        <div style="flex:1 1 280px"><input id="sistemaNombre" placeholder="Nuevo sistema (ej. Sistema 1)"></div>
        <div><button id="btnAddSistema">Añadir</button></div>
      </div>
      <div id="sistemas" class="list"></div>
    </div>
  </div>
</div>

  <!-- ==== MÉTODOS DE PAGO ==== -->
<div class="card">
  <h2>Métodos de pago</h2>
  <div class="row">
    <div style="flex:1 1 280px">
      <input id="mpNombre" placeholder="Nuevo método (ej. Efectivo)">
    </div>
    <div style="width:140px">
      <input id="mpOrden" type="number" min="1" value="100" placeholder="Orden">
    </div>
    <div><button id="btnAddMP">Añadir</button></div>
  </div>
  <div id="metodosPago" class="list"></div>
</div>

<!-- ==== DENOMINACIONES ==== -->
<div class="card">
  <h2>Denominaciones</h2>
  <div class="row">
    <div style="width:160px">
      <input id="denValor" type="number" step="0.01" min="0.01" placeholder="Valor (ej. 0.25)">
    </div>
    <div style="width:160px">
      <select id="denTipo">
        <option value="moneda">moneda</option>
        <option value="billete">billete</option>
      </select>
    </div>
    <div style="width:140px">
      <input id="denOrden" type="number" min="1" value="100" placeholder="Orden">
    </div>
    <div><button id="btnAddDen">Añadir</button></div>
  </div>
  <div id="denominaciones" class="list"></div>
</div>


<script>
  // <<<<<< PON TUS CLAVES REALES AQUÍ >>>>>
  const SUPABASE_URL = "https://ztdkaxbgpogudtrdgzic.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZGtheGJncG9ndWR0cmRnemljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDE2MDYsImV4cCI6MjA3MDQxNzYwNn0.mpjY5nWiS48O0DAUkCL7Jl6agF6LurNGeaY8d1u70Po";
  // <<<<<< FIN CONFIG >>>>>

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, { db: { schema: 'cierre' } });

  const $ = (id)=>document.getElementById(id);
  const who = $("who"); const adminArea = $("admin");

  async function refresh(){
    const { data: { user } } = await supabase.auth.getUser();
    if(!user){ who.textContent="No conectado"; adminArea.classList.add("hidden"); return; }
    who.textContent = "Conectado: " + user.email;
    adminArea.classList.remove("hidden");
    await loadLists();
  }

  $("btnLogin").onclick = async ()=>{
    const { error } = await supabase.auth.signInWithPassword({ email: $("email").value.trim(), password: $("password").value });
    if(error){ alert(error.message); return; }
    await refresh();
  };
  $("btnLogout").onclick = async ()=>{ await supabase.auth.signOut(); await refresh(); };

  async function loadLists(){
    // Sucursales
    const sc = $("sucursales"); sc.innerHTML="";
    let r1 = await supabase.from("sucursales").select("*").order("created_at",{ascending:true});
    if(r1.error){ sc.innerHTML = '<div class="hint">Error: '+r1.error.message+'</div>'; } else {
      (r1.data||[]).forEach(r=>{
        const d=document.createElement("div"); d.className="item";
        d.innerHTML=`<div><strong>${r.nombre}</strong></div>
                     <div><button class="ghost" data-id="${r.id}" data-type="sucursal-del">Eliminar</button></div>`;
        sc.appendChild(d);
      });
    }

    <script>
  // ====== LISTADOS ======
  async function loadMetodosPago() {
    const cont = document.getElementById("metodosPago"); cont.innerHTML = "";
    const { data, error } = await supabase.from("metodos_pago").select("*").order("orden",{ascending:true});
    if (error) { cont.innerHTML = `<div class="hint">Error: ${error.message}</div>`; return; }
    (data||[]).forEach(r=>{
      const d = document.createElement("div"); d.className="item";
      d.innerHTML = `<div><strong>${r.nombre}</strong> <span class="tag">orden ${r.orden}</span></div>
                     <div><button class="ghost" data-type="mp-del" data-id="${r.id}">Eliminar</button></div>`;
      cont.appendChild(d);
    });
  }

  async function loadDenominaciones() {
    const cont = document.getElementById("denominaciones"); cont.innerHTML = "";
    const { data, error } = await supabase.from("denominaciones").select("*").order("orden",{ascending:true});
    if (error) { cont.innerHTML = `<div class="hint">Error: ${error.message}</div>`; return; }
    (data||[]).forEach(r=>{
      const d = document.createElement("div"); d.className="item";
      d.innerHTML = `<div><strong>${Number(r.valor).toFixed(2)}</strong> <span class="tag">${r.tipo}</span> <span class="tag">orden ${r.orden}</span></div>
                     <div><button class="ghost" data-type="den-del" data-id="${r.id}">Eliminar</button></div>`;
      cont.appendChild(d);
    });
  }

  // Llama a tus loads existentes + estos dos
  async function loadAll() {
    await loadLists();           // <-- tu función que ya carga sucursales/sistemas
    await loadMetodosPago();
    await loadDenominaciones();
  }

  // ====== INSERTAR ======
  document.getElementById("btnAddMP").onclick = async ()=>{
    const nombre = document.getElementById("mpNombre").value.trim();
    const orden  = parseInt(document.getElementById("mpOrden").value || "100", 10);
    if (!nombre) return alert("Ingresa un nombre");
    const { error } = await supabase.from("metodos_pago").insert({ nombre, orden });
    if (error) return alert(error.message);
    document.getElementById("mpNombre").value = ""; document.getElementById("mpOrden").value = "100";
    await loadMetodosPago();
  };

  document.getElementById("btnAddDen").onclick = async ()=>{
    const valor = parseFloat(document.getElementById("denValor").value);
    const tipo  = document.getElementById("denTipo").value;
    const orden = parseInt(document.getElementById("denOrden").value || "100", 10);
    if (!valor || valor <= 0) return alert("Valor inválido");
    const { error } = await supabase.from("denominaciones").insert({
      valor: Number(valor.toFixed(2)), tipo, orden
    });
    if (error) return alert(error.message);
    document.getElementById("denValor").value = ""; document.getElementById("denOrden").value = "100";
    await loadDenominaciones();
  };

  // ====== ELIMINAR (delegado) ======
  document.addEventListener("click", async (e)=>{
    const t = e.target; if(!(t instanceof HTMLElement)) return;
    const type = t.getAttribute("data-type"), id = t.getAttribute("data-id");
    if (type === "mp-del" && id) {
      if (!confirm("¿Eliminar método de pago?")) return;
      const { error } = await supabase.from("metodos_pago").delete().eq("id", id);
      if (error) return alert(error.message);
      await loadMetodosPago();
    }
    if (type === "den-del" && id) {
      if (!confirm("¿Eliminar denominación?")) return;
      const { error } = await supabase.from("denominaciones").delete().eq("id", id);
      if (error) return alert(error.message);
      await loadDenominaciones();
    }
  });

  // Llama loadAll() después de loguearte (donde antes llamabas refresh/loadLists)
  // Por ejemplo, en tu flujo:
  //   - tras login OK -> await loadAll();
  //   - al entrar con sesión ya iniciada -> await loadAll();
</script>

    // Sistemas
    const si = $("sistemas"); si.innerHTML="";
    let r2 = await supabase.from("sistemas").select("*").order("created_at",{ascending:true});
    if(r2.error){ si.innerHTML = '<div class="hint">Error: '+r2.error.message+'</div>'; } else {
      (r2.data||[]).forEach(r=>{
        const d=document.createElement("div"); d.className="item";
        d.innerHTML=`<div><strong>${r.nombre}</strong></div>
                     <div><button class="ghost" data-id="${r.id}" data-type="sistema-del">Eliminar</button></div>`;
        si.appendChild(d);
      });
    }
  }

  document.addEventListener("click", async (ev)=>{
    const t = ev.target; if(!(t instanceof HTMLElement)) return;
    const typ = t.getAttribute("data-type"); const id = t.getAttribute("data-id");
    if(typ==="sucursal-del" && id){
      if(!confirm("¿Eliminar sucursal?")) return;
      const { error } = await supabase.from("sucursales").delete().eq("id", id);
      if(error) return alert(error.message);
      await loadLists();
    }
    if(typ==="sistema-del" && id){
      if(!confirm("¿Eliminar sistema?")) return;
      const { error } = await supabase.from("sistemas").delete().eq("id", id);
      if(error) return alert(error.message);
      await loadLists();
    }
  });

  $("btnAddSucursal").onclick = async ()=>{
    const nombre = $("sucursalNombre").value.trim();
    if(!nombre) return alert("Ingresa un nombre");
    const { error } = await supabase.from("sucursales").insert({ nombre });
    if(error) return alert(error.message);
    $("sucursalNombre").value="";
    await loadLists();
  };
  $("btnAddSistema").onclick = async ()=>{
    const nombre = $("sistemaNombre").value.trim();
    if(!nombre) return alert("Ingresa un nombre");
    const { error } = await supabase.from("sistemas").insert({ nombre });
    if(error) return alert(error.message);
    $("sistemaNombre").value="";
    await loadLists();
  };

  refresh();
</script>
</body>
</html>
