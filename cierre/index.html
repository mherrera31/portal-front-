<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PSC Cierre • Cierre de Caja</title>
    <link rel="icon" href="data:," />
    <style>
      :root {
        --bg: #f6f7fb;
        --bg2: #eef2f7;
        --card: #fff;
        --border: #e5e7eb;
        --muted: #6b7280;
        --fg: #111827;
        --accent: #10b981;
        --warn: #f59e0b;
        --err: #ef4444;
        --ok: #059669;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto,
          Ubuntu;
        background: linear-gradient(180deg, var(--bg), var(--bg2));
        color: var(--fg);
      }
      .wrap {
        max-width: 1240px;
        margin: 0 auto;
        padding: 24px;
      }
      h1,
      h2,
      h3 {
        margin: 0 0 12px;
      }
      h1 {
        font-size: 22px;
      }
      h2 {
        font-size: 18px;
        color: #1f2937;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
        margin: 14px 0;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .col {
        flex: 1 1 260px;
      }
      label {
        display: block;
        font-size: 13px;
        color: var(--muted);
        margin-bottom: 6px;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        color: var(--fg);
        outline: 0;
      }
      input:focus,
      select:focus,
      textarea:focus {
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
        border-color: #a7f3d0;
      }
      textarea {
        min-height: 90px;
      }
      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0 8px;
      }
      th,
      td {
        text-align: left;
        padding: 8px 10px;
      }
      th {
        font-size: 12px;
        color: #4b5563;
      }
      tr {
        background: #f9fafb;
        border-radius: 10px;
        border: 1px solid var(--border);
      }
      tr td:first-child {
        border-top-left-radius: 10px;
        border-bottom-left-radius: 10px;
      }
      tr td:last-child {
        border-top-right-radius: 10px;
        border-bottom-right-radius: 10px;
      }
      .btn {
        appearance: none;
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 12px;
        padding: 10px 14px;
        cursor: pointer;
        transition: all 0.15s ease;
        font-weight: 600;
      }
      .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      }
      .btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: #fff;
      }
      .btn.danger {
        background: var(--err);
        border-color: var(--err);
        color: #fff;
      }
      .muted {
        color: var(--muted);
      }
      .ok {
        color: var(--ok);
      }
      .bad {
        color: var(--err);
      }
      .layout {
        display: grid;
        grid-template-columns: 260px 1fr;
        gap: 16px;
      }
      .menu a {
        display: block;
        padding: 10px 12px;
        border: 1px solid var(--border);
        border-radius: 12px;
        margin: 6px 0;
        text-decoration: none;
        color: #111827;
        background: #fff;
      }
      .menu a.active {
        outline: 2px solid #a7f3d0;
        background: #f0fdf4;
      }
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 14px;
      }
      .right {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .tag {
        font-size: 12px;
        color: #111827;
        padding: 4px 8px;
        background: #f3f4f6;
        border: 1px solid var(--border);
        border-radius: 999px;
      }
      .kpi {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        background: #fff;
        min-width: 160px;
      }
      .kpi small {
        color: var(--muted);
      }
      .grid {
        display: grid;
        gap: 12px;
      }
      .toast {
        position: fixed;
        right: 20px;
        bottom: 20px;
        background: #111827;
        color: #fff;
        padding: 10px 12px;
        border-radius: 10px;
        box-shadow: 0 10px 18px rgba(0, 0, 0, 0.2);
        z-index: 999;
      }
      /* Apertura/Saldo Final layout */
      .ap-head {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        margin-bottom: 8px;
      }
      .ap-total {
        display: flex;
        gap: 8px;
        align-items: baseline;
        padding: 6px 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.04);
      }
      .ap-total strong {
        font-size: 1.1rem;
      }
      table.ap {
        width: 100%;
      }
      .apSub {
        font-weight: 600;
        text-align: right;
        font-variant-numeric: tabular-nums;
      }
      .actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 12px;
      }
      .section-title {
        margin-top: 6px;
        margin-bottom: 4px;
        color: #6b7280;
        font-weight: 600;
      }
      .pill {
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #fff;
        font-size: 12px;
      }
      .flex {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        border: 1px solid var(--border);
        background: #fff;
        font-size: 12px;
      }
      .right-align {
        text-align: right;
      }
      /* Estilo para los códigos de sección */
      .code {
        font-size: 11px;
        font-weight: normal;
        color: #9ca3af;
        margin-right: 8px;
        user-select: none;
      }
    </style>

    <script src="./config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  </head>
  <body>
    <div class="wrap">
      <div class="header">
        <div class="flex">
          <img
            src="https://i.postimg.cc/L8w6XpRT/PSC-AVION.webp"
            alt="logo"
            style="width: 28px; height: 28px; border-radius: 6px"
          />
          <div>
            <div style="font-weight: 800">PSC Cargas</div>
            <div class="muted" style="font-size: 12px">
              Portal de Cierre (demo sin DB)
            </div>
          </div>
        </div>
        <div class="right" id="sessionBox"></div>
      </div>

      <div class="layout">
        <aside class="card">
          <h3><span class="code">[C-00]</span> Menú</h3>
          <nav id="nav" class="menu">
            <a href="#/mod-inicio">Inicio de jornada</a>
            <a href="#/mod-apertura">Saldo inicial</a>
            <a href="#/mod-ingresos">Ingresos (sistemas)</a>
            <a href="#/mod-sfinal">Saldo final</a>
            <a href="#/mod-vouchers">Vouchers</a>
            <a href="#/mod-delivery">Delivery</a>
            <a href="#/mod-gastos">Gastos</a>
            <a href="#/mod-compras">Compras</a>
            <a href="#/mod-precheck">Precheck</a>
            <a href="#/mod-deposito">Depósito</a>
            <a href="#/mod-cierre">Cierre</a>
            <a href="#/mod-panel">Panel de jornadas</a>
            <a href="#/mod-usuarios">Usuarios (admin)</a>
            <a href="#/mod-config">Configuración</a>
          </nav>
        </aside>
        <main id="content"></main>
      </div>
    </div>

    <script>
      /* ========================= Util UI ========================= */

      /* ============= Estado global (sin demo) ============= */
      window.S = window.S || {
        currentUser: null,
        config: { sucursales: [], metodos: [], gasto_categorias: [] },
        jornada: null,
      };
      // NO-OP: mientras migramos módulos que aún llaman save(...)
      window.save =
        window.save ||
        function () {
          /* eliminado modo demo */
        };

      /* ========================= Util UI ========================= */
      const qs = (s, el = document) => el.querySelector(s);
      const qsa = (s, el = document) => Array.from(el.querySelectorAll(s));
      function el(html) {
        const t = document.createElement("template");
        t.innerHTML = html.trim();
        return t.content.firstChild;
      }
      function money(n) {
        return Number(n || 0).toLocaleString("en-US", {
          style: "currency",
          currency: "USD",
        });
      }
      function toast(msg, kind) {
        const d = el(
          `<div class="toast" style="${
            kind === "err" ? "background:#b91c1c" : ""
          }">${msg}</div>`
        );
        document.body.appendChild(d);
        setTimeout(() => d.remove(), 2400);
      }
      function setActive(href) {
        qsa("#nav a").forEach((a) =>
          a.classList.toggle("active", a.getAttribute("href") === href)
        );
      }

      /* ========================= Session Box ========================= */
      function renderSession() {
        const box = qs("#sessionBox");
        if (!box) return;
        if (!S.currentUser) {
          box.innerHTML = '<span class="tag">No has iniciado sesión</span>';
          return;
        }
        const u = S.currentUser;
        const role = u.role?.[0]?.toUpperCase() + u.role?.slice(1);
        const suc = u.sucursal || "—";

        if (u.role === "admin") {
          const opts = (S.config?.sucursales || [])
            .map(
              (s) =>
                `<option value="${s.id}" ${
                  s.id === u.sucursal_id ? "selected" : ""
                }>${s.nombre}</option>`
            )
            .join("");
          box.innerHTML = `<span class="muted">Rol:</span> <span class="tag">${role}</span>
                       <span class="muted">Usuario:</span> <span class="tag">${u.email}</span>
                       <label style="margin-left:8px" class="muted">Sucursal</label>
                       <select id="selSucursal" style="padding:6px 8px;border-radius:10px;border:1px solid var(--border)">${opts}</select>
                       <button class="btn" id="btnLogout">Salir</button>`;
          qs("#selSucursal").onchange = async (ev) => {
            const id = ev.target.value || null;
            try {
              await openJornadaForToday(id);
              S.currentUser.sucursal_id = id;
              const ss = (S.config?.sucursales || []).find((x) => x.id === id);
              S.currentUser.sucursal = ss?.nombre || "—";
              renderSession();
              toast("Sucursal cambiada");
            } catch (e) {
              toast(e.message || String(e), "err");
            }
          };
        } else {
          box.innerHTML = `<span class="muted">Rol:</span> <span class="tag">${role}</span>
                       <span class="muted">Usuario:</span> <span class="tag">${u.email}</span>
                       <span class="muted">Sucursal:</span> <span class="tag">${suc}</span>
                       <button class="btn" id="btnLogout">Salir</button>`;
        }
        qs("#btnLogout").onclick = async () => {
          try {
            await window._sb?.auth?.signOut();
          } catch {}
          S.currentUser = null;
          S.jornada = null;
          location.hash = "#/login";
        };
      }

      /* ========================= Router ========================= */
      window.addEventListener("hashchange", route);
      async function route() {
        const hash = location.hash || "#/login";
        setActive(hash);

        // Guard: si no hay sesión, siempre login
        if (hash === "#/login" || !S.currentUser) return renderLogin();

        switch (hash) {
          case "#/mod-inicio":
            return renderInicio();
          case "#/mod-apertura":
            return renderApertura();
          case "#/mod-ingresos":
            return renderIngresos();
          case "#/mod-sfinal":
            return renderSFinal();
          case "#/mod-vouchers":
            return renderVouchers();
          case "#/mod-delivery":
            return renderDelivery();
          case "#/mod-gastos":
            return renderGastos();
          case "#/mod-compras":
            return renderCompras();
          case "#/mod-precheck":
            return renderPrecheck();
          case "#/mod-deposito":
            return renderDeposito();
          case "#/mod-cierre":
            return renderCierre();
          case "#/mod-panel":
            return renderPanel();
          case "#/mod-usuarios":
            return renderUsuarios();
          case "#/mod-config":
            return renderConfig();
          default:
            return renderInicio();
        }
      }

      /* ========================= Login ========================= */
      function renderLogin() {
        renderSession(); // pinta "No has iniciado sesión"
        const v = qs("#content");
        if (!v) return console.error("No existe #content en el DOM.");

        v.innerHTML = `
      <div class="card">
        <h2><span class="code">[C-01]</span> Entrar</h2>
        <div class="row">
          <div class="col">
            <label>Email</label>
            <input id="lgEmail" type="email" placeholder="tucorreo@dominio.com">
            <label>Contraseña</label>
            <input id="lgPass" type="password" placeholder="••••••••">
            <div style="margin-top:12px">
              <button class="btn primary" id="btnLogin" type="button">Entrar (Supabase)</button>
            </div>
            <div class="muted" id="loginMsg" style="margin-top:8px"></div>
          </div>
          <div class="col">
            <div class="muted">Inicia sesión con tu usuario de PSC. Si olvidaste tu contraseña, un admin puede restablecerla.</div>
          </div>
        </div>
      </div>
    `;

        const btn = qs("#btnLogin", v);
        const pass = qs("#lgPass", v);
        const emailEl = qs("#lgEmail", v);
        const msg = qs("#loginMsg", v);

        pass.addEventListener("keydown", (e) => {
          if (e.key === "Enter") btn.click();
        });

        btn.onclick = async () => {
          const email = emailEl.value.trim().toLowerCase();
          const password = pass.value;
          msg.textContent = "";

          if (!email || !password)
            return (msg.textContent = "Ingresa correo y contraseña.");
          if (!window._sb?.auth)
            return (msg.textContent = "Supabase no inicializado.");

          btn.disabled = true;
          try {
            const { error } = await window._sb.auth.signInWithPassword({
              email,
              password,
            });
            if (error) throw error;

            const {
              data: { session },
            } = await window._sb.auth.getSession();
            const token = session?.access_token;
            if (!token) throw new Error("No se obtuvo token de sesión.");

            // Perfil
            const pr = await fetch(
              `${window.PSC_CONFIG.functionsBase}/get-profile`,
              {
                headers: { Authorization: "Bearer " + token },
              }
            );
            const prof = await pr.json();
            if (!pr.ok)
              throw new Error(prof?.error || "No se pudo leer perfil");

            S.currentUser = {
              id: prof.id,
              email: prof.email,
              role: prof.role,
              sucursal_id: prof.sucursal_id,
              sucursal: prof.sucursal,
            };

            // Config básica (sucursales, métodos, gasto_categorias)
            await ensureConfig();

            // Jornada del día si tiene sucursal
            if (S.currentUser.sucursal_id) {
              await openJornadaForToday(S.currentUser.sucursal_id);
            }

            renderSession();
            location.hash = "#/mod-inicio";
          } catch (e) {
            msg.textContent = e.message || String(e);
          } finally {
            btn.disabled = false;
          }
        };
      }

      /* ========================= Boot (arranque) ========================= */
      document.addEventListener("DOMContentLoaded", boot);
      async function boot() {
        // Si no hay hash, fuerza login
        if (!location.hash) location.hash = "#/login";

        // (opcional) crear cliente si aún no existe y tienes credenciales en config.js
        try {
          if (
            !window._sb &&
            window.supabase &&
            window.PSC_CONFIG?.supabaseUrl &&
            window.PSC_CONFIG?.supabaseAnonKey
          ) {
            window._sb = window.supabase.createClient(
              window.PSC_CONFIG.supabaseUrl,
              window.PSC_CONFIG.supabaseAnonKey
            );
          }
        } catch (e) {
          console.warn("No se pudo inicializar Supabase desde config.js:", e);
        }

        // Hidratar sesión si existe y preparar UI
        try {
          const { data: { session } = {} } =
            (await window._sb?.auth?.getSession()) || {
              data: { session: null },
            };
          if (!session) {
            renderLogin();
            return;
          }

          // Cargar perfil/config/jornada para entrar directo si ya había sesión
          const token = session.access_token;
          const pr = await fetch(
            `${window.PSC_CONFIG.functionsBase}/get-profile`,
            {
              headers: { Authorization: "Bearer " + token },
            }
          );
          const prof = await pr.json();
          if (pr.ok) {
            S.currentUser = {
              id: prof.id,
              email: prof.email,
              role: prof.role,
              sucursal_id: prof.sucursal_id,
              sucursal: prof.sucursal,
            };
            await ensureConfig();
            if (S.currentUser.sucursal_id) {
              await openJornadaForToday(S.currentUser.sucursal_id);
            }
          } else {
            // Si falla perfil, cae a login
            S.currentUser = null;
            return renderLogin();
          }
        } catch (e) {
          console.warn("Arranque sin sesión válida:", e);
          return renderLogin();
        }

        // Listo para rutear
        route();
      }

      /* ========================= Helpers de Jornada ========================= */

      async function ensureJornadaHoy() {
        if (!S.currentUser?.sucursal_id) {
          toast("Asigna sucursal al usuario", "err");
          return null;
        }
        await openJornadaForToday(S.currentUser.sucursal_id);
        return S.jornada;
      }

      function marcarInicio() {
        const j = ensureJornadaHoy();
        if (!j) return;
        if (j.abierto_por && j.abierto_por !== S.currentUser.id) {
          toast("La jornada ya fue iniciada por otro usuario", "err");
          return;
        }
        if (j.abierto_por === S.currentUser.id) {
          toast("Ya habías iniciado la jornada");
          return;
        }
        j.abierto_por = S.currentUser.id;
        j.abierto_at = new Date().toISOString();
        j.estado = "abierta";
        save(S.data);
        toast("Inicio de jornada marcado");
      }

      /* ========================= Pantalla Inicio ========================= */
      async function renderInicio() {
        // Si esto limpia/pinta #content, mantenlo. Si no, muévelo a tu router.
        renderSession();

        const v = qs("#content");
        if (!v) return console.error("No existe #content en el DOM.");

        const u = S.currentUser || { email: "—", role: "—", sucursal_id: null };
        const sucursales = S.config?.sucursales || []; // ← ya no S.data
        const suc =
          sucursales.find((s) => s.id === u.sucursal_id)?.nombre || "—";

        v.innerHTML = `
    <div class="card">
      <h2><span class="code">[C-02]</span> Inicio de jornada</h2>
      <div class="muted">Usuario: <b>${u.email}</b> · Rol: <b>${u.role}</b></div>
      <div class="muted">Sucursal actual: <b>${suc}</b></div>
      <div class="muted">Jornada hoy: <b id="labJ">…</b></div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnStart">Marcar inicio de jornada</button>
        <button class="btn" id="btnEnsure">Refrescar jornada</button>
      </div>
    </div>
  `;

        const btnStart = qs("#btnStart", v);
        const btnEnsure = qs("#btnEnsure", v);
        const labJ = qs("#labJ", v);

        // Deshabilitar si no hay sucursal asignada
        if (!u.sucursal_id) {
          btnStart.disabled = true;
          btnEnsure.disabled = true;
        }

        // Pinta la jornada actual (esperando a que se cree si hace falta)
        try {
          const j = await ensureJornadaHoy();
          labJ.textContent = j?.id || S.jornada?.id || "—";
        } catch (e) {
          labJ.textContent = "—";
          console.error(e);
        }

        btnStart.onclick = async () => {
          try {
            await marcarInicio();
            labJ.textContent = S.jornada?.id || "—";
            toast("Inicio de jornada marcado");
          } catch (e) {
            toast(e.message || String(e));
          }
        };

        btnEnsure.onclick = async () => {
          try {
            const j2 = await ensureJornadaHoy();
            labJ.textContent = j2?.id || S.jornada?.id || "—";
            toast("Jornada refrescada");
          } catch (e) {
            toast(e.message || String(e));
          }
        };
      }

      /* =================== Catálogos básicos en memoria =================== */
      function denomLabel(d) {
        // No dependemos de "tipo"; si valor < 1 mostramos centavos.
        if (Number(d.valor) < 1)
          return `¢ ${Math.round(Number(d.valor) * 100)}`;
        return `$ ${Number(d.valor)}`;
      }

      /* Requiere jornada activa (async, para evitar condiciones de carrera) */
      async function requireJornadaOrExplain(v) {
        await ensureJornadaHoy();
        if (!S.jornada) {
          v.innerHTML =
            '<div class="card">Asigna sucursal y marca inicio de jornada.</div>';
          return false;
        }
        return true;
      }

      /* ========================= Apertura ========================= */
      async function renderApertura() {
        const v = qs("#content");
        if (!v) return console.error("No existe #content en el DOM.");
        if (!(await requireJornadaOrExplain(v))) return;

        // Catálogo de denominaciones desde la config (no demo).
        const denoms = (S.config?.denominaciones || [])
          .slice()
          .sort((a, b) => Number(a.valor) - Number(b.valor));

        v.innerHTML = `<div class="card">
    <div class="ap-head">
      <h2><span class="code">[C-03]</span> Saldo inicial (Apertura)</h2>
      <div class="ap-total"><span>Total</span> <strong id="apTotal">$0.00</strong></div>
    </div>

    ${
      denoms.length === 0
        ? `<div class="muted">No hay denominaciones configuradas. Asegúrate de que <code>get-config</code> devuelva <b>denominaciones</b> (id, valor).</div>`
        : `
      <table class="ap">
        <thead>
          <tr><th>Denominación</th><th style="width:140px">Cant.</th><th style="width:160px">Subtotal</th></tr>
        </thead>
        <tbody id="apRows"></tbody>
        <tfoot>
          <tr>
            <td colspan="2" class="right-align" style="font-weight:600">Total</td>
            <td class="apSub" id="apTotalFoot">$0.00</td>
          </tr>
        </tfoot>
      </table>
      <div class="actions">
        <button class="btn primary" id="btnApSave">Guardar</button>
      </div>
    `
    }
  </div>`;

        if (denoms.length === 0) return;

        const tbody = qs("#apRows", v);
        const totalEl = qs("#apTotal", v);
        const footEl = qs("#apTotalFoot", v);
        const btnSave = qs("#btnApSave", v);

        // Pintar filas (sin valores previos: capturamos solo total)
        tbody.innerHTML = "";
        denoms.forEach((d) => {
          tbody.appendChild(
            el(
              `<tr data-id="${d.id}" data-valor="${Number(d.valor)}">
        <td>${denomLabel(d)}</td>
        <td><input type="number" min="0" step="1" value="" style="width:120px"></td>
        <td class="apSub">$0.00</td>
      </tr>`
            )
          );
        });

        function recalc() {
          let total = 0;
          qsa("#apRows tr", v).forEach((tr) => {
            const valor = Number(tr.dataset.valor || 0);
            const qty = Math.max(0, parseInt(qs("input", tr).value || "0", 10));
            const sub = valor * qty;
            qs(".apSub", tr).textContent = money(sub);
            total += sub;
          });
          totalEl.textContent = money(total);
          footEl.textContent = money(total);
          return total;
        }
        recalc();
        tbody.addEventListener("input", (e) => {
          if (e.target.tagName === "INPUT") recalc();
        });

        btnSave.onclick = async () => {
          const total = recalc();
          if (total < 0) return toast("Total inválido", "err");

          // Confirmación (popup)
          const ok = window.confirm(
            `¿Confirmas guardar el saldo inicial por ${money(
              total
            )} y bloquear el módulo?`
          );
          if (!ok) return;

          // Token
          const { data: { session } = {} } =
            await (window._sb?.auth?.getSession() || {});
          const token = session?.access_token;
          if (!token)
            return toast("Sesión no válida. Vuelve a iniciar sesión.", "err");

          // Guardar total en la edge y bloquear módulo
          btnSave.disabled = true;
          try {
            const res = await fetch(
              `${window.PSC_CONFIG.functionsBase}/day-save-apertura-total`,
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Authorization: "Bearer " + token,
                },
                body: JSON.stringify({
                  jornada_id: S.jornada.id,
                  total: Number(total.toFixed(2)),
                  accepted_by_user: true,
                }),
              }
            );
            const js = await res.json();
            if (!res.ok || !js?.ok)
              throw new Error(js?.error || "No se pudo guardar apertura");

            // Bloquear la UI localmente
            qsa("#apRows input", v).forEach((inp) => (inp.disabled = true));
            btnSave.disabled = true;
            btnSave.textContent = "Guardado";
            toast("Saldo inicial guardado y módulo bloqueado");
          } catch (e) {
            btnSave.disabled = false;
            toast(e.message || String(e), "err");
          }
        };
      }

      /* ========================= Ingresos ========================= */
      function renderIngresos() {
        const v = qs("#content");
        if (!requireJornadaOrExplain(v)) return;
        v.innerHTML = `<div class="card"><h2><span class="code">[C-04]</span> Ingresos — Totales del día</h2>
          <div class="section-title">Por sistema × método</div>
          <div id="ingGrid"></div>
          <div class="actions"><button class="btn primary" id="btnIngSave">Guardar</button></div>
        </div>`;

        const grid = qs("#ingGrid");
        grid.innerHTML = "";

        const order = [
          "efectivo",
          "tarjeta_clave",
          "tarjeta_credito",
          "yappy_comercial",
        ];
        const friendly = (name) =>
          ({
            efectivo: "Efectivo",
            tarjeta_clave: "Tarjeta CLAVE",
            tarjeta_credito: "Tarjeta Crédito",
            yappy_comercial: "Yappy Comercial",
          }[name] || name);

        const metodosOrd = [...S.data.metodos].sort((a, b) => {
          const ia = order.indexOf(a.nombre);
          const ib = order.indexOf(b.nombre);
          return (
            (ia < 0 ? 99 : ia) - (ib < 0 ? 99 : ib) ||
            a.nombre.localeCompare(b.nombre)
          );
        });

        S.data.sistemas.forEach((sys, index) => {
          const subCode = String.fromCharCode(65 + index); // A, B, C...
          const tbl =
            el(`<div class="card"><h3><span class="code">[C-04-${subCode}]</span> ${sys.nombre}</h3>
            <table><thead><tr><th>Método</th><th style="width:160px">Monto</th><th>Obs.</th></tr></thead><tbody></tbody></table>
          </div>`);
          const tbody = tbl.querySelector("tbody");
          metodosOrd.forEach((m) => {
            const prev = (S.data.ingresos[S.jornada.id] || []).find(
              (x) => x.sistema_id === sys.id && x.metodo_id === m.id
            );
            const chips = [
              m.requiere_match ? '<span class="chip">match</span>' : "",
              m.efectivo ? '<span class="chip">efectivo</span>' : "",
              m.nombre === "tarjeta_clave"
                ? '<span class="chip">CLAVE</span>'
                : "",
              m.nombre === "tarjeta_credito"
                ? '<span class="chip">Crédito</span>'
                : "",
            ].join(" ");
            tbody.appendChild(
              el(`<tr data-sis="${sys.id}" data-met="${m.id}">
              <td>${friendly(m.nombre)} ${chips}</td>
              <td><input type="number" min="0" step="0.01" value="${
                prev?.monto || ""
              }" style="width:140px"></td>
              <td><input type="text" value="${prev?.obs || ""}"></td>
            </tr>`)
            );
          });
          grid.appendChild(tbl);
        });

        qs("#btnIngSave").onclick = () => {
          const items = [];
          qsa("#ingGrid tr").forEach((tr) => {
            const sistema_id = tr.dataset.sis,
              metodo_id = tr.dataset.met;
            const monto = Number(
              tr.querySelector("td:nth-child(2) input").value || 0
            );
            const obs = tr.querySelector("td:nth-child(3) input").value || "";
            if (monto > 0 || obs)
              items.push({ sistema_id, metodo_id, monto, obs });
          });
          S.data.ingresos[S.jornada.id] = items;
          save(S.data);
          toast("Ingresos guardados");
        };
      }

      /* ========================= Saldo final (Efectivo) ========================= */
      function renderSFinal() {
        const v = qs("#content");
        if (!requireJornadaOrExplain(v)) return;
        v.innerHTML = `<div class="card">
          <div class="ap-head">
            <h2><span class="code">[C-05]</span> Saldo final (Efectivo)</h2>
            <div class="ap-total"><span>Total</span> <strong id="sfTotal">$0.00</strong></div>
          </div>
          <table class="ap"><thead><tr><th>Denominación</th><th style="width:140px">Cant.</th><th style="width:160px">Subtotal</th></tr></thead>
          <tbody id="sfRows"></tbody>
          <tfoot><tr><td colspan="2" class="right-align" style="font-weight:600">Total</td><td class="apSub" id="sfTotalFoot">$0.00</td></tr></tfoot>
          </table>
          <div class="actions"><button class="btn primary" id="btnSfSave">Guardar</button></div>
        </div>`;

        const body = qs("#sfRows");
        body.innerHTML = "";
        const detalle = S.data.sfinales[S.jornada.id] || [];
        const prevById = Object.fromEntries(
          detalle.map((x) => [x.denominacion_id, x.cantidad])
        );
        S.data.denominaciones
          .sort((a, b) => a.valor - b.valor)
          .forEach((d) => {
            const qty = prevById[d.id] || "";
            body.appendChild(
              el(`<tr data-id="${d.id}" data-valor="${d.valor}">
            <td>${denomLabel(d)}</td>
            <td><input type="number" min="0" step="1" value="${qty}" style="width:120px"></td>
            <td class="apSub">$0.00</td>
          </tr>`)
            );
          });

        function recalc() {
          let total = 0;
          qsa("#sfRows tr").forEach((tr) => {
            const valor = Number(tr.dataset.valor || 0);
            const qty = Math.max(
              0,
              parseInt(tr.querySelector("input").value || "0", 10)
            );
            const sub = valor * qty;
            tr.querySelector(".apSub").textContent = money(sub);
            total += sub;
          });
          qs("#sfTotal").textContent = money(total);
          qs("#sfTotalFoot").textContent = money(total);
        }
        recalc();
        qs("#sfRows").addEventListener("input", (e) => {
          if (e.target.tagName === "INPUT") recalc();
        });

        qs("#btnSfSave").onclick = () => {
          const items = qsa("#sfRows tr").map((tr) => {
            const id = tr.dataset.id,
              qty = Math.max(
                0,
                parseInt(tr.querySelector("input").value || "0", 10)
              );
            return { denominacion_id: id, cantidad: qty };
          });
          S.data.sfinales[S.jornada.id] = items;
          save(S.data);
          toast("Saldo final guardado");
        };
      }

      /* ========================= Vouchers ========================= */
      function renderVouchers() {
        const v = qs("#content");
        if (!requireJornadaOrExplain(v)) return;
        const j = S.jornada;
        const comp = S.data.comprobantes[j.id] || {
          tarjetas: { clave: 0, credito: 0, url: "" },
          yappy: { monto: 0, url: "" },
        };
        S.data.comprobantes[j.id] = comp;
        save(S.data);

        v.innerHTML = `<div class="card"><h2><span class="code">[C-06]</span> Vouchers</h2>
          <div class="muted">Se suben mínimo <b>2 fotos por día</b>: 1) voucher de <b>Tarjetas (CLAVE + Crédito)</b> y 2) voucher de <b>Yappy Comercial</b>.</div>
        </div>
        <div class="card">
          <h3><span class="code">[C-06-A]</span> Tarjetas (CLAVE + Crédito)</h3>
          <div class="row">
            <div class="col"><label>Monto CLAVE</label><input id="vcClave" type="number" min="0" step="0.01" value="${
              comp.tarjetas.clave || ""
            }"></div>
            <div class="col"><label>Monto Crédito</label><input id="vcCred" type="number" min="0" step="0.01" value="${
              comp.tarjetas.credito || ""
            }"></div>
            <div class="col"><label>Foto / URL</label><input id="vcUrl" type="text" placeholder="URL de voucher" value="${
              comp.tarjetas.url || ""
            }"></div>
          </div>
        </div>
        <div class="card">
          <h3><span class="code">[C-06-B]</span> Yappy Comercial</h3>
          <div class="row">
            <div class="col"><label>Monto</label><input id="vyMonto" type="number" min="0" step="0.01" value="${
              comp.yappy.monto || ""
            }"></div>
            <div class="col"><label>Foto / URL</label><input id="vyUrl" type="text" placeholder="URL de voucher" value="${
              comp.yappy.url || ""
            }"></div>
          </div>
        </div>
        <div class="actions"><button class="btn primary" id="btnSaveV">Guardar vouchers</button></div>`;

        qs("#btnSaveV").onclick = () => {
          comp.tarjetas.clave = Number(qs("#vcClave").value || 0);
          comp.tarjetas.credito = Number(qs("#vcCred").value || 0);
          comp.tarjetas.url = qs("#vcUrl").value || "";
          comp.yappy.monto = Number(qs("#vyMonto").value || 0);
          comp.yappy.url = qs("#vyUrl").value || "";
          S.data.comprobantes[j.id] = comp;
          save(S.data);
          toast("Vouchers guardados");
        };
      }

      /* ========================= Delivery (mensajería) ========================= */
      function renderDelivery() {
        const v = qs("#content");
        if (!requireJornadaOrExplain(v)) return;
        const j = S.jornada;
        const list = S.data.delivery[j.id] || (S.data.delivery[j.id] = []);

        function totals() {
          const carga = list.length;
          const cobrado = list.reduce((a, b) => a + Number(b.cobrado || 0), 0);
          const pagado = list.reduce((a, b) => a + Number(b.pagado || 0), 0);
          const ganancia = +(cobrado - pagado).toFixed(2);
          return { carga, cobrado, pagado, ganancia };
        }
        const T = totals();

        v.innerHTML = `<div class="card">
          <h2><span class="code">[C-07]</span> Delivery — Carga recibida y Total facturado</h2>
          <div class="row" style="gap:12px">
            <div class="kpi"><small>Carga recibida</small><b>${
              T.carga
            }</b></div>
            <div class="kpi"><small>Total facturado (cobrado)</small><b>${money(
              T.cobrado
            )}</b></div>
            <div class="kpi"><small>Pagado a repartidor</small><b>${money(
              T.pagado
            )}</b></div>
            <div class="kpi"><small>Ganancia</small><b>${money(
              T.ganancia
            )}</b></div>
          </div>
        </div>
        <div class="card">
          <h3><span class="code">[C-07-A]</span> Agregar envío</h3>
          <div class="row">
            <div class="col"><label>Tipo</label><select id="dlTipo"><option>Entrega</option><option>Recogida</option></select></div>
            <div class="col"><label>Empresa</label><select id="dlEmpresa"><option>PSC</option><option>CARGAS N.</option></select></div>
            <div class="col"><label>Repartidor</label><input id="dlRep" placeholder="Nombre"></div>
            <div class="col"><label>Cobrado al cliente</label><input id="dlCob" type="number" min="0" step="0.01" value="" placeholder="0.00"></div>
            <div class="col"><label>Pagado al repartidor</label><input id="dlPag" type="number" min="0" step="0.01" value="" placeholder="0.00"></div>
          </div>
          <div class="row">
            <div class="col"><label>Detalle</label><input id="dlDet" placeholder="observaciones"></div>
            <div class="col"><label>&nbsp;</label><button class="btn primary" id="btnDlAdd">Añadir</button></div>
          </div>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Tipo</th><th>Empresa</th><th>Repartidor</th><th>Cobrado</th><th>Pagado</th><th>Ganancia</th><th>Detalle</th><th></th></tr></thead>
            <tbody id="dlRows"></tbody>
          </table>
        </div>`;

        function draw() {
          const tb = qs("#dlRows");
          tb.innerHTML = "";
          list.forEach((r, i) => {
            const gan = +(
              Number(r.cobrado || 0) - Number(r.pagado || 0)
            ).toFixed(2);
            tb.appendChild(
              el(`<tr>
              <td>${r.tipo || ""}</td>
              <td>${r.empresa || ""}</td>
              <td>${r.repartidor || ""}</td>
              <td>${money(r.cobrado || 0)}</td>
              <td>${money(r.pagado || 0)}</td>
              <td>${money(gan)}</td>
              <td>${r.detalle || ""}</td>
              <td><button class="btn" data-i="${i}">Borrar</button></td>
            </tr>`)
            );
          });
        }
        draw();

        qs("#btnDlAdd").onclick = () => {
          list.push({
            tipo: qs("#dlTipo").value,
            empresa: qs("#dlEmpresa").value,
            repartidor: qs("#dlRep").value || "",
            cobrado: Number(qs("#dlCob").value || 0),
            pagado: Number(qs("#dlPag").value || 0),
            detalle: qs("#dlDet").value || "",
          });
          save(S.data);
          renderDelivery();
        };
        qs("#dlRows").addEventListener("click", (e) => {
          if (e.target.matches("button[data-i]")) {
            const i = +e.target.getAttribute("data-i");
            list.splice(i, 1);
            save(S.data);
            renderDelivery();
          }
        });
      }

      /* ========================= Gastos ========================= */
      function renderGastos() {
        const v = qs("#content");
        if (!requireJornadaOrExplain(v)) return;
        const j = S.jornada;
        const list = S.data.gastos[j.id] || (S.data.gastos[j.id] = []);

        const total = list.reduce((a, b) => a + Number(b.monto || 0), 0);

        v.innerHTML = `<div class="card">
          <h2><span class="code">[C-08]</span> Gastos</h2>
          <div class="kpi"><small>Total de gastos</small><b>${money(
            total
          )}</b></div>
        </div>
        <div class="card">
          <h3><span class="code">[C-08-A]</span> Agregar gasto</h3>
          <div class="row">
            <div class="col">
              <label>Categoría</label>
              <select id="gCat">
                <option>Gasolina</option>
                <option>Quincena</option>
                <option>Alquiler</option>
                <option>Servicios</option>
                <option>Otros</option>
              </select>
            </div>
             <div class="col">
              <label>Tipo de Pago</label>
              <select id="gTipoPago">
                <option>Efectivo</option>
                <option>Otro Metodo</option>
              </select>
            </div>
            <div class="col"><label>Monto</label><input id="gMonto" type="number" min="0" step="0.01" value="" placeholder="0.00"></div>
          </div>
          <div class="row" style="margin-top:12px;">
            <div class="col"><label>Detalle</label><input id="gDet" placeholder="Descripción"></div>
            <div class="col"><label>Foto / URL Comprobante</label><input id="gComp" placeholder="https://ejemplo.com/foto.jpg"></div>
            <div class="col" style="align-self:flex-end;"><button class="btn primary" id="btnGAdd">Añadir</button></div>
          </div>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Categoría</th><th>Detalle</th><th>Tipo de Pago</th><th>Monto</th><th></th></tr></thead>
            <tbody id="gRows"></tbody>
          </table>
        </div>`;

        function draw() {
          const tb = qs("#gRows");
          tb.innerHTML = "";
          list.forEach((r, i) => {
            tb.appendChild(
              el(`<tr>
              <td>${r.categoria || ""}</td>
              <td>${r.detalle || ""}</td>
              <td>${r.tipo_pago || ""}</td>
              <td>${money(r.monto || 0)}</td>
              <td><button class="btn" data-i="${i}">Borrar</button></td>
            </tr>`)
            );
          });
        }
        draw();

        qs("#btnGAdd").onclick = () => {
          const categoria = qs("#gCat").value;
          const tipo_pago = qs("#gTipoPago").value;
          const monto = Number(qs("#gMonto").value || 0);
          const detalle = qs("#gDet").value.trim();
          const comprobante_url = qs("#gComp").value.trim();

          if (!detalle || !comprobante_url || monto <= 0) {
            return toast(
              "Todos los campos son obligatorios y el monto debe ser mayor a cero.",
              "err"
            );
          }

          list.push({ categoria, detalle, monto, tipo_pago, comprobante_url });
          save(S.data);
          renderGastos();
        };
        qs("#gRows").addEventListener("click", (e) => {
          if (e.target.matches("button[data-i]")) {
            const i = +e.target.getAttribute("data-i");
            list.splice(i, 1);
            save(S.data);
            renderGastos();
          }
        });
      }

      /* ========================= Compras ========================= */
      function renderCompras() {
        const v = qs("#content");
        if (!requireJornadaOrExplain(v)) return;
        const j = S.jornada;
        const list = S.data.compras[j.id] || (S.data.compras[j.id] = []);

        const totalPag = list.reduce(
          (a, b) => a + Number(b.precio_pagina || 0),
          0
        );
        const totalCalc = list.reduce(
          (a, b) => a + Number(b.precio_calculado || 0),
          0
        );
        const gan = +(totalCalc - totalPag).toFixed(2);

        v.innerHTML = `<div class="card">
          <h2><span class="code">[C-09]</span> Compras</h2>
          <div class="row" style="gap:12px">
            <div class="kpi"><small>Precio página</small><b>${money(
              totalPag
            )}</b></div>
            <div class="kpi"><small>Precio calculado</small><b>${money(
              totalCalc
            )}</b></div>
            <div class="kpi"><small>Ganancia</small><b>${money(gan)}</b></div>
          </div>
        </div>
        <div class="card">
          <h3><span class="code">[C-09-A]</span> Agregar compra</h3>
          <div class="row">
            <div class="col"><label>Detalle</label><input id="cDet" placeholder="Descripción"></div>
            <div class="col"><label>Precio página</label><input id="cPag" type="number" min="0" step="0.01" value="" placeholder="0.00"></div>
            <div class="col"><label>Precio calculado</label><input id="cCal" type="number" min="0" step="0.01" value="" placeholder="0.00"></div>
            <div class="col"><label>&nbsp;</label><button class="btn primary" id="btnCAdd">Añadir</button></div>
          </div>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Detalle</th><th>Precio página</th><th>Precio calculado</th><th>Ganancia</th><th></th></tr></thead>
            <tbody id="cRows"></tbody>
          </table>
        </div>`;

        function draw() {
          const tb = qs("#cRows");
          tb.innerHTML = "";
          list.forEach((r, i) => {
            const g = +(
              Number(r.precio_calculado || 0) - Number(r.precio_pagina || 0)
            ).toFixed(2);
            tb.appendChild(
              el(`<tr>
              <td>${r.detalle || ""}</td><td>${money(
                r.precio_pagina || 0
              )}</td><td>${money(r.precio_calculado || 0)}</td><td>${money(
                g
              )}</td>
              <td><button class="btn" data-i="${i}">Borrar</button></td>
            </tr>`)
            );
          });
        }
        draw();

        qs("#btnCAdd").onclick = () => {
          list.push({
            detalle: qs("#cDet").value || "",
            precio_pagina: Number(qs("#cPag").value || 0),
            precio_calculado: Number(qs("#cCal").value || 0),
          });
          save(S.data);
          renderCompras();
        };
        qs("#cRows").addEventListener("click", (e) => {
          if (e.target.matches("button[data-i]")) {
            const i = +e.target.getAttribute("data-i");
            list.splice(i, 1);
            save(S.data);
            renderCompras();
          }
        });
      }

      /* ========================= Totales auxiliares ========================= */
      function totalEfectivoFrom(det) {
        const map = Object.fromEntries(
          S.data.denominaciones.map((d) => [d.id, d.valor])
        );
        return (det || []).reduce(
          (acc, it) =>
            acc + (map[it.denominacion_id] || 0) * (it.cantidad || 0),
          0
        );
      }

      /* ========================= Precheck ========================= */
      function renderPrecheck() {
        const v = qs("#content");
        if (!requireJornadaOrExplain(v)) return;
        const j = S.jornada;

        const aperturaEf = totalEfectivoFrom(S.data.aperturas[j.id]);
        const sfinalEf = totalEfectivoFrom(S.data.sfinales[j.id]);
        const ingresosJ = S.data.ingresos[j.id] || [];
        const comp = S.data.comprobantes[j.id] || {
          tarjetas: { clave: 0, credito: 0, url: "" },
          yappy: { monto: 0, url: "" },
        };

        const mClave = S.data.metodos.find((m) => m.nombre === "tarjeta_clave");
        const mCredito = S.data.metodos.find(
          (m) => m.nombre === "tarjeta_credito"
        );
        const mYappy = S.data.metodos.find(
          (m) => m.nombre === "yappy_comercial"
        );
        const mEfec = S.data.metodos.find((m) => m.efectivo);

        const totClave = ingresosJ
          .filter((i) => i.metodo_id === mClave?.id)
          .reduce((a, b) => a + b.monto, 0);
        const totCredito = ingresosJ
          .filter((i) => i.metodo_id === mCredito?.id)
          .reduce((a, b) => a + b.monto, 0);
        const totYappy = ingresosJ
          .filter((i) => i.metodo_id === mYappy?.id)
          .reduce((a, b) => a + b.monto, 0);
        const ingresosEf = ingresosJ
          .filter((i) => i.metodo_id === mEfec?.id)
          .reduce((a, b) => a + b.monto, 0);

        const det = [
          {
            metodo: "Tarjeta CLAVE",
            total_sistemas: totClave,
            total_vouchers: comp.tarjetas?.clave || 0,
          },
          {
            metodo: "Tarjeta Crédito",
            total_sistemas: totCredito,
            total_vouchers: comp.tarjetas?.credito || 0,
          },
          {
            metodo: "Yappy Comercial",
            total_sistemas: totYappy,
            total_vouchers: comp.yappy?.monto || 0,
          },
        ].map((r) => {
          const diff = +(r.total_sistemas - r.total_vouchers).toFixed(2);
          const estado = diff === 0 ? "ok" : diff > 0 ? "falta" : "sobra";
          return { ...r, diferencia: diff, estado };
        });

        const depositoSugerido = +(aperturaEf + ingresosEf - sfinalEf).toFixed(
          2
        );
        const depGuardado = S.data.depositos[j.id]?.monto ?? null;
        const depEstado =
          depGuardado === null
            ? "pendiente"
            : Math.abs(depositoSugerido - depGuardado) < 0.01
            ? "ok"
            : "descuadre";

        v.innerHTML = `<div class="card">
          <h2><span class="code">[C-10]</span> Precheck</h2>
          <div class="muted">Si algo no cuadra, presiona <b>Reset demo</b> para limpiar datos viejos.</div>
          <div class="row" style="gap:12px">
            <div class="kpi"><small>Apertura efectivo</small><b>${money(
              aperturaEf
            )}</b></div>
            <div class="kpi"><small>Ingresos efectivo</small><b>${money(
              ingresosEf
            )}</b></div>
            <div class="kpi"><small>Saldo final efectivo</small><b>${money(
              sfinalEf
            )}</b></div>
            <div class="kpi"><small>Depósito sugerido</small><b>${money(
              depositoSugerido
            )}</b></div>
            <div class="kpi"><small>Depósito guardado</small><b>${
              depGuardado === null ? "—" : money(depGuardado)
            }</b></div>
            <div class="kpi"><small>Estado efectivo</small><b class="${
              depEstado === "ok" ? "ok" : "bad"
            }">${depEstado}</b></div>
          </div>
        </div>
        <div class="card">
          <table>
            <thead><tr><th>Método</th><th>Total sistemas</th><th>Total vouchers</th><th>Diferencia</th><th>Estado</th><th>Fotos</th></tr></thead>
            <tbody id="preRows"></tbody>
          </table>
        </div>`;

        const tbody = qs("#preRows");
        det.forEach((r) => {
          const fotos = r.metodo.startsWith("Tarjeta")
            ? comp.tarjetas?.url
              ? "1/1"
              : "0/1"
            : r.metodo === "Yappy Comercial"
            ? comp.yappy?.url
              ? "1/1"
              : "0/1"
            : "—";
          tbody.appendChild(
            el(`<tr>
            <td>${r.metodo}</td>
            <td>${money(r.total_sistemas)}</td>
            <td>${money(r.total_vouchers)}</td>
            <td>${money(r.diferencia)}</td>
            <td class="${r.estado === "ok" ? "ok" : "bad"}">${r.estado}</td>
            <td>${fotos}</td>
          </tr>`)
          );
        });
      }

      /* ========================= Depósito ========================= */
      function renderDeposito() {
        const v = qs("#content");
        if (!requireJornadaOrExplain(v)) return;
        const j = S.jornada;
        const aperturaEf = totalEfectivoFrom(S.data.aperturas[j.id]);
        const sfinalEf = totalEfectivoFrom(S.data.sfinales[j.id]);
        const mEf = S.data.metodos.find((m) => m.efectivo);
        const ingresosEf = (S.data.ingresos[j.id] || [])
          .filter((i) => i.metodo_id === mEf?.id)
          .reduce((a, b) => a + Number(b.monto || 0), 0);
        const gastosEf = (S.data.gastos[j.id] || [])
          .filter((g) => (g.tipo_pago || "").toLowerCase() === "efectivo")
          .reduce((a, b) => a + Number(b.monto || 0), 0);
        const depositoSugerido = +(
          aperturaEf +
          ingresosEf -
          sfinalEf -
          gastosEf
        ).toFixed(2);

        const dep = S.data.depositos[j.id] || {
          monto: depositoSugerido,
          aceptado: false,
        };
        const depMontoValue = dep.monto ?? depositoSugerido;

        v.innerHTML = `<div class="card"><h2><span class="code">[C-11]</span> Depósito</h2>
          <div class="row">
            <div class="kpi"><small>Depósito sugerido</small><b>${money(
              depositoSugerido
            )}</b></div>
            <div class="kpi"><small>Depósito guardado</small><b>${money(
              dep.monto || 0
            )}</b></div>
            <div class="kpi"><small>Estado</small><b>${
              dep.aceptado ? "Aceptado" : "Pendiente"
            }</b></div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="col"><label>Monto a depositar</label><input id="depMonto" type="number" min="0" step="0.01" value="${
              depMontoValue || ""
            }"></div>
            <div class="col"><label>&nbsp;</label><button class="btn primary" id="btnDep">Aceptar depósito</button></div>
          </div>
        </div>`;
        qs("#btnDep").onclick = () => {
          const monto = Number(qs("#depMonto").value || 0);
          S.data.depositos[j.id] = { monto, aceptado: true };
          save(S.data);
          toast("Depósito aceptado");
          renderDeposito();
        };
      }

      /* ========================= Cierre ========================= */
      function renderCierre() {
        const v = qs("#content");
        if (!requireJornadaOrExplain(v)) return;
        const j = S.jornada;
        v.innerHTML = `<div class="card"><h2><span class="code">[C-12]</span> Cierre</h2>
          <div class="row">
            <button class="btn primary" id="btnOk">Cerrar OK</button>
            <button class="btn danger" id="btnErr">Cerrar con error</button>
          </div>
          <div id="cerrarErr" class="row" style="display:none; margin-top:12px;">
            <div class="col"><label>Motivo de error</label><textarea id="cerrMotivo"></textarea></div>
            <div class="col" style="align-self: flex-end;"><button class="btn danger" id="btnConfErr">Confirmar cierre con error</button></div>
          </div>
        </div>`;
        qs("#btnOk").onclick = () => {
          j.estado = "cerrada";
          j.cierre_ok = true;
          j.cerrado_por = S.currentUser.id;
          j.cerrado_at = new Date().toISOString();
          save(S.data);
          toast("Jornada cerrada OK");
        };
        qs("#btnErr").onclick = () => {
          qs("#cerrarErr").style.display = "flex";
        };
        qs("#btnConfErr").onclick = () => {
          const motivo = qs("#cerrMotivo").value.trim();
          if (!motivo) return toast("Indica motivo", "err");
          j.estado = "cerrada";
          j.cierre_ok = false;
          j.cierre_obs = motivo;
          j.cerrado_por = S.currentUser.id;
          j.cerrado_at = new Date().toISOString();
          save(S.data);
          toast("Cierre con error registrado");
        };
      }

      /* ========================= Panel de jornadas (admin) ========================= */
      function renderPanel() {
        const v = qs("#content");
        if (!S.currentUser || S.currentUser.role !== "admin") {
          v.innerHTML = '<div class="card">Solo admin.</div>';
          return;
        }
        v.innerHTML = `<div class="card"><h2><span class="code">[C-13]</span> Panel de jornadas</h2>
          <table>
            <thead><tr><th>Fecha</th><th>Sucursal</th><th>Estado</th><th>Abierto por</th><th>Cerrado por</th><th>Acciones</th></tr></thead>
            <tbody id="tJ"></tbody>
          </table>
        </div>`;
        const tb = qs("#tJ");
        tb.innerHTML = "";
        S.data.jornadas
          .sort((a, b) => (a.fecha < b.fecha ? 1 : -1))
          .forEach((j) => {
            const suc =
              S.data.sucursales.find((s) => s.id === j.sucursal_id)?.nombre ||
              "—";
            const abierto =
              S.data.users.find((u) => u.id === j.abierto_por)?.email || "—";
            const cerrado =
              S.data.users.find((u) => u.id === j.cerrado_por)?.email || "—";
            const act =
              j.estado !== "cerrada"
                ? `<button class="btn" data-id="${j.id}">Tomar</button>`
                : "";
            tb.appendChild(
              el(
                `<tr><td>${j.fecha}</td><td>${suc}</td><td>${j.estado}</td><td>${abierto}</td><td>${cerrado}</td><td>${act}</td></tr>`
              )
            );
          });
        tb.addEventListener("click", (e) => {
          if (e.target.matches("button[data-id]")) {
            const id = e.target.getAttribute("data-id");
            const j = S.data.jornadas.find((x) => x.id === id);
            S.jornada = j;
            toast("Tomaste la jornada " + j.id);
            location.hash = "#/mod-precheck";
          }
        });
      }

      /* ========================= Usuarios (admin) ========================= */
      function renderUsuarios() {
        const v = qs("#content");
        if (!S.currentUser || S.currentUser.role !== "admin") {
          v.innerHTML = '<div class="card">Solo admin.</div>';
          return;
        }
        v.innerHTML = `<div class="card"><h2><span class="code">[C-14]</span> Usuarios</h2>
          <div class="row">
            <div class="col"><label>Email</label><input id="uEmail" placeholder="usuario@psc.test"></div>
            <div class="col"><label>Rol</label><select id="uRol"><option>operador</option><option>admin</option></select></div>
            <div class="col"><label>Sucursal</label><select id="uSuc"><option value="">—</option>${S.data.sucursales
              .map((s) => `<option value="${s.id}">${s.nombre}</option>`)
              .join("")}</select></div>
            <div class="col" style="align-self: flex-end;"><button class="btn" id="btnAddU">Crear</button></div>
          </div>
          <table style="margin-top:10px"><thead><tr><th>Email</th><th>Rol</th><th>Sucursal</th></tr></thead><tbody id="tU"></tbody></table>
        </div>`;
        qs("#btnAddU").onclick = async () => {
          const email = qs("#uEmail").value.trim();
          if (!email) return;
          const role = qs("#uRol").value;
          const suc = qs("#uSuc").value || null;
          try {
            const r = await API.admin.upsertUser({
              email,
              role,
              sucursal_id: suc,
            });
            if (!r.ok) toast("No se pudo crear usuario en backend", "warn");
          } catch (e) {}
          S.data.users.push({ id: uuid(), email, role, sucursal_id: suc });
          save(S.data);
          renderUsuarios();
        };
        const tb = qs("#tU");
        tb.innerHTML = "";
        S.data.users.forEach((u) => {
          const suc =
            S.data.sucursales.find((s) => s.id === u.sucursal_id)?.nombre ||
            "—";
          tb.appendChild(
            el(`<tr><td>${u.email}</td><td>${u.role}</td><td>${suc}</td></tr>`)
          );
        });
      }

      /* ========================= Config ========================= */
      function renderConfig() {
        const v = qs("#content");
        if (!S.currentUser || S.currentUser.role !== "admin") {
          v.innerHTML = '<div class="card">Solo admin.</div>';
          return;
        }
        v.innerHTML = `<div class="card"><h2><span class="code">[C-15]</span> Configuración</h2>
          <div class="section-title">Sucursales</div>
          <div class="row">
            <div class="col"><input id="sucNom" placeholder="Nombre sucursal"></div>
            <div class="col" style="flex: 0 1 auto;"><button class="btn" id="addSuc">Añadir</button></div>
          </div>
          <div class="row" id="sucList" style="margin-top:8px;"></div>

          <div class="section-title" style="margin-top:16px;">Sistemas</div>
          <div class="row">
            <div class="col"><input id="sisNom" placeholder="Nombre sistema"></div>
            <div class="col" style="flex: 0 1 auto;"><button class="btn" id="addSis">Añadir</button></div>
          </div>
          <div class="row" id="sisList" style="margin-top:8px;"></div>

          <div class="section-title" style="margin-top:16px;">Métodos de pago</div>
          <div class="row">
            <div class="col"><input id="metNom" placeholder="Nombre método (ej. yappy_comercial)"></div>
            <div class="col" style="flex: 0 1 auto;"><label class="flex"><input type="checkbox" id="metMatch"> requiere_match</label></div>
            <div class="col" style="flex: 0 1 auto;"><label class="flex"><input type="checkbox" id="metFoto"> requiere_foto</label></div>
            <div class="col" style="flex: 0 1 auto;"><label class="flex"><input type="checkbox" id="metEfec"> efectivo</label></div>
            <div class="col" style="flex: 0 1 auto;"><button class="btn" id="addMet">Añadir</button></div>
          </div>
          <div class="row" id="metList" style="margin-top:8px;"></div>
        </div>`;

        function redraw() {
          const sucList = qs("#sucList");
          sucList.innerHTML = S.data.sucursales
            .map((s) => `<span class="pill">${s.nombre}</span>`)
            .join(" ");
          const sisList = qs("#sisList");
          sisList.innerHTML = S.data.sistemas
            .map((s) => `<span class="pill">${s.nombre}</span>`)
            .join(" ");
          const metList = qs("#metList");
          metList.innerHTML = S.data.metodos
            .map(
              (m) =>
                `<span class="pill">${m.nombre}${
                  m.efectivo ? " (efectivo)" : ""
                }${m.requiere_match ? " [match]" : ""}</span>`
            )
            .join(" ");
        }
        redraw();

        qs("#addSuc").onclick = () => {
          const n = qs("#sucNom").value.trim();
          if (!n) return;
          S.data.sucursales.push({ id: uuid(), nombre: n });
          save(S.data);
          redraw();
          qs("#sucNom").value = "";
        };
        qs("#addSis").onclick = () => {
          const n = qs("#sisNom").value.trim();
          if (!n) return;
          S.data.sistemas.push({ id: uuid(), nombre: n });
          save(S.data);
          redraw();
          qs("#sisNom").value = "";
        };
        qs("#addMet").onclick = () => {
          const n = qs("#metNom").value.trim();
          if (!n) return;
          const m = {
            id: uuid(),
            nombre: n,
            requiere_match: qs("#metMatch").checked,
            requiere_foto: qs("#metFoto").checked,
            efectivo: qs("#metEfec").checked,
          };
          S.data.metodos.push(m);
          save(S.data);
          redraw();
        };
      }

      /* ===== Helpers de backend ===== */
      S.config = S.config || {
        sucursales: [],
        metodos: [],
        gasto_categorias: [],
      };

      async function ensureConfig() {
        try {
          const t = await API.token();
          const res = await fetch(
            `${window.PSC_CONFIG.functionsBase}/get-config`,
            {
              method: "POST",
              headers: {
                Authorization: "Bearer " + t,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({}),
            }
          );
          const js = await res.json();
          if (!res.ok) throw new Error(js?.error || "Error get-config");
          S.config = {
            sucursales: js.sucursales || [],
            metodos: js.metodos || [],
            gasto_categorias: js.gasto_categorias || [],
          };
        } catch (e) {
          console.warn("get-config fallo", e);
        }
      }

      async function openJornadaForToday(sucursal_id) {
        if (!sucursal_id) throw new Error("Sucursal requerida");
        const r = await API.call("day/open-jornada", { sucursal_id });
        // intentar varios formatos
        const j = r?.data?.jornada || r?.data || r;
        const jid = j?.jornada_id || j?.id || j?.jornada?.id;
        if (!jid) throw new Error("No se obtuvo id de jornada");
        S.jornada = { id: jid, sucursal_id };
      }
      /* ========================= API Layer (Supabase + Edge Functions) ========================= */

      function mapPath(p) {
        if (p === "day/save-vouchers") return "day-save-comprobantes";
        return p.replace(/^day\//, "day-").replace(/^admin\//, "admin-");
      }

      const API = {
        ready: false,
        init() {
          try {
            if (
              window.PSC_CONFIG?.supabaseUrl &&
              window.supabase?.createClient
            ) {
              window._sb = window.supabase.createClient(
                window.PSC_CONFIG.supabaseUrl,
                window.PSC_CONFIG.supabaseAnonKey
              );
            }
            this.ready = !!window._sb;
          } catch (e) {
            console.warn("Supabase init skipped", e);
          }
        },
        async token() {
          try {
            const { data } = await window._sb.auth.getSession();
            return data?.session?.access_token || null;
          } catch {
            return null;
          }
        },
        async call(path, body) {
          const headers = {
            "Content-Type": "application/json",
            apikey: window.PSC_CONFIG.supabaseAnonKey,
          };
          try {
            const t = await this.token();
            if (t) headers["Authorization"] = `Bearer ${t}`;
          } catch {}
          const url = `${window.PSC_CONFIG.functionsBase}/${mapPath(path)}`;
          let res;
          try {
            res = await fetch(url, {
              method: "POST",
              mode: "cors",
              headers,
              body: JSON.stringify(body || {}),
            });
          } catch (e) {
            throw new Error("Network/CORS error: " + (e?.message || e));
          }
          let json = null;
          try {
            json = await res.json();
          } catch {}
          return { ok: res.ok, status: res.status, data: json };
        },
        day: {
          async saveApertura(items) {
            return API.call("day/save-apertura", {
              jornada_id: S.jornada?.id,
              fecha: today(),
              accepted_by_user: true,
              version: 1,
              items,
            });
          },
          async saveSistemas(items, comment) {
            return API.call("day/save-sistemas", {
              jornada_id: S.jornada?.id,
              accepted_by_user: true,
              version: 1,
              ingresos: items,
              comment,
            });
          },
          async saveSaldoFinal(items) {
            return API.call("day/save-saldo-final", {
              jornada_id: S.jornada?.id,
              fecha: today(),
              accepted_by_user: true,
              version: 1,
              items,
            });
          },
          async saveVouchers(comp) {
            // comp debe mapearse a estructura { totals, files } en backend
            return API.call("day/save-vouchers", {
              jornada_id: S.jornada?.id,
              fecha: today(),
              vouchers: comp,
            });
          },
          async addGasto(gasto) {
            return API.call("day/save-gasto", {
              jornada_id: S.jornada?.id,
              ...gasto,
            });
          },
          async lockGastos() {
            return API.call("day/lock-gastos", {
              jornada_id: S.jornada?.id,
              accepted_by_user: true,
              version: 1,
            });
          },
          async depositPrecheck() {
            return API.call("day/deposit-precheck", {
              jornada_id: S.jornada?.id,
            });
          },
          async saveDeposito() {
            return API.call("day/save-deposito", {
              jornada_id: S.jornada?.id,
              user_confirms_expected: true,
              version: 1,
            });
          },
        },
        admin: {
          async upsertUser({ email, role, sucursal_id }) {
            return API.call("admin-upsert-user", { email, role, sucursal_id });
          },
          async listUsers() {
            return API.call("admin-list-users", {});
          },
        },
      };

      /* ========================= Hook: enviar datos al backend en cada Guardar ========================= */
      document.addEventListener("click", async (e) => {
        // Apertura
        if (e.target && e.target.id === "btnApSave") {
          const ok = confirm(
            "Confirmo que la APERTURA es correcta y deseo guardarla."
          );
          if (!ok) return;
          try {
            const items = S.data.aperturas[S.jornada.id] || [];
            const r = await API.day.saveApertura(items);
            if (!r.ok)
              toast("No se pudo guardar en Supabase (apertura)", "warn");
          } catch (err) {
            console.warn(err);
          }
        }
        // Ingresos
        if (e.target && e.target.id === "btnIngSave") {
          const ok = confirm(
            "Confirmo que los INGRESOS son correctos y deseo guardarlos."
          );
          if (!ok) return;
          try {
            const items = S.data.ingresos[S.jornada.id] || [];
            let comment = null;
            if (window._lastIngresosSaved) {
              comment = prompt(
                "Comentario por modificación (obligatorio si ya guardaste antes):",
                ""
              );
            }
            const r = await API.day.saveSistemas(items, comment || undefined);
            window._lastIngresosSaved = true;
            if (!r.ok)
              toast("No se pudo guardar en Supabase (ingresos)", "warn");
          } catch (err) {
            console.warn(err);
          }
        }
        // Saldo final
        if (e.target && e.target.id === "btnSfSave") {
          const ok = confirm(
            "Confirmo que el SALDO FINAL es correcto y deseo guardarlo."
          );
          if (!ok) return;
          try {
            const items = S.data.sfinales[S.jornada.id] || [];
            const r = await API.day.saveSaldoFinal(items);
            if (!r.ok)
              toast("No se pudo guardar en Supabase (saldo final)", "warn");
          } catch (err) {
            console.warn(err);
          }
        }
        // Vouchers
        if (e.target && e.target.id === "btnSaveV") {
          const ok = confirm(
            "Confirmo que los VOUCHERS son correctos y deseo guardarlos."
          );
          if (!ok) return;
          try {
            const comp = S.data.comprobantes[S.jornada.id] || {};
            const r = await API.day.saveVouchers(comp);
            if (!r.ok)
              toast("No se pudo guardar en Supabase (vouchers)", "warn");
          } catch (err) {
            console.warn(err);
          }
        }
        // Gastos: cuando se añade uno, también lo enviamos
        if (e.target && e.target.id === "btnGAdd") {
          setTimeout(async () => {
            try {
              const list = S.data.gastos[S.jornada.id] || [];
              const last = list[list.length - 1];
              if (last) {
                const r = await API.day.addGasto({
                  fecha_gasto: today(),
                  metodo_id: null, // backend mapeará desde texto si hace falta
                  categoria_id: null,
                  detalle: last.detalle,
                  monto: last.monto,
                  comprobante_url: last.comprobante_url,
                  tipo_pago: last.tipo_pago,
                });
                if (!r.ok)
                  toast("No se pudo guardar en Supabase (gasto)", "warn");
              }
            } catch (err) {
              console.warn(err);
            }
          }, 50);
        }
        // Depósito
        if (e.target && e.target.id === "btnDep") {
          e.preventDefault();
          try {
            const pre = await API.day.depositPrecheck();
            if (pre.ok && pre.data && pre.data.buckets) {
              const allOk = pre.data.all_ok !== false;
              if (!allOk) {
                toast("Precheck NO OK. Revisa diferencias por método.", "err");
                return;
              }
            }
          } catch (err) {
            /* si no hay backend aún, seguimos local */
          }
          const ok = confirm(
            "Confirmo que el DEPÓSITO esperado coincide con el efectivo real."
          );
          if (!ok) return;
          try {
            const r = await API.day.saveDeposito();
            if (!r.ok)
              toast("No se pudo guardar en Supabase (depósito)", "warn");
          } catch (err) {
            console.warn(err);
          }
        }
      });

      /* ========================= Admin: Usuarios (usa backend si existe) ========================= */
      async function backendRenderUsuariosTable() {
        const t = qs("#tU");
        if (!t) return;
        try {
          const r = await API.admin.listUsers();
          const list = Array.isArray(r)
            ? r
            : Array.isArray(r?.data)
            ? r.data
            : [];
          t.innerHTML = list
            .map(function (u) {
              var suc = u.sucursal || u.sucursal_nombre || "—";
              return (
                "<tr><td>" +
                (u.email || "") +
                "</td><td>" +
                (u.role || "") +
                "</td><td>" +
                suc +
                "</td></tr>"
              );
            })
            .join("");
        } catch (err) {
          console.warn("backendRenderUsuariosTable:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        API.init();
        renderSession();
        route();
      });
    </script>
  </body>
</html>
