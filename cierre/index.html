<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PSC • Cierre de Caja</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#f6f7fb;--card:#fff;--muted:#6b7280;--text:#111827;--accent:#10b981;--border:#e5e7eb}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1024px;margin:40px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:20px;box-shadow:0 8px 24px rgba(0,0,0,.04)}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 340px}
    h1,h2,h3{margin:0 0 14px} h1{font-size:26px} h2{font-size:20px} h3{font-size:16px}
    label{font-weight:600;color:var(--muted);font-size:13px;display:block;margin:12px 0 6px}
    input,select,button,textarea{font:inherit}
    input,select,textarea{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:#f9fafb;outline:none}
    input:focus,select:focus,textarea:focus{border-color:#cbd5e1;background:#fff}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:12px;border:1px solid transparent;background:var(--accent);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#1118270d;color:#111827;border-color:var(--border)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted)}
    .list{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px}
    .list td,.list th{padding:10px 14px} .list th{color:var(--muted);font-weight:600;text-align:left;font-size:12px}
    .rowitem{background:#fff;border:1px solid var(--border);border-radius:12px}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#f1f5f9;border:1px solid var(--border)}
    .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px}
    .tag{font-size:12px;color:#6b7280}
    .error{background:#fee2e2;color:#991b1b;border:1px solid #fecaca;padding:10px;border-radius:12px;margin:8px 0}
    .ok{background:#dcfce7;color:#166534;border:1px solid #bbf7d0;padding:10px;border-radius:12px;margin:8px 0}
    .hidden{display:none !important}
    .inline{display:inline-flex;gap:10px;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div>
        <h1>Cierre de Caja</h1>
        <div class="tag" id="hdrStatus">No autenticado</div>
      </div>
      <div class="inline hidden" id="hdrSession">
        <div class="pill" id="hdrRole"></div>
        <div class="pill" id="hdrEmail"></div>
        <div class="inline" id="hdrSucursalWrap">
          <label style="margin:0 6px 0 12px">Sucursal</label>
          <select id="hdrSucursal" style="min-width:220px"></select>
        </div>
        <button id="btnLogout" class="btn secondary">Salir</button>
      </div>
    </div>

    <div class="row">
      <!-- LOGIN -->
      <div class="col">
        <div class="card">
          <h2>[C-01] Entrar</h2>
          <div id="loginBox">
            <label>Email</label>
            <input id="lgEmail" type="email" placeholder="tucorreo@dominio.com" />
            <label>Contraseña</label>
            <input id="lgPass" type="password" placeholder="••••••••" />
            <div class="inline" style="margin-top:12px">
              <button id="btnLogin" class="btn">Entrar (Supabase)</button>
            </div>
            <div id="loginMsg" class="muted" style="margin-top:10px"></div>
          </div>
          <div id="loginOk" class="ok hidden">Sesión iniciada.</div>
        </div>
      </div>

      <!-- USUARIOS (ADMIN) -->
      <div class="col">
        <div class="card">
          <div class="inline" style="justify-content:space-between;width:100%">
            <h2>[C-14] Usuarios</h2>
            <span class="tag">Solo admin</span>
          </div>

          <div id="adminOnlyHint" class="muted">Debes ser admin para gestionar usuarios.</div>

          <div id="usersForm" class="hidden">
            <label>Email</label>
            <input id="uEmail" type="email" placeholder="usuario@empresa.com" />

            <label>Rol</label>
            <select id="uRole">
              <option value="user">operador</option>
              <option value="admin">admin</option>
            </select>

            <label>Sucursal</label>
            <select id="uSucursal">
              <option value="">—</option>
            </select>

            <div class="inline" style="margin-top:12px">
              <button id="btnUserSubmit" class="btn">Crear</button>
              <button id="btnUserReset" class="btn secondary">Limpiar</button>
            </div>

            <div class="muted" style="margin-top:10px">Si incluyes <b>password</b> al crear/editar, se crea o resetea la contraseña en Auth.</div>
          </div>

          <table class="list" id="usersTableWrap">
            <thead>
              <tr><th>Email</th><th>Rol</th><th>Sucursal</th></tr>
            </thead>
            <tbody id="usersTable"></tbody>
          </table>
          <div id="usersMsg" class="muted" style="margin-top:10px"></div>
        </div>
      </div>
    </div>

    <div id="globalMsg"></div>
  </div>

  <!-- Config del proyecto (tu archivo existente) -->
  <script src="config.js"></script>
  <!-- Supabase JS -->
  <script src="https://esm.sh/@supabase/supabase-js@2"></script>

  <script>
  (function(){
    const PSC_CONFIG = window.PSC_CONFIG || {};
    if (!PSC_CONFIG.supabaseUrl || !PSC_CONFIG.supabaseAnonKey || !PSC_CONFIG.functionsBase) {
      console.error("Config de Supabase faltante en config.js");
      alert("Config de Supabase faltante en config.js");
    }

    // Supabase client
    const _sb = window.supabase.createClient(PSC_CONFIG.supabaseUrl, PSC_CONFIG.supabaseAnonKey);
    window._sb = _sb;

    // Map path helper: 'day/xyz'->'day-xyz', 'admin/xyz'->'admin-xyz'
    function mapPath(p){
      if (p === 'day/save-vouchers') return 'day-save-comprobantes';
      if (p.startsWith('day/')) return 'day-' + p.slice(4);
      if (p.startsWith('admin/')) return 'admin-' + p.slice(6);
      return p;
    }
    async function callFn(path, body=null, method='POST'){
      const { data } = await _sb.auth.getSession();
      const token = data?.session?.access_token;
      if (!token) throw new Error("No session");
      const slug = mapPath(path);
      const res = await fetch(PSC_CONFIG.functionsBase + '/' + slug, {
        method,
        headers: { 'Authorization': 'Bearer ' + token, 'Content-Type':'application/json' },
        body: method==='GET' ? null : JSON.stringify(body||{})
      });
      let json = null;
      try { json = await res.json(); } catch{}
      if (!res.ok) {
        const msg = (json && (json.error||json.message)) || ('HTTP ' + res.status);
        throw new Error(msg);
      }
      return json;
    }

    // UI refs
    const hdrStatus = document.getElementById('hdrStatus');
    const hdrSession = document.getElementById('hdrSession');
    const hdrRole = document.getElementById('hdrRole');
    const hdrEmail = document.getElementById('hdrEmail');
    const hdrSucursalWrap = document.getElementById('hdrSucursalWrap');
    const hdrSucursal = document.getElementById('hdrSucursal');
    const btnLogout = document.getElementById('btnLogout');

    const loginBox = document.getElementById('loginBox');
    const loginOk = document.getElementById('loginOk');
    const lgEmail = document.getElementById('lgEmail');
    const lgPass = document.getElementById('lgPass');
    const btnLogin = document.getElementById('btnLogin');
    const loginMsg = document.getElementById('loginMsg');

    const usersForm = document.getElementById('usersForm');
    const usersMsg = document.getElementById('usersMsg');
    const usersTable = document.getElementById('usersTable');
    const usersTableWrap = document.getElementById('usersTableWrap');
    const adminOnlyHint = document.getElementById('adminOnlyHint');
    const uEmail = document.getElementById('uEmail');
    const uRole = document.getElementById('uRole');
    const uSucursal = document.getElementById('uSucursal');
    const btnUserSubmit = document.getElementById('btnUserSubmit');
    const btnUserReset = document.getElementById('btnUserReset');

    let PROFILE = null;        // {id,email,role,sucursal_id,sucursal}
    let CONFIG = { sucursales: [], metodos: [], gasto_categorias: [] };
    let editingEmail = null;   // email de fila seleccionada (modo edición)

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function setMsg(el, txt, ok=false){
      el.className = ok ? 'ok' : (txt ? 'error' : 'muted');
      el.textContent = txt||'';
      if (!txt) el.className = 'muted';
    }

    async function refreshProfile(){
      try{
        const r = await callFn('get-profile', {}, 'GET');
        PROFILE = r;
        hdrStatus.textContent = 'Autenticado';
        hdrRole.textContent = r.role;
        hdrEmail.textContent = r.email;
        hdrSucursalWrap.style.display = (r.role === 'admin') ? 'inline-flex' : 'none';
        show(hdrSession);
        hide(loginBox); show(loginOk);
        await loadConfig();
        populateSucursalSelectors();
        if (r.sucursal_id) hdrSucursal.value = r.sucursal_id;
        renderUsersSection();
      }catch(err){
        PROFILE = null;
        hdrStatus.textContent = 'Sesión iniciada, pero faltó perfil';
        hide(hdrSession);
        show(loginBox); hide(loginOk);
        console.error('get-profile:', err.message);
      }
    }

    async function loadConfig(){
      try{
        const r = await callFn('get-config', {}, 'POST');
        CONFIG.sucursales = r.sucursales || [];
        CONFIG.metodos = r.metodos || [];
        CONFIG.gasto_categorias = r.gasto_categorias || [];
      }catch(err){
        console.warn('get-config fallo:', err.message);
        CONFIG = { sucursales: [], metodos: [], gasto_categorias: [] };
      }
    }
    function populateSucursalSelectors(){
      // Header
      hdrSucursal.innerHTML = '';
      CONFIG.sucursales.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id; opt.textContent = s.nombre;
        hdrSucursal.appendChild(opt);
      });
      // Usuarios
      uSucursal.innerHTML = '<option value="">—</option>';
      CONFIG.sucursales.forEach(s=>{
        const opt = document.createElement('option');
        opt.value = s.id; opt.textContent = s.nombre;
        uSucursal.appendChild(opt);
      });
    }

    async function refreshUsers(){
      usersTable.innerHTML = '';
      try{
        const list = await callFn('admin-list-users', {}, 'POST');
        if (!Array.isArray(list) || list.length===0){
          usersTableWrap.classList.add('hidden');
          usersMsg.textContent = 'No hay usuarios.';
          return;
        }
        usersTableWrap.classList.remove('hidden');
        usersMsg.textContent = '';
        list.forEach(row=>{
          const tr = document.createElement('tr'); tr.className = 'rowitem';
          tr.innerHTML = `<td>${row.email}</td>
                           <td>${row.role==='user'?'operador':row.role}</td>
                           <td>${row.sucursal || '—'}</td>`;
          tr.style.cursor='pointer';
          tr.onclick = ()=>{
            editingEmail = row.email;
            uEmail.value = row.email;
            uRole.value = row.role;
            uSucursal.value = row.sucursal_id || '';
            btnUserSubmit.textContent = 'Guardar';
            usersMsg.textContent = 'Editando ' + row.email;
          };
          usersTable.appendChild(tr);
        });
      }catch(err){
        usersMsg.textContent = 'Error cargando usuarios: ' + err.message;
      }
    }

    function renderUsersSection(){
      if (!PROFILE || PROFILE.role !== 'admin'){
        hide(usersForm); adminOnlyHint.classList.remove('hidden');
        usersTableWrap.classList.add('hidden');
        return;
      }
      show(usersForm); adminOnlyHint.classList.add('hidden');
      refreshUsers();
    }

    // Eventos
    btnLogin.onclick = async ()=>{
      btnLogin.disabled = true; setMsg(loginMsg, '');
      try{
        const { data, error } = await _sb.auth.signInWithPassword({
          email: lgEmail.value.trim().toLowerCase(),
          password: lgPass.value
        });
        if (error) throw error;
        await refreshProfile();
      }catch(err){
        setMsg(loginMsg, err.message||String(err));
      }finally{ btnLogin.disabled = false; }
    };

    btnLogout.onclick = async ()=>{
      await _sb.auth.signOut();
      location.reload();
    };

    hdrSucursal.onchange = async ()=>{
      // Solo admin: cambiar sucursal activa de su sesión llamando a day-open-jornada con override
      const sucursal_id = hdrSucursal.value || null;
      try{
        // Abrimos/aseguramos jornada del día en esa sucursal para el usuario
        await callFn('day-open-jornada', { sucursal_id }, 'POST');
        // Recargar perfil para traer el nombre de sucursal actualizado si corresponde
        await refreshProfile();
      }catch(err){
        alert('No se pudo cambiar de sucursal: ' + err.message);
      }
    };

    btnUserSubmit.onclick = async ()=>{
      if (!PROFILE || PROFILE.role!=='admin') return;
      const email = uEmail.value.trim().toLowerCase();
      const role  = uRole.value;
      const sucursal_id = uSucursal.value || null;
      if (!email) { usersMsg.textContent = 'Email requerido'; return; }

      btnUserSubmit.disabled = true;
      try{
        await callFn('admin-upsert-user', { email, role, sucursal_id }, 'POST');
        usersMsg.textContent = editingEmail ? 'Usuario actualizado' : 'Usuario creado';
        editingEmail = null; btnUserSubmit.textContent = 'Crear';
        uEmail.value = ''; uRole.value = 'user'; uSucursal.value = '';
        await refreshUsers();
      }catch(err){
        usersMsg.textContent = 'Error: ' + err.message;
      }finally{
        btnUserSubmit.disabled = false;
      }
    };

    btnUserReset.onclick = ()=>{
      editingEmail = null; btnUserSubmit.textContent = 'Crear';
      uEmail.value=''; uRole.value='user'; uSucursal.value='';
      usersMsg.textContent = '';
    };

    // Init
    (async function init(){
      try{
        // si ya hay sesión, intenta traer perfil
        const { data } = await _sb.auth.getSession();
        if (data?.session) await refreshProfile();
      }catch{}
    })();
  })();
  </script>
</body>
</html>
