<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Diagnóstico Supabase (cierre)</title>
<!-- UMD CDN estable -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.10/dist/umd/supabase.js"></script>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial;padding:16px;background:#f7f7f8}
  input,button{font:inherit;padding:10px;border:1px solid #e5e7eb;border-radius:10px;margin:4px 6px}
  button{background:#111;color:#fff;cursor:pointer}
  pre{white-space:pre-wrap;background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin-top:12px}
</style>
</head>
<body>
<h2>Diagnóstico Supabase (schema: <code>cierre</code>)</h2>
<p>
  URL <input id="url" size="48" placeholder="https://xxxxx.supabase.co">
  KEY <input id="key" size="60" placeholder="anon key">
  <button id="init">Inicializar</button>
</p>
<p>
  Email <input id="email" value="test@test.com">
  Pass <input id="pass" type="password" value="test">
  <button id="login">Login</button>
  <button id="me">getUser()</button>
  <button id="select">SELECT sucursales</button>
  <button id="insert">INSERT Sucursal 2</button>
</p>
<pre id="out">Cargando librería…</pre>

<script>
  const $ = (id)=>document.getElementById(id);
  const log = (x)=>{$("out").textContent += (typeof x==="string"?x:JSON.stringify(x,null,2))+"\n";}
  let client = null;

  // Comprueba que la librería cargó
  if (window.supabase && typeof supabase.createClient === "function") {
    log("✅ supabase-js cargado");
  } else {
    log("❌ No cargó supabase-js (CSP o red).");
  }

  $("init").onclick = ()=>{
    const url = $("url").value.trim();
    const key = $("key").value.trim();
    if(!url || !key){ alert("Pon URL y KEY"); return; }
    client = supabase.createClient(url, key, { db: { schema: "cierre" } });
    log("✅ Cliente creado con schema=cierre");
    alert("Cliente inicializado");
  };

  $("login").onclick = async ()=>{
    if(!client){ alert("Inicializa primero"); return; }
    const { data, error } = await client.auth.signInWithPassword({
      email: $("email").value.trim(),
      password: $("pass").value
    });
    log({ step:"login", data, error });
    if(error) alert("Login error: " + error.message);
    else alert("Login OK");
  };

  $("me").onclick = async ()=>{
    if(!client){ alert("Inicializa primero"); return; }
    const { data, error } = await client.auth.getUser();
    log({ step:"getUser", data, error });
    if(error) alert(error.message);
  };

  $("select").onclick = async ()=>{
    if(!client){ alert("Inicializa primero"); return; }
    const { data, error } = await client.from("sucursales").select("*").order("created_at",{ascending:true});
    log({ step:"select sucursales", data, error });
    if(error) alert("SELECT error: " + error.message);
  };

  $("insert").onclick = asyn
