<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Buscador de Trackings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üîé</text></svg>"
    />
    <style>
      :root {
        --bg: #ffffff;
        --fg: #111114;
        --muted: #6c6d75;
        --border: #e5e5ea;
        --card: #ffffff;
        --shadow: 0 6px 24px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(0, 0, 0, 0.04);
        --blue: #007aff;
        --blue-press: #0062d6;
        --warn: #b26c00;
        --ok: #00a34a;
        --err: #d70015;
        --radius: 16px;
        --font: -apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
          "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0; background: var(--bg); color: var(--fg); font-family: var(--font);
        display: flex; align-items: flex-start; justify-content: center; padding: 32px;
      }
      .wrap { width: 100%; max-width: 1100px; display: grid; gap: 18px; }
      .title { font-size: 28px; font-weight: 700; letter-spacing: -0.01em; margin: 0; text-align: center; }
      .subtitle { color: var(--muted); margin: 0; text-align: center; }
      .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding: 20px; }
      .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
      .search { position: relative; flex: 1; min-width: 260px; }
      .search input[type="search"] {
        width: 100%; height: 48px; padding: 0 48px 0 44px; border: 1px solid var(--border);
        border-radius: 12px; background: #fff; color: var(--fg); font-size: 16px;
        box-shadow: 0 1px 0 rgba(0,0,0,.02) inset; transition: box-shadow .2s, border-color .2s;
      }
      .search input[type="search"]:focus {
        outline: none; border-color: var(--blue); box-shadow: 0 0 0 3px rgba(0,122,255,.25);
      }
      .search .icon { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); opacity: .55; }
      .btn {
        height: 48px; padding: 0 16px; border-radius: 12px; border: 1px solid var(--border);
        background: #fff; color: var(--fg); cursor: pointer; font-weight: 600;
        transition: transform .04s, box-shadow .2s, border-color .2s;
      }
      .btn:hover { box-shadow: 0 3px 10px rgba(0,0,0,.06); }
      .btn:active { transform: translateY(1px); }
      .btn[disabled] { opacity: .5; cursor: not-allowed; }
      .btn.primary { background: var(--blue); border-color: transparent; color: #fff; }
      .btn.primary:hover { box-shadow: 0 6px 16px rgba(0,122,255,.25); }
      .btn.primary:active { background: var(--blue-press); }
      .meta { display: flex; gap: 10px; align-items: center; color: var(--muted); font-size: 13px; }
      .badge { display: inline-flex; align-items: center; gap: 6px; height: 28px; padding: 0 10px; border: 1px solid var(--border); border-radius: 999px; background: #fff; color: #222; }
      .status { font-size: 13px; }
      .status.ok { color: var(--ok); }
      .status.err { color: var(--err); }
      .status.warn { color: var(--warn); }
      table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
      thead th {
        font-size: 12px; color: #7a7a80; text-transform: uppercase; letter-spacing: .08em;
        font-weight: 700; border-bottom: 1px solid var(--border); padding: 10px 12px;
      }
      tbody td {
        background: #fff; border: 1px solid var(--border); border-left: none; border-right: none;
        padding: 12px; font-family: var(--mono);
      }
      tbody tr:hover td { background: #fbfbfd; }
      tbody td:first-child { border-left: 1px solid var(--border); border-top-left-radius: 12px; border-bottom-left-radius: 12px; }
      tbody td:last-child { border-right: 1px solid var(--border); border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
      .muted { color: var(--muted); }
      .empty { padding: 14px; font-size: 13px; color: var(--muted); text-align: center; }
      .pill { display: inline-flex; align-items: center; gap: 6px; height: 24px; padding: 0 10px; border: 1px solid var(--border); border-radius: 999px; font-size: 12px; background: #fff; }
      .pill.ok { background: #e9f9ef; color: #106d37; border-color: #bfe9cd; }
      .pill.none { color: #7c7c82; }
      @media (max-width: 640px) { body { padding: 18px; } .title { font-size: 24px; } }
      .psc-back-main {
        position: fixed; top: 16px; left: 16px; z-index: 9999; display: inline-flex; align-items: center; gap: 8px;
        padding: 10px 12px; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 14px;
        border: 1px solid var(--border); background: #ffffff; color: #111827;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        transition: transform .15s, box-shadow .15s, border-color .15s;
      }
      .psc-back-main:hover { transform: translateY(-1px); box-shadow: 0 12px 32px rgba(0, 0, 0, 0.18); border-color: #d1d5db; }
      .psc-back-main:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.35), 0 12px 32px rgba(0, 0, 0, 0.2); }
    </style>

    <link rel="stylesheet" href="portal.css">
    <script src="config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="guard.js"></script>
    <style>:root{--psc-bg:#F2F2F7}</style>

    <!-- ==================== SOLO EST√âTICO: Desplazar 2" para mostrar header ==================== -->
    <style>
      :root{
        /* Ajusta si tu header es m√°s alto/bajo */
        --header-offset: 192px;
      }
      /* Empuja el contenido bajo el header del sitio */
      body{
        padding-top: calc(32px + var(--header-offset)) !important;
      }
      /* Si repusieras el bot√≥n Volver, esto lo posiciona bajo el header */
      .psc-back-main{
        top: calc(16px + var(--header-offset)) !important;
        z-index: 10 !important;
      }
    </style>
    <!-- ========================================================================================= -->
  </head>
  <body>
    <!-- Bot√≥n Volver eliminado -->

    <main class="wrap">
      <section class="card" style="padding: 24px 20px">
        <h1 class="title">Trackings</h1>
        <p class="subtitle">BUSCA EN BASE DE DATOS PSC.</p>

        <div class="row" style="margin-top: 12px">
          <div class="search">
            <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 21l-4.2-4.2" stroke="#000" opacity=".35" stroke-width="2" stroke-linecap="round" />
              <circle cx="11" cy="11" r="7" stroke="#000" opacity=".35" stroke-width="2" />
            </svg>
            <input id="q" type="search" placeholder="Escribe el tracking y presiona Enter‚Ä¶" autocomplete="off" />
          </div>
          <button id="btnSearch" class="btn primary">Buscar</button>
          <button id="btnClear" class="btn">Limpiar</button>
        </div>

        <div class="row" style="margin-top: 10px; justify-content: space-between">
          <div class="meta">
            <div id="modeBadge" class="badge" title="Modo de b√∫squeda">
              <span id="modeIcon">üîç</span><span id="modeText">Listo</span>
            </div>
            <div id="resultCount" class="small muted"></div>
          </div>
          <div id="status" class="status muted" aria-live="polite">Listo.</div>
        </div>
      </section>

      <section class="card">
        <div style="overflow: auto">
          <table aria-label="Resultados de la b√∫squeda de trackings">
            <thead>
              <tr>
                <th style="width: 60px">#</th>
                <th>Original</th>
                <th>Corregido</th>
                <th>Peso (lbs)</th>
                <th>Cuenta</th>
                <th>Nombre</th><!-- NUEVO -->
                <th>N.¬∫ Casillero</th>
                <th>Estado</th>
                <th>ML</th>
                <th style="width: 140px">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr id="emptyRow">
                <td colspan="10" class="empty">Sin resultados.</td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>
    </main>

    <script>
      // ==== CONFIG ====
      const SEARCH_URL = "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/search-tracking";
      const MARK_URL   = "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/mark-registered"; // Edge
      const STATUS_REGISTERED = "Centro de Dist. PSC"; // Consistente con Admin

      // ==== UI REFS ====
      const ui = {
        q: document.getElementById("q"),
        btnSearch: document.getElementById("btnSearch"),
        btnClear: document.getElementById("btnClear"),
        status: document.getElementById("status"),
        tbody: document.getElementById("tbody"),
        emptyRow: document.getElementById("emptyRow"),
        modeBadge: document.getElementById("modeBadge"),
        modeIcon: document.getElementById("modeIcon"),
        modeText: document.getElementById("modeText"),
        resultCount: document.getElementById("resultCount"),
      };

      // ==== HELPERS ====
      function setStatus(msg, type = "") {
        ui.status.textContent = msg;
        ui.status.className = "status " + (type || "muted");
      }

      function setMode(mode) {
        let text = "Listo", icon = "üîç";
        if (mode === "exact") { text = "Exacto"; icon = "üéØ"; }
        else if (mode === "partial") { text = "Subcadena"; icon = "üß©"; }
        else if (mode === "none") { text = "Sin coincidencias"; icon = "üï≥Ô∏è"; }
        ui.modeText.textContent = text;
        ui.modeIcon.textContent = icon;
      }

      function clearTable() {
        ui.tbody.innerHTML = "";
        const tr = document.createElement("tr");
        tr.id = "emptyRow";
        const td = document.createElement("td");
        td.colSpan = 10;
        td.className = "empty";
        td.textContent = "Sin resultados.";
        tr.appendChild(td);
        ui.tbody.appendChild(tr);
        ui.resultCount.textContent = "";
      }

      function safeCell(text) {
        const td = document.createElement("td");
        td.className = "mono";
        td.textContent = text ?? "";
        return td;
      }

      function isTrue(v) {
        if (typeof v === "boolean") return v;
        if (typeof v === "string") return v.trim().toLowerCase() === "true";
        if (typeof v === "number") return v === 1;
        return false;
      }

      function renderRow(r, index) {
        const tr = document.createElement("tr");

        const c0 = document.createElement("td");
        c0.className = "small muted";
        c0.textContent = String(index + 1);

        const c1 = safeCell(r.tracking_original);
        const c2 = safeCell(r.tracking_corrected);
        const c3 = safeCell(r.weight_lbs == null ? "" : String(r.weight_lbs));
        const c4 = safeCell(r.cuenta);
        const c5 = safeCell(r.name); // NUEVO: nombre
        const c6 = safeCell(r.num_casillero);

        const estadoVal = r.status ?? r.estado ?? "";
        const c7 = safeCell(estadoVal);

        const c8 = document.createElement("td");
        const pill = document.createElement("span");
        const mlVal = r.ML ?? r.ml ?? r.Ml ?? null;
        if (isTrue(mlVal)) {
          pill.className = "pill ok";
          pill.textContent = "true";
        } else {
          pill.className = "pill none";
          pill.textContent = "‚Äî";
        }
        c8.appendChild(pill);

        const c9 = document.createElement("td");
        const btn = document.createElement("button");
        btn.className = "btn";
        btn.textContent = "Registrado";
        if (!isTrue(mlVal)) btn.disabled = true;

        btn.addEventListener("click", async () => {
          btn.disabled = true;
          const before = btn.textContent;
          btn.textContent = "Actualizando‚Ä¶";
          setStatus("Actualizando registro‚Ä¶", "warn");
          try {
            const payload = {};
            if (r.id != null) payload.id = r.id;
            else {
              payload.tracking_original = r.tracking_original ?? null;
              payload.tracking_corrected = r.tracking_corrected ?? null;
            }
            payload.set_status = STATUS_REGISTERED;
            payload.clear_ml = true;

            const res = await fetch(MARK_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload),
            });
            const txt = await res.text().catch(() => "");
            let json = {};
            try { json = JSON.parse(txt || "{}"); } catch {}
            if (!res.ok || json?.ok !== true) {
              const msg = json?.error || json?.detail || res.statusText || `HTTP ${res.status}`;
              throw new Error(msg);
            }
            // Update UI (nota: ahora el estado est√° en c7)
            c7.textContent = STATUS_REGISTERED;
            pill.className = "pill none";
            pill.textContent = "‚Äî";
            btn.textContent = "Hecho";
            setStatus("Actualizado ‚úîÔ∏è", "ok");
          } catch (e) {
            btn.disabled = false;
            btn.textContent = before;
            setStatus("Error: " + (e?.message || e), "err");
          }
        });
        c9.appendChild(btn);

        tr.append(c0, c1, c2, c3, c4, c5, c6, c7, c8, c9);
        return tr;
      }

      function fillTable(rows) {
        ui.tbody.innerHTML = "";
        rows.forEach((r, i) => ui.tbody.appendChild(renderRow(r, i)));
        if (!rows.length) clearTable();
        ui.resultCount.textContent = rows.length ? `${rows.length} resultado(s)` : "";
      }

      // ==== SEARCH ====
      async function search() {
        const q = ui.q.value;
        if (!q || !q.trim()) {
          setStatus("Escribe un tracking para buscar.", "warn");
          setMode("none");
          clearTable();
          return;
        }
        ui.btnSearch.disabled = true;
        setStatus("Buscando‚Ä¶");
        setMode("");
        try {
          const res = await fetch(SEARCH_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ q }),
          });
          const txt = await res.text().catch(() => "");
          let payload = {};
          try { payload = JSON.parse(txt || "{}"); } catch {}

          if (!res.ok) {
            setStatus(payload.detail || payload.error || res.statusText || `HTTP ${res.status}`, "err");
            setMode("none");
            clearTable();
            return;
          }

          const mode = payload.mode || (payload.rows?.length ? "partial" : "none");
          setMode(mode);
          const rows = Array.isArray(payload.rows) ? payload.rows : [];
          fillTable(rows);

          if (mode === "exact") setStatus(`Resultado exacto (${rows.length}).`, "ok");
          else if (mode === "partial") setStatus(`B√∫squeda por subcadena (${rows.length}).`, "ok");
          else setStatus(payload.hint || "Sin coincidencias.", "warn");
        } catch (e) {
          setStatus(`Error: ${e.message}`, "err");
          setMode("none");
          clearTable();
        } finally {
          ui.btnSearch.disabled = false;
        }
      }

      // ==== EVENTS ====
      ui.btnSearch.onclick = search;
      ui.q.addEventListener("keydown", (e) => { if (e.key === "Enter") search(); });
      ui.btnClear.onclick = () => {
        ui.q.value = "";
        clearTable();
        setStatus("Listo.");
        setMode("");
      };

      // init
      clearTable();
    </script>

    <script src="portal.js"></script>
  </body>
</html>
