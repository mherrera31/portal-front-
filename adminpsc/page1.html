<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin - PSC (Export)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üì¶</text></svg>"
  />
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --fg:#1c1c1e; --muted:#6e6e73;
      --accent:#0b5cff; --border:#e5e5ea; --ok:#2ecc71; --err:#e5484d;
      --font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      --header-z: 999999; --header-offset: 192px;
    }
    *{ box-sizing:border-box }
    body{
      margin:0; background:var(--bg); color:var(--fg); font-family:var(--font);
      display:flex; justify-content:center; align-items:flex-start;
      padding:clamp(24px,3vw,40px); padding-top:calc(clamp(48px,8vh,96px) + var(--header-offset));
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{ width:100%; max-width:980px; display:grid; gap:16px }
    .card{
      background:var(--card); border:1px solid var(--border);
      border-radius:16px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    .muted{ color:var(--muted) } .small{ font-size:12px }
    .btn{
      background:#fff; border:1px solid var(--border); color:#111;
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600;
      transition:box-shadow .15s ease, transform .15s ease;
    }
    .btn:hover{ box-shadow:0 6px 18px rgba(0,0,0,.06); transform:translateY(-1px) }
    .btn.primary{ background:var(--accent); color:#fff; border-color:transparent; box-shadow:0 6px 18px rgba(0,0,0,.1) }
    .btn.primary:hover{ transform:translateY(-1px); box-shadow:0 10px 26px rgba(0,0,0,.16) }
    .status{ font-size:13px } .status.ok{ color:var(--ok) } .status.err{ color:var(--err) } .status.warn{ color:#f6c744 }

    /* Header fijo al frente (si usas portal.js) */
    .psc-header{
      position: fixed !important; top: 0; left: 0; right: 0;
      z-index: var(--header-z) !important; background: #fff;
      box-shadow: 0 6px 18px rgba(0,0,0,.06);
    }

    /* ========= TOAST ========= */
    .toast{
      position: fixed;
      top: calc(8px + var(--header-offset));
      left: 50%;
      transform: translateX(-50%) translateY(-12px);
      background: #111; color: #fff;
      padding: 12px 16px; border-radius: 12px;
      box-shadow: 0 14px 30px rgba(0,0,0,.18);
      z-index: calc(var(--header-z) + 1);
      font-weight: 700; letter-spacing: .2px;
      opacity: 0; pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      max-width: 92vw; text-align: center;
    }
    .toast.success{ background: #00a34a; }
    .toast.error{ background: #d70015; }
    .toast.show{ opacity: 1; pointer-events: auto; transform: translateX(-50%) translateY(0); }
  </style>

  <!-- Portal / header opcional -->
  <link rel="stylesheet" href="portal.css">
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="guard.js"></script>
</head>
<body>
  <!-- TOAST -->
  <div id="saveToast" class="toast" role="status" aria-live="polite"></div>

  <div class="wrap">
    <div class="card">
      <h2 style="margin:0 0 12px">Exportar corte</h2>
      <p class="small muted" style="margin:0 0 12px">
        Genera <code>cargar_corte.xlsx</code> desde la funci√≥n <b>export_today</b> (servidor).
      </p>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap">
        <button class="btn primary" id="btnExport">Exportar XLSX</button>
        <span id="statusMsg" class="status muted">Listo.</span>
      </div>
      <div class="small muted" style="margin-top:8px">
        Formato: columnas <b>WAREHOUSE</b>, <b>TRACKING</b>, <b>CLIENTE</b>, <b>PIEZAS</b>, <b>PESO</b> (todo texto). PIEZAS = 1.
      </div>
    </div>
  </div>

  <script>
  "use strict";
  // ==== CONFIG ====
  const EXPORT_TODAY_URL = "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/export_today"; // tu Edge

  // ==== UI ====
  const ui = {
    btnExport: document.getElementById("btnExport"),
    status: document.getElementById("statusMsg"),
    toast: document.getElementById("saveToast"),
  };

  // ==== Helpers ====
  function setStatus(msg, kind=""){ ui.status.textContent = msg; ui.status.className = "status " + (kind || "muted"); }
  let toastTimer = null;
  function showToast(msg, type='success', ms=3000){
    const el = ui.toast; if (!el) return;
    el.textContent = msg; el.className = 'toast ' + (type || '');
    void el.offsetWidth; el.classList.add('show');
    clearTimeout(toastTimer); toastTimer = setTimeout(()=> el.classList.remove('show'), ms);
  }

  // ==== Export desde la Edge ====
  async function exportFromEdge(){
    ui.btnExport.disabled = true;
    setStatus("Solicitando archivo al servidor‚Ä¶", "warn");
    try {
      const res = await fetch(EXPORT_TODAY_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({}) // no necesita payload
      });

      if (!res.ok) {
        let err = "Error al exportar";
        try { const j = await res.json(); err = j?.error || err; } catch {}
        throw new Error(err);
      }

      // Conteo exportado desde header
      const countHeader = res.headers.get("x-exported-count") || res.headers.get("X-Exported-Count");
      const count = countHeader ? Number(countHeader) : NaN;

      // Descarga el XLSX
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "cargar_corte.xlsx";
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);

      if (!Number.isNaN(count)) {
        setStatus(`Archivo generado. Exportadas ${count} fila(s).`, "ok");
        showToast(`Exportadas ${count} fila(s)`, "success", 3600);
      } else {
        setStatus(`Archivo generado.`, "ok");
        showToast(`Exportaci√≥n completada`, "success", 3000);
      }
    } catch (e) {
      setStatus(`Error: ${e?.message || e}`, "err");
      showToast("Error en exportaci√≥n", "error", 3500);
    } finally {
      ui.btnExport.disabled = false;
    }
  }

  // Wire
  ui.btnExport.addEventListener("click", exportFromEdge);
  </script>

  <script src="portal.js"></script>
</body>
</html>


