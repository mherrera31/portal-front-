<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin - PSC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>📦</text></svg>"/>
  <style>
    :root{--bg:#ffffff;--card:#ffffff;--fg:#1c1c1e;--muted:#6e6e73;--accent:#0b5cff;--border:#e5e5ea;--ok:#2ecc71;--err:#e5484d;--font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:var(--font);display:flex;justify-content:center;align-items:flex-start;padding:clamp(24px,3vw,40px);padding-top:clamp(48px,8vh,96px);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    .wrap{width:100%;max-width:980px;display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .muted{color:var(--muted)} .mono{font-family:ui-monospace,Menlo,monospace} .small{font-size:12px}
    textarea{width:100%;min-height:240px;background:#fff;color:var(--fg);border:1px solid var(--border);border-radius:12px;padding:12px;font-family:ui-monospace,Menlo,monospace}
    table{width:100%;border-collapse:separate;border-spacing:0 6px} th,td{padding:10px 12px;text-align:left}
    th{color:#3a3a3c;font-weight:600;border-bottom:1px solid var(--border)} tr{background:#fff;border:1px solid var(--border)} tbody tr:hover{background:#f7f7f8}
    .btn{background:#fff;border:1px solid var(--border);color:#111;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:600;transition:box-shadow .15s ease,transform .15s ease}
    .btn:hover{box-shadow:0 6px 18px rgba(0,0,0,.06);transform:translateY(-1px)}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent;box-shadow:0 6px 18px rgba(0,0,0,.1)}
    .btn.primary:hover{transform:translateY(-1px);box-shadow:0 10px 26px rgba(0,0,0,.16)}
    .row-end{display:flex;gap:8px;justify-content:space-between;margin-top:12px;align-items:center}
    .dup{color:var(--err);font-weight:600}
    .ml{color:#f6c744;font-weight:600}
    .status{font-size:13px}.status.ok{color:var(--ok)}.status.err{color:var(--err)}.status.warn{color:#f6c744}
    .app-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .app-right{display:flex;gap:10px;align-items:center}
    .seg{display:inline-flex;align-items:center;gap:4px;padding:2px;border:1px solid var(--border);border-radius:12px;background:#fff}
    .seg label{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:8px;cursor:pointer;user-select:none;font-size:12px}
    .seg input{display:none}.seg input:checked+span{background:var(--accent);color:#fff;font-weight:700;padding:2px 8px;border-radius:6px}
    @media(max-width:640px){.brand-logo-sm{width:44px}}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- OPCIONAL: si quieres sembrar user por variable global, define esto ANTES de config/guard -->
  <!-- <script>window.PSC_USER = "admin@psccargas.com";</script> -->
  <script src="config.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="guard.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card" id="appCard">
      <div class="app-bar">
        <h2 style="margin:0">Ingrese Facturas de GEL</h2>
        <div class="app-right">
          <div class="seg" title="Cuenta">
            <label><input type="radio" name="account" value="PSC"/><span>PSC</span></label>
            <label><input type="radio" name="account" value="C10PA"/><span>C10PA</span></label>
          </div>
          <div class="small muted" id="whoami"></div>
          <img src="https://i.postimg.cc/L8w6XpRT/PSC-AVION.webp" alt="PSC" class="brand-logo-sm" loading="lazy" style="width:56px;height:auto;opacity:.95"/>
        </div>
      </div>
      <textarea id="paste" placeholder="Pega aqui sin encabezado. Maximo 500 filas."></textarea>
    </div>

    <div class="card" id="previewCard">
      <h3 style="margin:0 0 8px">Vista previa</h3>
      <div class="small muted">
        Corrección: quita <code>]c1</code>, <code>+c1</code>, <code>|</code>; reemplaza <code>\/</code> o <code>/</code> por espacio; conserva guiones <b>(-)</b>.
        Duplicados en <span style="color:var(--err);font-weight:600">rojo</span>, ML en <span style="color:#f6c744;font-weight:600">naranja</span>.
      </div>

      <div id="previewWrap" style="margin-top:12px;overflow:auto">
        <table id="preview">
          <thead><tr><th>#</th><th>Original</th><th>Corregido (preview)</th><th>Peso</th><th>Estado</th><th>Cuenta</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="empty" class="muted small">No hay datos aún.</div>
      </div>

      <div class="row-end">
        <div>
          <div id="statusMsg" class="status muted">Listo para guardar.</div>
          <div id="batchMsg" class="small muted"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="btnClear">Limpiar</button>
          <button class="btn" id="btnExport">Exportar XLSX</button>
          <button class="btn primary" id="btnSave" disabled>Guardar 0 filas</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Seed por URL (?user=)
    (function seedUserFromURL(){
      try {
        const q = new URL(location.href).searchParams.get('user');
        if (q && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(q.trim())) localStorage.setItem('psc_user', q.trim());
      } catch {}
    })();
    // Cargar usuario global
    (function loadGlobalUser(){
      try {
        const g1 = (window.PSC && window.PSC.user && window.PSC.user.email);
        const g2 = (typeof window.PSC_USER === "string") ? window.PSC_USER : null;
        const cand = (typeof g1 === "string" && g1.trim()) ? g1.trim() : (g2 && g2.trim()) || null;
        if (typeof cand === "string" && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(cand)) localStorage.setItem("psc_user", cand);
      } catch (e) { console.error("PSC: error leyendo usuario global", e); }
    })();

    function storageGet(k){ try { return localStorage.getItem(k); } catch { return null; } }
    function storageSet(k,v){ try { localStorage.setItem(k,v); } catch {} }
    function isValidEmail(u){ return typeof u==="string" && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(u.trim()); }
    function resolveUser(){
      const cands = [];
      try { cands.push((window.PSC && window.PSC.user && window.PSC.user.email) || null); } catch {}
      try { cands.push(typeof window.PSC_USER === "string" ? window.PSC_USER : null); } catch {}
      try { cands.push(storageGet("psc_user")); } catch {}
      const u = cands.find(x => typeof x === "string" && x.trim().length) || null;
      return u ? u.trim() : null;
    }

    const FUNCTION_URL = "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/put-tracking";
    const START_URL    = "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/start-upload";
    const EXPORT_URL   = "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/export-today";
    const CHECK_URL    = "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/check-ml";

    const CODE_COL = 2, WEIGHT_COL = 6, DEFAULT_WEIGHT = 0.0, DEFAULT_STATUS = "Centro de Dist. PSC", MAX_ROWS = 500;

    const ui = {
      whoami: document.getElementById("whoami"),
      paste: document.getElementById("paste"),
      btnSave: document.getElementById("btnSave"),
      btnClear: document.getElementById("btnClear"),
      btnExport: document.getElementById("btnExport"),
      previewBody: document.querySelector("#preview tbody"),
      empty: document.getElementById("empty"),
      status: document.getElementById("statusMsg"),
      batchMsg: document.getElementById("batchMsg"),
    };

    let rows = []; // {original, corrected, weight, status, dup}
    let currentUser = null;
    const ACCOUNT_DEFAULT = "PSC";
    let currentAccount = storageGet("psc_account") || ACCOUNT_DEFAULT;
    let saveLocked = false;
    const mlCache = new Map();

    function setStatus(msg, type=""){ ui.status.textContent = msg; ui.status.className = "status " + (type || "muted"); }
    function setBatch(msg){ ui.batchMsg.textContent = msg || ""; }

    function splitLine(line){
      if (line.includes("\t")) return line.split("\t").map(c=>c.trim());
      if (line.includes(",")) return line.split(",").map(c=>c.trim());
      return line.split(/\s{2,}/).map(c=>c.trim()).filter(Boolean);
    }
    function correctPreview(code){
      let s = code ?? "";
      s = s.replace(/\]c1/gi, "");
      s = s.replace(/\+c1/gi, "");
      s = s.replace(/\]/g, "");
      s = s.replace(/\|/g, "");
      s = s.replace(/\\\//g, " ");
      s = s.replace(/\//g, " ");
      return s;
    }
    function markDuplicates(){
      const counts = new Map();
      rows.forEach(r => counts.set(r.corrected, (counts.get(r.corrected)||0)+1));
      rows.forEach(r => r.dup = (counts.get(r.corrected)||0) > 1);
    }
    function render(){
      ui.previewBody.innerHTML = "";
      if (rows.length === 0){
        ui.empty.style.display = "block";
        ui.btnSave.disabled = true;
        ui.btnSave.textContent = "Guardar 0 filas";
        setStatus("Listo para guardar.","muted");
        setBatch("");
        return;
      }
      ui.empty.style.display = "none";
      rows.forEach((r,i)=>{
        const keyCorr = String(r.corrected||"").trim().toLowerCase();
        const keyOrig = String(r.original||"").trim().toLowerCase();
        const isMl = mlCache.get(keyCorr)===true || mlCache.get(keyOrig)===true;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="small muted">${i+1}</td>
          <td class="mono ${r.dup?"dup":""} ${isMl?"ml":""}">${r.original||""}</td>
          <td class="mono ${r.dup?"dup":""} ${isMl?"ml":""}">${r.corrected||""}</td>
          <td class="mono">${Number.isFinite(r.weight)? r.weight.toFixed(2): ""}</td>
          <td class="mono">${r.status}</td>
          <td class="mono">${currentAccount}</td>`;
        ui.previewBody.appendChild(tr);
      });
      ui.btnSave.disabled = saveLocked;
      ui.btnSave.textContent = `Guardar ${rows.length} filas`;
      setStatus("Listo para guardar.","muted");
    }

    async function refreshMlMarks(){
      try {
        const uniq = new Set();
        for (const r of rows){ if (r.original) uniq.add(r.original.trim().toLowerCase()); if (r.corrected) uniq.add(r.corrected.trim().toLowerCase()); }
        const list = Array.from(uniq);
        if (list.length===0) return;
        const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), 8000);
        const res = await fetch(CHECK_URL, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ trackings:list }), signal: ctrl.signal }).catch(()=>null);
        clearTimeout(t);
        if (!res || !res.ok) return;
        const payload = await res.json().catch(()=> ({}));
        if (!payload || payload.ok!==true || !Array.isArray(payload.items)) return;
        for (const it of payload.items){
          const key = String(it.tracking||"").trim().toLowerCase();
          const isMl = Boolean(it.ml || it.ML === "true" || it.status === "ML");
          if (key) mlCache.set(key, isMl);
        }
        render();
      } catch {}
    }

    function parsePasted(){
      const text = ui.paste.value.trim();
      rows = [];
      if (!text){ render(); return; }
      let lines = text.split(/\r?\n/).filter(l=>l.trim().length);
      if (lines.length > MAX_ROWS){
        lines = lines.slice(0, MAX_ROWS);
        setStatus(`Se pegaron más de ${MAX_ROWS} filas: se tomaron las primeras ${MAX_ROWS}.`,"warn");
      }
      const codeIdx0 = Math.max(1, CODE_COL) - 1;
      const weightIdx0 = Math.max(1, WEIGHT_COL) - 1;

      for (const line of lines){
        const cells = splitLine(line);
        if (!cells.length) continue;
        const original = (cells[codeIdx0] ?? "").trim();
        let weight = (cells[weightIdx0] ?? "").toString().replace(",", ".").trim();
        const w = parseFloat(weight);
        const weightNum = Number.isFinite(w) ? w : DEFAULT_WEIGHT;
        if (!original) continue;
        const corrected = correctPreview(original);
        rows.push({ original, corrected, weight: weightNum, status: "Centro de Dist. PSC", dup: false });
      }
      markDuplicates();
      render();
      refreshMlMarks();
    }

    function refreshUI(){
      currentUser = resolveUser();
      if (ui.whoami) ui.whoami.textContent = isValidEmail(currentUser) ? `Conectado: ${currentUser}` : "Conectado: (sin usuario)";
    }

    async function startUpload(expectedRows){
      currentUser = resolveUser();
      if (!isValidEmail(currentUser)){
        setStatus("Usuario inválido o ausente. Defina PSC.user.email, PSC_USER o use ?user=…","err");
        throw new Error("invalid_user");
      }
      const res = await fetch(START_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ expected_rows: expectedRows, user: currentUser, account: currentAccount, cuenta: currentAccount }),
      });
      const txt = await res.text().catch(()=> "");
      let payload = {};
      try { payload = JSON.parse(txt || "{}"); } catch {}
      if (!res.ok){
        const msg = payload.detail || payload.error || res.statusText || `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return payload.batch_id;
    }

    async function saveAll(){
      if (rows.length === 0) return;
      if (!isValidEmail(resolveUser())){
        setStatus("Usuario inválido o ausente. Verifique sesión global.","err");
        return;
      }
      currentUser = resolveUser();

      saveLocked = true;
      ui.btnSave.disabled = true;
      setStatus("Creando lote…","muted");
      setBatch("");

      let batchId;
      try{
        batchId = await startUpload(rows.length);
        setBatch(`Lote: ${batchId}`);
      }catch(e){ setStatus(`No se pudo iniciar el lote: ${e.message}`,"err"); return; }

      setStatus(`Guardando… (lote ${batchId})`,"muted");

      let okCount = 0;
      for (let i=0;i<rows.length;i++){
        const r = rows[i];
        try{
          const res = await fetch(FUNCTION_URL, {
            method:"PUT",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({
              tracking_original: r.original,
              tracking_corrected: r.corrected,
              weight_lbs: r.weight,
              status: r.status,
              batch_id: batchId,
              account: currentAccount,
              cuenta: currentAccount,
              user: currentUser,
            })
          });
          if (!res.ok){
            const txt = await res.text().catch(()=> "");
            let msg = "Error inesperado";
            try { const j = JSON.parse(txt || "{}"); msg = j.error || j.detail || j.message || JSON.stringify(j); }
            catch { msg = txt || res.statusText || `HTTP ${res.status}`; }
            setStatus(`Error en fila ${i+1} (${r.original}): ${msg}. Guardados ${okCount}/${rows.length} (lote ${batchId}).`,"err");
            return;
          }
          okCount++;
        }catch(e){
          setStatus(`Error de red en fila ${i+1} (${r.original}): ${e.message}. Guardados ${okCount}/${rows.length} (lote ${batchId}).`,"err");
          return;
        }
      }
      setStatus(`Guardado ✔️ ${okCount}/${rows.length} (lote ${batchId})`,"ok");
      ui.btnSave.textContent = `Guardado ${okCount}/${rows.length}`;
      mlCache.clear(); render();
    }

    async function exportXlsxTodayForUser(){
      currentUser = resolveUser();
      if (!isValidEmail(currentUser)){ setStatus("Usuario inválido o ausente. Verifique sesión global.","err"); return; }
      setStatus("Preparando XLSX…","muted");

      const res = await fetch(EXPORT_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ user: currentUser })
      });
      const payload = await res.json().catch(()=> ({}));
      if (!res.ok || !payload.ok){
        const msg = payload.detail || payload.error || res.statusText;
        setStatus(`No se pudo exportar: ${msg}`,"err");
        return;
      }

      const trows = payload.rows || [];
      if (trows.length === 0){
        setStatus(payload.message || "No hay trackings pendientes para exportar.","warn"); return;
      }

      const rowsX = trows.map(r => ({
        WAREHOUSE: "",
        TRACKING: String(r.tracking_corrected ?? ""),
        CLIENTE: "",
        PIEZAS: "1",
        PESO: r.weight_lbs == null ? "" : String(r.weight_lbs),
      }));

      const headers = ["WAREHOUSE","TRACKING","CLIENTE","PIEZAS","PESO"];
      const ws = XLSX.utils.json_to_sheet(rowsX, { header: headers });

      const range = XLSX.utils.decode_range(ws["!ref"]);
      for (let R=range.s.r; R<=range.e.r; ++R){
        for (let C=range.s.c; C<=range.e.c; ++C){
          const cellRef = XLSX.utils.encode_cell({ r:R, c:C });
          const cell = ws[cellRef];
          if (!cell) continue;
          cell.t = "s";
          if (typeof cell.v !== "string") cell.v = String(cell.v ?? "");
        }
      }

      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Hoja1");

      const now = new Date(), pad = (n)=> String(n).padStart(2,"0");
      const fname = `corte_${now.getFullYear()}${pad(now.getMonth()+1)}${pad(now.getDate())}_${(currentUser||"user").replace(/[^A-Za-z0-9._-]/g,"-")}.xlsx`;
      XLSX.writeFile(wb, fname);

      setStatus(`XLSX creado (${rowsX.length} filas, todo texto).`,"ok");
    }

    // Eventos
    document.getElementsByName("account").forEach?.call?.(document.getElementsByName("account"), (r)=>{
      r.addEventListener("change", ()=>{ if (r.checked){ currentAccount = r.value; localStorage.setItem("psc_account", currentAccount); render(); }});
    });
    (document.querySelector('input[name="account"][value="'+currentAccount+'"]') as HTMLInputElement)?.click?.();

    ui.paste.addEventListener("input", ()=>{ clearTimeout(window.__debounce); window.__debounce = setTimeout(parsePasted, 200); });
    ui.btnClear.onclick = ()=>{ ui.paste.value=""; rows=[]; saveLocked=false; mlCache.clear(); render(); ui.btnSave.disabled=true; ui.btnSave.textContent="Guardar 0 filas"; setStatus("Listo para guardar.","muted"); setBatch(""); };
    ui.btnSave.onclick = saveAll;
    ui.btnExport.onclick = exportXlsxTodayForUser;

    // Boot
    (function boot(){
      currentUser = resolveUser();
      if (isValidEmail(currentUser)) localStorage.setItem("psc_user", currentUser);
      if (ui.whoami) ui.whoami.textContent = isValidEmail(currentUser) ? `Conectado: ${currentUser}` : "Conectado: (sin usuario)";
    })();
  </script>
</body>
</html>
