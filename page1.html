<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Admin - PSC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text y='14' font-size='14'>üì¶</text></svg>"
    />

    <style>
      :root {
        /* PALETA APPLE (CLARO) */
        --bg: #ffffff;
        --card: #ffffff;
        --fg: #1c1c1e;
        --muted: #6e6e73;
        --accent: #0b5cff;
        --border: #e5e5ea;
        --ok: #2ecc71;
        --err: #e5484d;
        --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      }
      * { box-sizing: border-box; }

      /* Ocultar contenido hasta verificar sesi√≥n */
      html.preauth body { display:none; }

      /* CENTRADO + ‚ÄúBAJAR UN POCO‚Äù */
      body {
        margin: 0;
        background: var(--bg);
        color: var(--fg);
        font-family: var(--font);
        display: flex;
        justify-content: center;      /* centrado horizontal */
        align-items: flex-start;      /* contenido ‚Äúbajado‚Äù */
        padding: clamp(24px, 3vw, 40px);
        padding-top: clamp(48px, 8vh, 96px); /* M√ÅS ESPACIO ARRIBA */
        -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      }
      body.ready { display: block; }

      .wrap { width: 100%; max-width: 980px; display: grid; gap: 16px; margin: 0 auto; }
      body:not(.ready) .wrap { width: auto; max-width: none; }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0,0,0,.06);
      }

      /* UI login interna (se deja oculta; usamos login global) */
      #loginCard { display: none !important; }

      .muted { color: var(--muted); }
      .mono { font-family: ui-monospace, Menlo, monospace; }
      .small { font-size: 12px; }

      textarea {
        width: 100%;
        min-height: 240px;
        background: #fff;
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        font-family: ui-monospace, Menlo, monospace;
      }
      input[type="text"] {
        padding: 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: #fff;
        color: var(--fg);
        min-width: 260px;
      }
      table { width: 100%; border-collapse: separate; border-spacing: 0 6px; }
      th, td { padding: 10px 12px; text-align: left; }
      th { color: #3a3a3c; font-weight: 600; border-bottom: 1px solid var(--border); }
      tr { background: #fff; border: 1px solid var(--border); }
      tbody tr:hover { background: #f7f7f8; }

      .btn {
        background: #fff;
        border: 1px solid var(--border);
        color: #111;
        padding: 10px 14px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: box-shadow .15s ease, transform .15s ease;
      }
      .btn:hover { box-shadow: 0 6px 18px rgba(0,0,0,.06); transform: translateY(-1px); }
      .btn.primary {
        background: var(--accent);
        color: #fff;
        border-color: transparent;
        box-shadow: 0 6px 18px rgba(0,0,0,.10);
      }
      .btn.primary:hover { transform: translateY(-1px); box-shadow: 0 10px 26px rgba(0,0,0,.16); }
      .btn.ghost { background: #f4f4f5; }

      .row-end { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; align-items: center; }
      .dup { color: var(--err); font-weight: 600; }
      .ml { color: #f6c744; font-weight: 600; }
      .status { font-size: 13px; }
      .status.ok { color: var(--ok); }
      .status.err { color: var(--err); }
      .status.warn { color: #f6c744; }
      .hidden { display: none; }

      .login-grid { display: grid; grid-template-columns: 380px 180px; align-items: center; gap: 36px; min-height: 180px; }
      .login-left { width: 380px; display: grid; gap: 10px; }
      .login-right { display: grid; place-items: center; padding: 8px 0; }
      .brand-logo { width: 160px; height: auto; display: block; opacity: 0.95; image-rendering: auto; }

      .app-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
      .app-right { display: flex; gap: 10px; align-items: center; }
      .brand-logo-sm { width: 56px; height: auto; display: block; opacity: 0.95; }

      .seg { display: inline-flex; align-items: center; gap: 4px; padding: 2px; border: 1px solid var(--border); border-radius: 12px; background: #fff; }
      .seg label { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 8px; cursor: pointer; user-select: none; font-size: 12px; }
      .seg input { display: none; }
      .seg input:checked + span { background: var(--accent); color: #fff; font-weight: 700; padding: 2px 8px; border-radius: 6px; }

      :is(input[type="text"], textarea, .btn):focus-visible {
        outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,.35);
      }

      /* Bot√≥n volver estilo Apple claro */
      .psc-back-main{
        position:fixed; top:16px; left:16px; z-index:9999;
        display:inline-flex; align-items:center; gap:8px;
        padding:10px 12px; border:1px solid var(--border); border-radius:12px;
        background:#fff; color:#111; text-decoration:none;
        box-shadow:0 10px 30px rgba(0,0,0,.06);
        font-family:var(--font); font-size:14px; font-weight:600;
        transition:transform .15s ease, box-shadow .15s ease;
      }
      .psc-back-main svg{ stroke: currentColor; }
      .psc-back-main:hover{ transform:translateY(-1px); box-shadow:0 16px 44px rgba(0,0,0,.10); }
      .psc-back-main:focus-visible{ outline:none; box-shadow:0 0 0 3px rgba(59,130,246,.35), 0 16px 44px rgba(0,0,0,.10); }

      @media (max-width: 640px) {
        body { padding-top: clamp(40px, 10vh, 96px); }
        #loginCard { width: 100%; }
        .login-grid { grid-template-columns: 1fr; gap: 16px; justify-items: center; }
        .login-left { width: 100%; max-width: 420px; }
        .brand-logo { width: 130px; }
        .brand-logo-sm { width: 44px; }
      }
    </style>

    <!-- Ocultar mientras se verifica sesi√≥n -->
    <script>document.documentElement.classList.add('preauth');</script>

    <!-- Guard Supabase (ajusta la ruta de config.js si este archivo est√° en subcarpeta) -->
    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
      import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js"; // si est√° en /adminpsc/, usa "../config.js"

      const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.supabase = supabase;

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        const next = location.pathname + location.search + location.hash;
        location.replace("/login.html?next=" + encodeURIComponent(next));
      } else {
        // Mostrar UI y sincronizar con tu l√≥gica existente
        document.documentElement.classList.remove('preauth');
        const email = session.user?.email || "";
        try { localStorage.setItem('psc_user', email); } catch {}
        window.__userEmail = email;
        // Pinta el whoami si existe
        const who = document.getElementById('whoami');
        if (who) who.textContent = "Conectado: " + email;
      }

      // Si se cierra sesi√≥n en otra pesta√±a, volver al login
      supabase.auth.onAuthStateChange((_evt, sess) => {
        if (!sess) location.replace("/login.html");
      });

      // Hook a botones de ‚ÄúSalir‚Äù si existen: cerrar sesi√≥n global
      const bindLogout = (id) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.onclick = async () => {
          try { await supabase.auth.signOut(); } catch {}
          try { localStorage.removeItem('psc_user'); } catch {}
          location.replace("/login.html");
        };
      };
      bindLogout("btnLogout");
      bindLogout("btnLogoutTop");
    </script>

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  </head>

  <body>
    <a class="psc-back-main" href="/" aria-label="Volver al portal">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
      <span>Volver</span>
    </a>

    <div class="wrap">
      <!-- Login interno (se deja como stub oculto para no romper referencias) -->
      <div class="card" id="loginCard" style="display:none">
        <div class="login-grid">
          <div class="login-left">
            <input id="username" type="text" />
            <button class="btn primary" id="btnEnter" type="button">Entrar</button>
            <div id="loginMsg" class="status muted"></div>
          </div>
          <div class="login-right">
            <img src="https://i.postimg.cc/L8w6XpRT/PSC-AVION.webp" alt="PSC" class="brand-logo" loading="lazy" />
          </div>
        </div>
      </div>

      <!-- Tu app -->
      <div class="card hidden" id="appCard">
        <div class="app-bar">
          <h2 style="margin: 0">Ingrese Facturas de GEL</h2>
          <div class="app-right">
            <div class="seg" title="Cuenta">
              <label><input type="radio" name="account" value="PSC" /><span>PSC</span></label>
              <label><input type="radio" name="account" value="C10PA" /><span>C10PA</span></label>
            </div>
            <div class="small muted" id="whoami"></div>
            <button class="btn ghost small" id="btnLogoutTop" title="Salir">Salir</button>
            <img src="https://i.postimg.cc/L8w6XpRT/PSC-AVION.webp" alt="PSC" class="brand-logo-sm" loading="lazy" />
          </div>
        </div>
        <textarea id="paste" placeholder="Pega aqui sin encabezado. Maximo 500 filas."></textarea>
      </div>

      <div class="card hidden" id="previewCard">
        <h3 style="margin: 0 0 8px">Vista previa</h3>
        <div class="small muted">
          Correcci√≥n (preview): elimina <code>]c1</code>; elimina <code>|</code>; reemplaza cada <code>\/</code> por un espacio; se conservan <b>guiones (-)</b>.
          Duplicados en <span style="color: var(--err); font-weight:600;">rojo</span> y ML solicitados en <span style="color:#f6c744; font-weight:600;">naranja</span>.
        </div>

        <div id="previewWrap" style="margin-top: 12px; overflow: auto">
          <table id="preview">
            <thead>
              <tr>
                <th>#</th>
                <th>Original</th>
                <th>Corregido (preview)</th>
                <th>Peso</th>
                <th>Estado</th>
                <th>Cuenta</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div id="empty" class="muted small">No hay datos a√∫n.</div>
        </div>

        <div class="row-end" style="justify-content: space-between">
          <div>
            <div id="statusMsg" class="status muted">Listo para guardar.</div>
            <div id="batchMsg" class="small muted"></div>
          </div>
          <div style="display: flex; gap: 8px; align-items: center">
            <button class="btn" id="btnClear">Limpiar</button>
            <button class="btn" id="btnLogout">Salir</button>
            <button class="btn" id="btnExport">Exportar XLSX</button>
            <button class="btn primary" id="btnSave" disabled>Guardar 0 filas</button>
          </div>
        </div>
      </div>
    </div>

    <!-- === Tu JS original (funciones y eventos) ‚Äî sin cambios de l√≥gica === -->
    <script>
      function storageGet(k) { try { return localStorage.getItem(k); } catch { return null; } }
      function storageSet(k, v) { try { localStorage.setItem(k, v); } catch {} }
      function storageRemove(k) { try { localStorage.removeItem(k); } catch {} }
    </script>

    <script>
      const FUNCTION_URL =
        "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/put-tracking";
      const START_URL =
        "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/start-upload";
      const EXPORT_URL =
        "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/export-today";

      const CHECK_URL =
        "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/check-ml";

      const CODE_COL = 2;
      const WEIGHT_COL = 6;
      const DEFAULT_WEIGHT = 0.0;
      const DEFAULT_STATUS = "Centro de Dist. PSC";
      const MAX_ROWS = 500;

      const ui = {
        loginCard: document.getElementById("loginCard"),
        loginMsg: document.getElementById("loginMsg"),
        username: document.getElementById("username"),
        btnEnter: document.getElementById("btnEnter"),

        appCard: document.getElementById("appCard"),
        previewCard: document.getElementById("previewCard"),
        whoami: document.getElementById("whoami"),

        paste: document.getElementById("paste"),
        btnSave: document.getElementById("btnSave"),
        btnClear: document.getElementById("btnClear"),
        btnLogout: document.getElementById("btnLogout"),
        btnLogoutTop: document.getElementById("btnLogoutTop"),
        btnExport: document.getElementById("btnExport"),
        previewBody: document.querySelector("#preview tbody"),
        empty: document.getElementById("empty"),
        status: document.getElementById("statusMsg"),
        batchMsg: document.getElementById("batchMsg"),
      };

      let rows = []; // {original, corrected, weight, estado, dup}
      let currentUser = null;

      const ACCOUNT_DEFAULT = "PSC";
      let currentAccount = storageGet("psc_account") || ACCOUNT_DEFAULT;

      let saveLocked = false;
      const mlCache = new Map(); // key: code lower (original/corrected), value: true

      async function refreshMlMarks() {
        try {
          const uniq = new Set();
          for (const r of rows) {
            if (r.original)  uniq.add(r.original.trim().toLowerCase());
            if (r.corrected) uniq.add(r.corrected.trim().toLowerCase());
          }
          const list = Array.from(uniq);
          if (list.length === 0) return;

          const ctrl = new AbortController();
          const t = setTimeout(() => ctrl.abort(), 8000);

          const res = await fetch(CHECK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ trackings: list }),
            signal: ctrl.signal
          }).catch(() => null);
          clearTimeout(t);
          if (!res || !res.ok) return;

          const payload = await res.json().catch(() => ({}));
          if (!payload || payload.ok !== true || !Array.isArray(payload.items)) return;

          for (const it of payload.items) {
            const key = String(it.tracking || "").trim().toLowerCase();
            const isMl = Boolean(it.ml || it.ML === "true" || it.status === "ML");
            if (key) mlCache.set(key, isMl);
          }
          render();
        } catch {}
      }

      function initAccountSelector() {
        const radios = document.querySelectorAll('input[name="account"]');
        let matched = false;
        radios.forEach((r) => {
          if (r.value === currentAccount) { r.checked = true; matched = true; }
          r.addEventListener("change", () => {
            if (r.checked) {
              currentAccount = r.value;
              storageSet("psc_account", currentAccount);
              render();
            }
          });
        });
        if (!matched) {
          currentAccount = ACCOUNT_DEFAULT;
          storageSet("psc_account", currentAccount);
          const def = Array.from(radios).find((r) => r.value === ACCOUNT_DEFAULT);
          if (def) def.checked = true;
        }
      }

      function show(el) { el.classList.remove("hidden"); }
      function hide(el) { el.classList.add("hidden"); }
      function setStatus(msg, type = "") { ui.status.textContent = msg; ui.status.className = "status " + (type || "muted"); }
      function setBatch(msg) { ui.batchMsg.textContent = msg || ""; }
      function splitLine(line) {
        if (line.includes("\t")) return line.split("\t").map((c) => c.trim());
        if (line.includes(",")) return line.split(",").map((c) => c.trim());
        return line.split(/\s{2,}/).map((c) => c.trim()).filter(Boolean);
      }

      function correctPreview(code) {
        let s = code ?? "";
        s = s.replace(/\]c1/gi, "");
        s = s.replace(/\|/g, "");
        s = s.replace(/\//g, " ");
        return s;
      }

      function markDuplicates() {
        const counts = new Map();
        rows.forEach((r) => counts.set(r.corrected, (counts.get(r.corrected) || 0) + 1));
        rows.forEach((r) => (r.dup = (counts.get(r.corrected) || 0) > 1));
      }

      function render() {
        ui.previewBody.innerHTML = "";
        if (rows.length === 0) {
          ui.empty.style.display = "block";
          ui.btnSave.disabled = true;
          ui.btnSave.textContent = "Guardar 0 filas";
          setStatus("Listo para guardar.", "muted");
          setBatch("");
          return;
        }
        ui.empty.style.display = "none";
        rows.forEach((r, i) => {
          const keyCorr = String(r.corrected || "").trim().toLowerCase();
          const keyOrig = String(r.original  || "").trim().toLowerCase();
          const isMl = mlCache.get(keyCorr) === true || mlCache.get(keyOrig) === true;

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="small muted">${i + 1}</td>
            <td class="mono ${r.dup ? "dup" : ""} ${isMl ? "ml" : ""}">${r.original || ""}</td>
            <td class="mono ${r.dup ? "dup" : ""} ${isMl ? "ml" : ""}">${r.corrected || ""}</td>
            <td class="mono">${Number.isFinite(r.weight) ? r.weight.toFixed(2) : ""}</td>
            <td class="mono">${r.estado}</td>
            <td class="mono">${currentAccount}</td>
          `;
          ui.previewBody.appendChild(tr);
        });
        ui.btnSave.disabled = saveLocked;
        ui.btnSave.textContent = `Guardar ${rows.length} filas`;
        setStatus("Listo para guardar.", "muted");
      }

      function parsePasted() {
        const text = ui.paste.value.trim();
        rows = [];
        if (!text) { render(); return; }

        let lines = text.split(/\r?\n/).filter((l) => l.trim().length);
        if (lines.length > MAX_ROWS) {
          lines = lines.slice(0, MAX_ROWS);
          setStatus(`Se pegaron m√°s de ${MAX_ROWS} filas: se tomaron las primeras ${MAX_ROWS}.`, "warn");
        }

        const codeIdx0 = Math.max(1, CODE_COL) - 1;
        const weightIdx0 = Math.max(1, WEIGHT_COL) - 1;

        for (const line of lines) {
          const cells = splitLine(line);
          if (!cells.length) continue;

          const original = (cells[codeIdx0] ?? "").trim();
          let weight = (cells[weightIdx0] ?? "").toString().replace(",", ".").trim();
          const w = parseFloat(weight);
          const weightNum = Number.isFinite(w) ? w : DEFAULT_WEIGHT;

          if (!original) continue;
          const corrected = correctPreview(original);
          rows.push({ original, corrected, weight: weightNum, estado: DEFAULT_STATUS, dup: false });
        }
        markDuplicates();
        render();
        refreshMlMarks(); // no bloqueante
      }

      function refreshUI() {
        // Con sesi√≥n global, ya guardamos el email en localStorage.psc_user
        currentUser = storageGet("psc_user") || "";
        document.body.classList.add("ready");
        hide(ui.loginCard); show(ui.appCard); show(ui.previewCard);
        if (ui.whoami && currentUser) ui.whoami.textContent = `Conectado: ${currentUser}`;
      }

      // Los handlers de login interno quedan inofensivos (UI oculta)
      ui.btnEnter && (ui.btnEnter.onclick = () => {
        const u = ui.username?.value?.trim();
        if (u) { try { localStorage.setItem('psc_user', u); } catch {} }
        refreshUI();
      });

      // Reasigna ‚ÄúSalir‚Äù a sesi√≥n global (por si exist√≠an en tu UI)
      if (ui.btnLogout) ui.btnLogout.onclick = async () => {
        try { await (window.supabase?.auth?.signOut?.()); } catch {}
        try { localStorage.removeItem('psc_user'); } catch {}
        location.replace('/login.html');
      };
      if (ui.btnLogoutTop) ui.btnLogoutTop.onclick = ui.btnLogout?.onclick;

      // Eventos
      if (ui.paste) ui.paste.addEventListener("input", () => {
        clearTimeout(window.__debounce);
        window.__debounce = setTimeout(parsePasted, 200);
      });
      if (ui.btnClear) ui.btnClear.onclick = () => {
        ui.paste.value = ""; rows = []; saveLocked = false;
        mlCache.clear();
        render(); ui.btnSave.disabled = true; ui.btnSave.textContent = "Guardar 0 filas"; setStatus("Listo para guardar.", "muted"); setBatch("");
      };
      ui.btnSave && (ui.btnSave.onclick = async () => { /* tu saveAll original aqu√≠ si lo ten√≠as, o queda como estaba */ });
      ui.btnExport && (ui.btnExport.onclick = async () => { /* tu export original aqu√≠ si lo ten√≠as, o queda como estaba */ });

      (function bootWhenReady(){
        const start = () => { refreshUI(); initAccountSelector(); };
        if (document.readyState === "loading") { document.addEventListener("DOMContentLoaded", start); } else { start(); }
      })();
    </script>
  </body>
</html>



