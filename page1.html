<!DOCTYPE html>
<html lang="es">
  <head>
  <style id="psc-portal-style">
    .psc-portal-header{
      position:fixed; top:0; left:0; right:0;
      display:flex; justify-content:space-between; align-items:center;
      min-height:56px;
      padding: max(12px, env(safe-area-inset-top)) 16px 12px 16px;
      background:#fff; border-bottom:1px solid #e5e5ea;
      box-shadow:0 6px 18px rgba(0,0,0,.04); z-index: 9999;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      -webkit-tap-highlight-color:transparent;
    }
    @media (max-width:480px){
      .psc-portal-header{
        min-height:60px;
        padding: calc(env(safe-area-inset-top) + 10px) 12px 10px 12px;
      }
    }
    .psc-row{display:flex; gap:.6rem; align-items:center;}
    .psc-user{font-size:.9rem; color:#6e6e73;}
    .psc-btn{
      padding:.5rem .75rem; border:1px solid #e5e5ea; border-radius:12px;
      background:#fff; cursor:pointer; font-weight:600;
      min-height:36px;
    }
    .psc-btn.ghost{background:#f4f4f5; border-color:#e5e5ea;}
    @media (max-width:480px){
      .psc-btn{min-height:44px; padding:.6rem .9rem;}
    }
    .psc-portal-spacer{height:64px}
    @media (max-width:480px){ .psc-portal-spacer{height:72px} }
    .psc-portal-header strong{ text-transform: uppercase; letter-spacing:.02em; }

    /* --- Nav en header (estilo Apple) --- */
    .psc-nav { display:flex; gap:.5rem; flex-wrap:wrap; margin-left:.75rem; }
    .psc-nav a{
      text-decoration:none; color:#111; font-weight:600;
      border:1px solid #e5e5ea; background:#fff; padding:.45rem .7rem;
      border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.04);
    }
    .psc-nav a:hover{ background:#f7f7f8; }
    .psc-nav a.active{
      background:#0b5cff; border-color:transparent; color:#fff; box-shadow:0 6px 18px rgba(0,0,0,.10);
    }
    @media (max-width:480px){
      .psc-nav { margin-left:.5rem; }
      .psc-nav a { padding:.55rem .8rem; }
    }
    /* Mensaje de error visible si falta config.js */
    .psc-error {
      position:fixed; inset:auto 12px 12px 12px;
      background:#fff; border:1px solid #e5e5ea; border-left:4px solid #e5484d;
      border-radius:12px; padding:.9rem 1rem; box-shadow:0 10px 30px rgba(0,0,0,.06);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
      color:#1c1c1e;
    }
  </style>
  <title>SUBIR CORTE — PSC Apps</title>

  <!-- Pre-auth: oculta hasta verificar sesión -->
  <style>html.preauth body{display:none}</style>
  <script>document.documentElement.classList.add('preauth');</script>

  <!-- Guard Supabase -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    let SUPABASE_URL, SUPABASE_ANON_KEY;

    try {
      const cfg = await import("./config.js"); // OJO: si moviste este archivo a una carpeta, usa ../config.js
      SUPABASE_URL = cfg.SUPABASE_URL;
      SUPABASE_ANON_KEY = cfg.SUPABASE_ANON_KEY;
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY) throw new Error("Variables vacías en config.js");
    } catch (e) {
      const m = document.createElement('div');
      m.className = 'psc-error';
      m.innerHTML = "<strong>Error:</strong> No se pudo cargar <code>config.js</code> o faltan claves.<br>Coloca <code>config.js</code> en la raíz con SUPABASE_URL y SUPABASE_ANON_KEY.";
      document.body.appendChild(m);
      console.error("No se pudo cargar config.js:", e);
      throw e; // detiene aquí para no seguir con cliente inválido
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabase = supabase;

    const { data: { session } } = await supabase.auth.getSession();
    if(!session){
      const next = location.pathname + location.search + location.hash;
      location.replace("/login.html?next=" + encodeURIComponent(next));
    } else {
      document.documentElement.classList.remove('preauth');
      window.__userEmail = (session.user?.email || "");
    }
    supabase.auth.onAuthStateChange((_evt, sess) => {
      if(!sess) location.replace("/login.html");
    });
  </script>

  <!-- Estilo Apple/light -->
  <style id="psc-apple-override">
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --fg: #1c1c1e;
      --muted: #6e6e73;
      --accent: #0b5cff;
      --border: #e5e5ea;
      --ok: #2ecc71;
      --err: #e5484d;
      --font: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    }
    html, body { background:#ffffff !important; color:var(--fg); }
    .card { background:#fff !important; border:1px solid var(--border) !important; box-shadow:0 10px 30px rgba(0,0,0,.06) !important; }
    textarea, input[type="text"] { background:#fff !important; color:var(--fg) !important; border:1px solid var(--border) !important; }
    table { border-collapse: separate; border-spacing: 0 6px; }
    tr { background:#fff !important; border:1px solid var(--border) !important; }
    tbody tr:hover { background:#fafafa !important; }
    .btn { background:#fff !important; color:#111 !important; border:1px solid var(--border) !important; }
    .btn.primary { background:var(--accent) !important; color:#fff !important; border-color:transparent !important; box-shadow:0 6px 18px rgba(0,0,0,.10) !important; }
    .btn.ghost { background:#f4f4f5 !important; }
    .psc-back-main{ background:#fff !important; color:#111 !important; border:1px solid var(--border) !important; box-shadow:0 10px 30px rgba(0,0,0,.06) !important; }
  </style>
</head>

<body>
  <header class="psc-portal-header">
    <div class="psc-row">
      <strong>SUBIR CORTE</strong>
      <nav class="psc-nav" aria-label="Navegación módulos">
        <!-- Si tu portal es la portada, usa '/'. Si prefieres portal.html de redirección, cambia a /portal.html -->
        <a href="/" id="psc-link-portal">Portal</a>
        <a href="/page2.html" id="psc-link-ml">MAL IDENTIFICADOS</a>
        <a href="/page3.html" id="psc-link-buscador">BUSCADOR PSC</a>
      </nav>
    </div>
    <div class="psc-row">
      <span class="psc-user">Conectado: <span id="psc-user-email"></span></span>
      <button id="psc-logout" class="psc-btn ghost">Salir</button>
    </div>
  </header>
  <div class="psc-portal-spacer"></div>

  <script>
    (function(){
      try {
        var span = document.getElementById('psc-user-email');
        if (span && window.__userEmail) span.append(document.createTextNode(window.__userEmail));
      } catch(e) {}
      var btn = document.getElementById('psc-logout');
      if (btn) btn.addEventListener('click', async function(){
        try { await (window.supabase && window.supabase.auth && window.supabase.auth.signOut && window.supabase.auth.signOut()); } catch(e){}
        location.replace('/login.html');
      });
    })();
  </script>

  <!-- ======= AQUÍ EMPIEZA TU FRONT (SUBIR CORTE) — LÓGICA INTACTA ======= -->
  <main id="app" class="app">
    <div class="container" style="max-width:1100px;margin:0 auto;padding:1rem">
      <!-- Stub del login interno (oculto) para no romper referencias JS -->
      <div class="card" id="loginCard" style="display:none">
        <input id="username" type="hidden" value="">
        <button class="btn" id="btnEnter" type="button" style="display:none">Entrar</button>
        <div id="loginMsg" class="status muted" style="display:none"></div>
      </div>

      <!-- … Tu HTML original de la app … -->

    </div>
  </main>
  <!-- ======= AQUÍ TERMINA TU FRONT ======= -->

  <script>
    // === Tu JS original (lógica intacta) ===
    const ui = {
      loginCard: document.getElementById("loginCard"),
      username: document.getElementById("username"),
      btnEnter: document.getElementById("btnEnter"),
      loginMsg: document.getElementById("loginMsg"),
      paste: document.getElementById("paste"),
      preview: document.getElementById("preview"),
      btnClear: document.getElementById("btnClear"),
      btnSave: document.getElementById("btnSave"),
      btnExport: document.getElementById("btnExport"),
      status: document.getElementById("status"),
      account: document.getElementById("account"),
      setStatus: document.getElementById("setStatus"),
      setBatch: document.getElementById("setBatch"),
      batch: document.getElementById("batch"),
      selectAll: document.getElementById("selectAll"),
      filterInput: document.getElementById("filterInput"),
    };

    let currentUser = (window.__userEmail || "").trim() || null;
    let rows = [];
    let saveLocked = false;

    function setStatus(msg, cls=""){
      if (!ui.status) return;
      ui.status.textContent = msg || "";
      ui.status.className = "";
      if (cls) ui.status.classList.add(cls);
    }

    // Parche estético: si no existe loginCard visible, no intentar mostrarlo
    function refreshUI() {
      if (!ui.loginCard) { document.body.classList.add("ready"); }
      if (currentUser) {
        if (ui.loginCard) ui.loginCard.style.display = "none";
        if (ui.paste) ui.paste.disabled = false;
        if (ui.btnSave) ui.btnSave.disabled = rows.length === 0 || saveLocked;
      } else {
        if (ui.loginCard) ui.loginCard.style.display = "none";
        if (ui.paste) ui.paste.disabled = true;
        if (ui.btnSave) ui.btnSave.disabled = true;
      }
    }

    function render(){
      if(!ui.preview) return;
      // ... tu render original ...
    }

    // === Resto de funciones originales ===
    function storageGet(k){ try { return JSON.parse(localStorage.getItem(k)); } catch(e){ return null; } }
    function storageSet(k,v){ try { localStorage.setItem(k, JSON.stringify(v)); } catch(e){} }

    const mlCache = new Map();

    function parsePasted(text){
      // ... tu parser original ...
      return [];
    }

    async function saveAll(){
      // ... tu save original ...
    }

    function exportXlsxTodayForUser(){
      // ... tu export original ...
    }

    function initAccountSelector(){
      // ... tu init original ...
    }

    // Eventos
    if (ui.paste) ui.paste.addEventListener("input", () => {
      const text = ui.paste.value || "";
      rows = parsePasted(text);
      render();
      if (ui.btnSave) ui.btnSave.disabled = rows.length === 0 || saveLocked;
    });
    if (ui.btnClear) ui.btnClear.onclick = () => {
      if (!confirm("¿Limpiar el área de pegado y la vista previa?")) return;
      ui.paste.value = ""; rows = []; saveLocked = false;
      mlCache.clear();
      render(); ui.btnSave.disabled = true; ui.btnSave.textContent = "Guardar filas"; setStatus("Listo para guardar.", "muted"); setBatch("");
    };
    ui.btnSave && (ui.btnSave.onclick = saveAll);
    ui.btnExport && (ui.btnExport.onclick = exportXlsxTodayForUser);

    (function bootWhenReady(){ const start = () => { currentUser = (window.__userEmail || "").trim() || null; refreshUI(); initAccountSelector(); };
      if (document.readyState === "loading") { document.addEventListener("DOMContentLoaded", start); } else { start(); }
    })();

    // Marca el link activo (opcional)
    (function(){
      document.querySelector('.psc-nav a[href="/page1.html"]')?.classList.add('active');
    })();
  </script>
</body>
</html>


