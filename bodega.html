<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepci√≥n de Paquetes por Lote</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; max-width: 90vw; margin: auto; padding: 10px; }
        button { font-size: 1.1em; padding: 10px 15px; margin: 5px; cursor: pointer; border-radius: 8px; border: none; }
        #startScreen, #captureScreen { text-align: center; }
        #video-container { position: relative; max-width: 640px; margin: 15px auto; }
        video { width: 100%; border-radius: 8px; }
        #captureButton { background-color: #007bff; color: white; width: 80%; }
        #saveButton { background-color: #28a745; color: white; }
        #resetButton { background-color: #ffc107; color: black; } /* Estilo para el nuevo bot√≥n */
        #preview { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .photo-container { border: 1px solid #ccc; padding: 5px; text-align: center; position: relative; }
        .photo-container img { width: 120px; height: 120px; object-fit: cover; }
        .photo-container .delete-button { position: absolute; top: 0; right: 0; background-color: rgba(255, 0, 0, 0.7); color: white; border: none; cursor: pointer; }
        .status { font-weight: bold; }
        .status.success { color: green; }
        .status.error { color: red; }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1>Recepci√≥n de Paquetes</h1>
        <button id="startButton">‚ñ∂Ô∏è Iniciar Recepci√≥n</button>
    </div>

    <div id="captureScreen" style="display:none;">
        <h2>Lote de Recepci√≥n</h2>
        <p>ID del Lote: <b id="loteIdDisplay"></b></p>
        
        <div id="video-container">
            <video id="video" autoplay playsinline></video>
        </div>
        <button id="captureButton">üì∏ Capturar Foto</button>
        <hr>
        <div id="preview"></div>
        <hr>
        <button id="saveButton">‚úÖ Guardar Lote</button>
        <button id="resetButton" style="display: none;">üßπ Limpiar para Nuevo Lote</button>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const SUPABASE_URL = 'https://ztdkaxbgpogudtrdgzic.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZGtheGJncG9ndWR0cmRnemljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDE2MDYsImV4cCI6MjA3MDQxNzYwNn0.mpjY5nWiS48O0DAUkCL7Jl6agF6LurNGeaY8d1u70Po';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const startScreen = document.getElementById('startScreen');
        const captureScreen = document.getElementById('captureScreen');
        const startButton = document.getElementById('startButton');
        const video = document.getElementById('video');
        const captureButton = document.getElementById('captureButton');
        const canvas = document.getElementById('canvas');
        const saveButton = document.getElementById('saveButton');
        const resetButton = document.getElementById('resetButton'); // Referencia al nuevo bot√≥n
        const preview = document.getElementById('preview');
        const loteIdDisplay = document.getElementById('loteIdDisplay');

        let loteId = null;
        let photosInBatch = [];
        let stream = null;

        // INICIAR RECEPCI√ìN Y C√ÅMARA
        startButton.addEventListener('click', async () => {
            loteId = crypto.randomUUID();
            loteIdDisplay.textContent = loteId;
            startScreen.style.display = 'none';
            captureScreen.style.display = 'block';

            try {
                if (stream) stream.getTracks().forEach(track => track.stop());
                const constraints = { video: { facingMode: 'environment' } };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
            } catch (err) {
                console.error("Error al acceder a la c√°mara:", err);
                alert("No se pudo acceder a la c√°mara. Revisa los permisos.");
            }
        });

        // CAPTURAR FOTO
        captureButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob((blob) => {
                const photoId = `photo-${Date.now()}`;
                const photoFile = new File([blob], `${photoId}.jpg`, { type: 'image/jpeg' });
                addPhotoToPreview(photoFile, photoId);
            }, 'image/jpeg');
        });

        function addPhotoToPreview(file, photoId) {
            const photoContainer = document.createElement('div');
            // ... (c√≥digo para a√±adir a la vista previa es el mismo)
            photoContainer.className = 'photo-container';
            photoContainer.id = photoId;
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status';
            statusDiv.textContent = 'Pendiente';
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-button';
            deleteButton.textContent = 'X';
            deleteButton.onclick = () => {
                photosInBatch = photosInBatch.filter(p => p.id !== photoId);
                photoContainer.remove();
            };
            photoContainer.appendChild(img);
            photoContainer.appendChild(statusDiv);
            photoContainer.appendChild(deleteButton);
            preview.appendChild(photoContainer);
            photosInBatch.push({ file: file, id: photoId, element: photoContainer });
        }

        // GUARDAR LOTE
        saveButton.addEventListener('click', async () => {
            if (photosInBatch.length === 0) {
                alert('Captura al menos una foto para el lote.');
                return;
            }
            saveButton.disabled = true;
            captureButton.disabled = true;
            saveButton.textContent = 'Guardando...';

            for (const photo of photosInBatch) {
                // ... (la l√≥gica de subida y guardado es la misma)
                const statusDiv = photo.element.querySelector('.status');
                try {
                    statusDiv.textContent = 'Subiendo...';
                    const fileName = `${loteId}/${photo.file.name}`;
                    const { error: uploadError } = await supabaseClient.storage.from('fotos_paquetes_test').upload(fileName, photo.file);
                    if (uploadError) throw uploadError;
                    const { data: urlData } = supabaseClient.storage.from('fotos_paquetes_test').getPublicUrl(fileName);
                    const { error: insertError } = await supabaseClient.from('paquetes_cargados_test').insert([{ foto_url: urlData.publicUrl, lote_id: loteId }]);
                    if (insertError) throw insertError;
                    statusDiv.textContent = '‚úÖ Guardado';
                    statusDiv.className = 'status success';
                } catch (error) {
                    console.error(`Error procesando ${photo.file.name}:`, error);
                    statusDiv.textContent = '‚ùå Error';
                    statusDiv.className = 'status error';
                }
            }

            saveButton.textContent = '‚úÖ Proceso Finalizado';
            if (stream) stream.getTracks().forEach(track => track.stop());

            // 2. MOSTRAR EL BOT√ìN DE LIMPIAR Y OCULTAR LOS OTROS
            captureButton.style.display = 'none';
            saveButton.style.display = 'none';
            resetButton.style.display = 'inline-block';
        });
        
        // 3. L√ìGICA DEL NUEVO BOT√ìN "LIMPIAR"
        resetButton.addEventListener('click', () => {
            // Resetear variables y vista previa
            photosInBatch = [];
            preview.innerHTML = '';
            loteId = null;

            // Ocultar pantalla de captura y mostrar la de inicio
            captureScreen.style.display = 'none';
            startScreen.style.display = 'block';

            // Restaurar los botones para el pr√≥ximo lote
            captureButton.style.display = 'inline-block';
            saveButton.style.display = 'inline-block';
            resetButton.style.display = 'none';
            
            saveButton.disabled = false;
            captureButton.disabled = false;
            saveButton.textContent = '‚úÖ Guardar Lote';
        });
    </script>
</body>
</html>
