<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepci√≥n de Paquetes por Lote</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; max-width: 90vw; margin: auto; padding: 10px; }
        button { font-size: 1.1em; padding: 10px 15px; margin: 5px; cursor: pointer; border-radius: 8px; border: none; }
        #startScreen, #captureScreen { text-align: center; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group select, .form-group input { width: 80%; max-width: 300px; padding: 8px; font-size: 1em; border-radius: 5px; border: 1px solid #ccc; }
        #video-container { position: relative; max-width: 640px; margin: 15px auto; }
        video { width: 100%; border-radius: 8px; }
        #captureButton { background-color: #007bff; color: white; width: 80%; }
        #saveButton { background-color: #28a745; color: white; }
        #resetButton { background-color: #ffc107; color: black; }
        #preview { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .photo-container { border: 1px solid #ccc; padding: 5px; text-align: center; position: relative; }
        .photo-container img { width: 120px; height: 120px; object-fit: cover; }
        .photo-container .delete-button { position: absolute; top: 0; right: 0; background-color: rgba(255, 0, 0, 0.7); color: white; border: none; cursor: pointer; }
        .status { font-weight: bold; }
        .status.success { color: green; }
        .status.error { color: red; }
        #photoCounter { font-size: 1.2em; margin-bottom: 10px; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1>Recepci√≥n de Paquetes</h1>
        
        <div class="form-group">
            <label for="tipoSelect">Tipo:</label>
            <select id="tipoSelect">
                <option value="Cajas">Cajas</option>
                <option value="Paquetes">Paquetes</option>
            </select>
        </div>

        <div class="form-group">
            <label for="totalInput">Total a recibir:</label>
            <input type="number" id="totalInput" placeholder="Ej: 25">
        </div>

        <div class="form-group">
            <label for="cuentaSelect">Cuenta:</label>
            <select id="cuentaSelect">
                <option value="PSC">PSC</option>
                <option value="C10PA">C10PA</option>
            </select>
        </div>
        
        <button id="startButton">‚ñ∂Ô∏è Iniciar Recepci√≥n</button>
    </div>

    <div id="captureScreen" style="display:none;">
        <h2>Lote de Recepci√≥n</h2>
        <p>ID del Lote: <b id="loteIdDisplay"></b></p>
        
        <p id="photoCounter">Fotos Capturadas: 0</p>
        
        <div id="video-container">
            <video id="video" autoplay playsinline></video>
        </div>
        <button id="captureButton">üì∏ Capturar Foto</button>
        <hr>
        <div id="preview"></div>
        <hr>
        <button id="saveButton">‚úÖ Guardar Lote</button>
        <button id="resetButton" style="display: none;">üßπ Limpiar para Nuevo Lote</button>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const SUPABASE_URL = 'https://ztdkaxbgpogudtrdgzic.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZGtheGJncG9ndWR0cmRnemljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDE2MDYsImV4cCI6MjA3MDQxNzYwNn0.mpjY5nWiS48O0DAUkCL7Jl6agF6LurNGeaY8d1u70Po';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Elementos de la UI
        const startScreen = document.getElementById('startScreen');
        const captureScreen = document.getElementById('captureScreen');
        const startButton = document.getElementById('startButton');
        const video = document.getElementById('video');
        const captureButton = document.getElementById('captureButton');
        const canvas = document.getElementById('canvas');
        const saveButton = document.getElementById('saveButton');
        const resetButton = document.getElementById('resetButton');
        const preview = document.getElementById('preview');
        const loteIdDisplay = document.getElementById('loteIdDisplay');
        const photoCounter = document.getElementById('photoCounter');
        
        // Nuevos campos del formulario
        const tipoSelect = document.getElementById('tipoSelect');
        const totalInput = document.getElementById('totalInput');
        const cuentaSelect = document.getElementById('cuentaSelect');

        // Variables de estado
        let loteId = null;
        let photosInBatch = [];
        let stream = null;
        let loteInfo = {}; // Objeto para guardar la info del lote

        function updatePhotoCounter() {
            const totalARecibir = loteInfo.totalARecibir || 0;
            photoCounter.textContent = `Fotos Capturadas: ${photosInBatch.length} / ${totalARecibir}`;
        }

        startButton.addEventListener('click', async () => {
            const totalARecibirValue = totalInput.value;
            if (!totalARecibirValue || parseInt(totalARecibirValue) <= 0) {
                alert('Por favor, ingresa un "Total a recibir" v√°lido.');
                return;
            }
            
            loteInfo = {
                tipo: tipoSelect.value,
                totalARecibir: parseInt(totalARecibirValue),
                cuenta: cuentaSelect.value
            };

            loteId = crypto.randomUUID();
            loteIdDisplay.textContent = loteId;
            startScreen.style.display = 'none';
            captureScreen.style.display = 'block';
            updatePhotoCounter();
            
            try {
                if (stream) stream.getTracks().forEach(track => track.stop());
                const constraints = { video: { facingMode: 'environment' } };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
            } catch (err) {
                console.error("Error al acceder a la c√°mara:", err);
                alert("No se pudo acceder a la c√°mara. Revisa los permisos.");
            }
        });

        captureButton.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            canvas.toBlob((blob) => {
                const photoId = `photo-${Date.now()}`;
                const photoFile = new File([blob], `${photoId}.jpg`, { type: 'image/jpeg' });
                addPhotoToPreview(photoFile, photoId);
                updatePhotoCounter();
            }, 'image/jpeg');
        });

        function addPhotoToPreview(file, photoId) {
            const photoContainer = document.createElement('div');
            photoContainer.className = 'photo-container';
            photoContainer.id = photoId;
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status';
            statusDiv.textContent = 'Pendiente';
            const deleteButton = document.createElement('button');
            deleteButton.className = 'delete-button';
            deleteButton.textContent = 'X';
            deleteButton.onclick = () => {
                photosInBatch = photosInBatch.filter(p => p.id !== photoId);
                photoContainer.remove();
                updatePhotoCounter();
            };
            photoContainer.appendChild(img);
            photoContainer.appendChild(statusDiv);
            photoContainer.appendChild(deleteButton);
            preview.appendChild(photoContainer);
            photosInBatch.push({ file: file, id: photoId, element: photoContainer });
        }

        saveButton.addEventListener('click', async () => {
            if (photosInBatch.length === 0) {
                alert('Captura al menos una foto para el lote.');
                return;
            }
            saveButton.disabled = true;
            captureButton.disabled = true;
            saveButton.textContent = 'Guardando...';

            try {
                // PASO A√ëADIDO: Insertar el registro maestro en 'lotes_cargados'
                const { error: loteInsertError } = await supabaseClient
                    .from('lotes_cargados')
                    .insert([{
                        lote_id: loteId,
                        fecha: new Date().toISOString(),
                        total_recibir: loteInfo.totalARecibir,
                        total_recibido: photosInBatch.length,
                        tipo: loteInfo.tipo,
                        cuenta: loteInfo.cuenta
                    }]);
                
                if (loteInsertError) throw loteInsertError;

                // PROCESO ORIGINAL (SIN CAMBIOS): Sube cada foto y la registra en 'paquetes_cargados_test'
                for (const photo of photosInBatch) {
                    const statusDiv = photo.element.querySelector('.status');
                    try {
                        statusDiv.textContent = 'Subiendo...';
                        const fileName = `${loteId}/${photo.file.name}`;
                        // Sube a Storage (como antes)
                        const { error: uploadError } = await supabaseClient.storage.from('fotos_paquetes_test').upload(fileName, photo.file);
                        if (uploadError) throw uploadError;
                        
                        // Obtiene URL (como antes)
                        const { data: urlData } = supabaseClient.storage.from('fotos_paquetes_test').getPublicUrl(fileName);
                        
                        // Inserta en la tabla de paquetes (como antes)
                        const { error: insertError } = await supabaseClient.from('paquetes_cargados_test').insert([{ foto_url: urlData.publicUrl, lote_id: loteId }]);
                        if (insertError) throw insertError;
                        
                        statusDiv.textContent = '‚úÖ Guardado';
                        statusDiv.className = 'status success';
                    } catch (error) {
                        console.error(`Error procesando ${photo.file.name}:`, error);
                        statusDiv.textContent = '‚ùå Error Foto';
                        statusDiv.className = 'status error';
                    }
                }
                saveButton.textContent = '‚úÖ Proceso Finalizado';

            } catch (error) {
                console.error('Error al guardar el registro del lote:', error);
                alert(`Error al crear el lote en la base de datos: ${error.message}`);
                saveButton.textContent = '‚ùå Error en Lote';
                saveButton.disabled = false;
                captureButton.disabled = false;
                return;
            }

            if (stream) stream.getTracks().forEach(track => track.stop());
            captureButton.style.display = 'none';
            saveButton.style.display = 'none';
            resetButton.style.display = 'inline-block';
        });
        
        resetButton.addEventListener('click', () => {
            photosInBatch = [];
            preview.innerHTML = '';
            loteId = null;
            loteInfo = {}; 
            totalInput.value = ''; 

            captureScreen.style.display = 'none';
            startScreen.style.display = 'block';

            captureButton.style.display = 'inline-block';
            saveButton.style.display = 'inline-block';
            resetButton.style.display = 'none';
            
            saveButton.disabled = false;
            captureButton.disabled = false;
            saveButton.textContent = '‚úÖ Guardar Lote';
            photoCounter.textContent = 'Fotos Capturadas: 0';
        });
    </script>
</body>
</html>
