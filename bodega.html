<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recepci√≥n de Paquetes por Lote</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
        button { font-size: 1.2em; padding: 10px 15px; cursor: pointer; }
        #captureScreen, #startScreen { text-align: center; }
        #preview { margin-top: 20px; display: flex; flex-wrap: wrap; gap: 10px; }
        .photo-container { border: 1px solid #ccc; padding: 5px; text-align: center; }
        .photo-container img { width: 150px; height: 150px; object-fit: cover; }
        .status { font-weight: bold; }
        .status.success { color: green; }
        .status.error { color: red; }
    </style>
</head>
<body>

    <div id="startScreen">
        <h1>Recepci√≥n de Paquetes</h1>
        <button id="startButton">‚ñ∂Ô∏è Iniciar Recepci√≥n</button>
    </div>

    <div id="captureScreen" style="display:none;">
        <h2>Lote de Recepci√≥n</h2>
        <p>ID del Lote: <b id="loteIdDisplay"></b></p>
        <button id="addPhotoButton">üì∏ Tomar/A√±adir Foto</button>
        <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
        <hr>
        <div id="preview"></div>
        <hr>
        <button id="saveButton" style="background-color: #28a745; color: white;">‚úÖ Guardar Lote</button>
    </div>

    <script>
        // --- CONFIGURACI√ìN DE SUPABASE ---
        const SUPABASE_URL = 'https://ztdkaxbgpogudtrdgzic.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0ZGtheGJncG9ndWR0cmRnemljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDE2MDYsImV4cCI6MjA3MDQxNzYwNn0.mpjY5nWiS48O0DAUkCL7Jl6agF6LurNGeaY8d1u70Po';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- ELEMENTOS DEL HTML ---
        const startScreen = document.getElementById('startScreen');
        const captureScreen = document.getElementById('captureScreen');
        const startButton = document.getElementById('startButton');
        const addPhotoButton = document.getElementById('addPhotoButton');
        const cameraInput = document.getElementById('cameraInput');
        const saveButton = document.getElementById('saveButton');
        const preview = document.getElementById('preview');
        const loteIdDisplay = document.getElementById('loteIdDisplay');

        // --- VARIABLES DE ESTADO ---
        let loteId = null;
        let photosInBatch = []; // Array para guardar { file, id, element }

        // --- L√ìGICA DE LA APLICACI√ìN ---

        // 1. Al hacer clic en "Iniciar Recepci√≥n"
        startButton.addEventListener('click', () => {
            loteId = crypto.randomUUID(); // Genera un ID √∫nico para el lote
            loteIdDisplay.textContent = loteId;
            startScreen.style.display = 'none';
            captureScreen.style.display = 'block';
        });

        // Simula un clic en el input de la c√°mara
        addPhotoButton.addEventListener('click', () => {
            cameraInput.click();
        });

        // 2. Cuando se selecciona una foto
        cameraInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const photoId = `photo-${Date.now()}`;
            const photoContainer = document.createElement('div');
            photoContainer.className = 'photo-container';
            photoContainer.id = photoId;

            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            
            const statusDiv = document.createElement('div');
            statusDiv.className = 'status';
            statusDiv.textContent = 'Pendiente';

            const deleteButton = document.createElement('button');
            deleteButton.textContent = '‚ùå';
            deleteButton.onclick = () => {
                // Elimina del array y de la vista
                photosInBatch = photosInBatch.filter(p => p.id !== photoId);
                photoContainer.remove();
            };

            photoContainer.appendChild(img);
            photoContainer.appendChild(statusDiv);
            photoContainer.appendChild(deleteButton);
            preview.appendChild(photoContainer);

            photosInBatch.push({ file: file, id: photoId, element: photoContainer });
            
            // Resetea el input para poder tomar la misma foto de nuevo si es necesario
            cameraInput.value = '';
        });

        // 3. Al hacer clic en "Guardar Lote"
        saveButton.addEventListener('click', async () => {
            if (photosInBatch.length === 0) {
                alert('A√±ade al menos una foto al lote.');
                return;
            }

            saveButton.disabled = true;
            saveButton.textContent = 'Guardando...';

            for (const photo of photosInBatch) {
                const statusDiv = photo.element.querySelector('.status');
                
                // --- PROCESO POR CADA FOTO ---
                try {
                    statusDiv.textContent = 'Subiendo...';
                    const fileName = `${loteId}/${photo.id}-${photo.file.name}`;

                    // A. Subir la foto al bucket
                    const { error: uploadError } = await supabase.storage
                        .from('fotos_paquetes_test')
                        .upload(fileName, photo.file);

                    if (uploadError) throw uploadError; // Lanza el error para ser capturado por el catch

                    // B. Obtener la URL p√∫blica
                    const { data: urlData } = supabase.storage
                        .from('fotos_paquetes_test')
                        .getPublicUrl(fileName);

                    // C. Crear la fila en la base de datos con el ID de Lote
                    const { error: insertError } = await supabase
                        .table('paquetes_cargados_test')
                        .insert([{ 
                            foto_url: urlData.publicUrl,
                            lote_id: loteId // Aqu√≠ guardamos el ID del lote
                        }]);

                    if (insertError) throw insertError;

                    // Si todo fue exitoso
                    statusDiv.textContent = '‚úÖ Guardado';
                    statusDiv.className = 'status success';

                } catch (error) {
                    console.error(`Error procesando ${photo.file.name}:`, error);
                    statusDiv.textContent = '‚ùå Error';
                    statusDiv.className = 'status error';
                    // Aqu√≠ podr√≠as a√±adir un bot√≥n de "Reintentar" si quisieras
                }
            }
            saveButton.textContent = '‚úÖ Proceso Finalizado';
        });

    </script>
</body>
</html>
